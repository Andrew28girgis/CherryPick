<div class="row">
  <div class="col-md-2 border-r" style="height:100vh">
    <div class="sidebar" [ngClass]="{ 'sidebar-collapse': collapse }">
      <div class="sidebar-header">
        <ng-container *ngIf="!collapse; else other_content">
          <div class="header-title">CHERRYPICK</div>
          <!-- Uncomment this block if needed -->
          <!-- <svg
            (click)="changeCollapse()"
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
          >
            <path
              d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8.009 8.009 0 0 1-8 8z"
            ></path>
            <path
              d="M13.293 7.293 8.586 12l4.707 4.707 1.414-1.414L11.414 12l3.293-3.293-1.414-1.414z"
            ></path>
          </svg> -->
        </ng-container>
        <ng-template #other_content>
          <i
            class="fa-solid fa-angle-right header-btn"
            (click)="changeCollapse()"
          ></i>
        </ng-template>
      </div>
      <ul class="sidebar-items">
        <li
          *ngFor="let item of sidebarItems"
          class="sidebar-item"
          [routerLink]="[item.route]"
          routerLinkActive="active"
        >
          <a class="item-link">
            <span class="item-title" *ngIf="!collapse">{{ item.title }}</span>
          </a>
        </li>
      </ul>
    </div>
  </div>
  
  <div class="col-md-10 p-0">

    
    <i class="fa-solid fa-magnifying-glass"></i>
    
    <div class="row d-flex my-3">
      
      <div
        *ngFor="let kanban of userKanbans"
        class="col-md-6 d-flex"
        (click)="GetKanbanDetails(kanban)"
      >
        <div *ngFor="let def of kanban.kanbanDefinitions; let i = index">
          <div class="card-header">
            <p>
              <ng-container *ngFor="let org of def?.Organization">
                <span *ngIf="i > 0" class="px-2">/</span>{{ org.Name }}
              </ng-container>
            </p>
          </div>
        </div>
        <span class="px-2">--></span
        >{{ getStackHolderName(kanban.targetStakeholderId) }}
      </div>
    </div>

    <div class="kanban-wrap">
      <div class="row d-flex" *ngIf="kanbanList">

        <div *ngFor="let stage of kanbanList[0]?.kanbanStages" class="col">
          <div class="card">
            <div class="stage-container">
              <h2
                class="stage-name"
                [ngClass]="{ 'green-text': stage.isQualified }"
              >
                {{ stage.stageName }}
              </h2>

              <button
                *ngIf="stage.stageActions"
                class="btn btn-primary"
                (click)="openActionsForStage(ViewStageActions, stage)"
              >
                Actions
              </button>
            </div>
            <div
              cdkDropList
              [id]="stage.Id.toString()"
              [cdkDropListData]="stage.kanbanOrganizations"
              [cdkDropListConnectedTo]="getConnectedLists(stage.Id.toString())"
              class="card-body example-list"
              (cdkDropListDropped)="drop($event)"
            >
              <ng-container *ngFor="let org of stage.kanbanOrganizations">
                <div
                  *ngIf="org.Organization?.[0]?.Name "
                  class="kanban-org"
                  cdkDrag
                >
                  {{ org.Organization?.[0]?.Name }}

                  <button
                    *ngIf="
                      stage.stageActions &&
                      stage.stageActions[0]?.actionLevel == 'Target'
                    "
                    class="btn btn-primary"
                    (click)="
                      openActionsForTarget(
                        ViewTargetActions,
                        stage.stageActions,
                        org
                      )
                    "
                  >
                    Actions
                  </button>

                  <!-- <ng-container *ngFor="let action of stage.stageActions">
                  (   {{action.actionName}} )

                  </ng-container> -->
                  <button
                    class="btn btn-success"
                    *ngIf="stage.isQualified"
                    (click)="openCreateNewKanban(chooseStackHolder, org)"
                  >
                    +
                  </button>
                </div>
              </ng-container>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<ng-template #chooseStackHolder let-modal>
  <div class="p-2">
    <ng-container *ngIf="selectedKanban?.targetStakeholderId !== 4">
      <p>
        <b>
          {{ General.modalObject.Organization[0]?.Name }} has qualified this
          kanban
        </b>
      </p>
    </ng-container>
  </div>

  <div class="row">
    <div class="bg-light rounded col-md-6 p-2">
      <h5>Start a new kanban for</h5>
      <ng-container *ngFor="let item of selectedKanban?.kanbanDefinitions">
        <ng-container *ngFor="let org of item.Organization">
          <ng-container *ngIf="org.Name"> {{ org.Name }} </ng-container>
          <ng-container *ngIf="org.Contacts?.[0]?.Firstname">
            {{ org.Contacts[0].Firstname }}
          </ng-container>
        </ng-container> </ng-container
      >& {{ General.modalObject.Organization[0]?.Name }}

      <ng-container *ngFor="let temp of kanbanTemplate">
        <p>{{ temp.kanbanTemplateName }}</p>
      </ng-container>
      <div class="d-flex justify-content-center mt-4">
        <button
          class="btn btn-success px-4"
          (click)="modal.close(); onCreateClick()"
        >
          Create
        </button>
      </div>
    </div>
    <div class="bg-light rounded col-md-6 p-2">
      <div>
        <h5>Route To kanban</h5>

        <div class="search-container">
          <div class="mb-3">
            <label for=""><b>Search Broker</b></label>
            <input
              type="text"
              [(ngModel)]="keyword"
              (ngModelChange)="onSearchInput()"
              class="form-control"
              placeholder="Search names..."
              aria-label="Search names"
            />
          </div>

          <!-- Display Filtered Results -->
          <ul
            *ngIf="filteredNames.length > 0"
            class="list-group"
            style="max-height: 350px; overflow-y: auto"
          >
            <li
              *ngFor="let name of filteredNames"
              class="list-group-item broker-name"
              (click)="onNameClick(name)"
            >
              {{ name.firstname }} {{ name.lastname }}
              <span>
                <b>( {{ name.name }} )</b>
              </span>
            </li>
          </ul>
        </div>

        <div>
          <label for=""><b>Select Organization</b></label>
          <select
            class="form-control w-50"
            (change)="getOrganizationContacts($event)"
          >
            <option *ngFor="let org of allOrganizations" [value]="org.id">
              {{ org.name }}
            </option>
          </select>
        </div>

        <div
          class="py-2"
          *ngIf="organizationContact && organizationContact.length > 0"
        >
          <label for=""><b>Select Contact</b></label>
          <select
            class="form-control w-50"
            (change)="getContactKanbans($event)"
          >
            <option value="" selected>All</option>
            <option
              *ngFor="let contact of organizationContact"
              [value]="contact.id"
            >
              {{ contact.firstname }} {{ contact.lastname }}
            </option>
          </select>
        </div>

        <div class="py-2" *ngIf="orgKanbans && orgKanbans.length > 0">
          <label for=""><b>Select Kanban</b></label>
          <select class="form-control w-50" [(ngModel)]="selectedTargetKanban">
            <option value="" selected>All</option>
            <option *ngFor="let kanaban of orgKanbans" [value]="kanaban.Id">
              {{ kanaban.kanbanName }}
            </option>
          </select>
        </div>

        <button
          class="btn btn-success"
          *ngIf="orgKanbans && orgKanbans.length > 0"
          (click)="CreateKanbanOrganization()"
        >
          Create
        </button>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #ViewStageActions let-modal>
  <div class="p-3">
    <ng-container *ngFor="let action of TargetActions">
      <ng-container *ngIf="action.actionLevel == 'Stage'">
        <a
          style="cursor: pointer"
          *ngIf="action.actionType == 'Popup'"
          (click)="openModel(addOrganization)"
          target="_blank"
        >
          {{ action.actionName }}
        </a>
      </ng-container>
    </ng-container>
  </div>
</ng-template>

<ng-template #ViewTargetActions let-modal>
  <div class="p-3">
    <ng-container *ngFor="let action of TargetActions">
      <ng-container *ngIf="action.actionLevel == 'Target'">
        <a
          *ngIf="action.actionType == 'Link'"
          href="{{ action.actionURL + TargetOrg.Id }}"
          target="_blank"
        >
          {{ action.actionName }}
        </a>
      </ng-container>
    </ng-container>
  </div>
</ng-template>

<ng-template #addOrganization let-modal>
  <div class="p-3" style="height: 500px; overflow-y: scroll">
    <div class="p-2">
      <label for="">Create Organization</label>
      <input type="text" placeholder="Organization name" #newOrgInput />
      <button
        class="btn btn-success px-2"
        (click)="CreateOrganication(newOrgInput.value, currentOpenedStage.Id)"
      >
        Create
      </button>
    </div>
    <div class="p-2">
      <label for="">Search Organization</label>
      <input type="text" placeholder="Organization name" #orgInput />
      <button
        class="btn btn-success px-2"
        (click)="SearchOrganication(orgInput.value)"
      >
        Search
      </button>
    </div>

    <ng-container *ngIf="Organizations && Organizations.length > 0">
      <ng-container *ngFor="let org of Organizations">
        {{ org.name }}
        <button
          class="btn btn-success px-2"
          (click)="AddExistingOrganication(currentOpenedStage.Id, org.id)"
        >
          Add
        </button>
      </ng-container>
    </ng-container>
  </div>
</ng-template>
