<ngx-spinner type="ball-scale-multiple"></ngx-spinner>
<div class="row m-0 p-0 mb-5">

  <div class="col-12 p-0 m-0">
    <div class="row m-0" style="flex-wrap: nowrap; overflow-x: scroll; min-height: 70vh;">
      <div 
        class="col-12 col-sm-6 col-md-4 col-lg-2 mb-3 custom-width" 
        style="float: none; display: inline-block;" 
        *ngFor="let stage of Stages;"
      >
        <div class="card">
          <div class="card-header"
          [ngStyle]="{
            'color': stage.title === 'No Reply' ? '#FF4C4C' : 
                     stage.title === 'Removed' ? '#FF4C4C' : 
                     stage.title === 'New' ? '#707791' : 
                     stage.title === 'Waiting For Reply' ? '#CC9A06' : 
                     stage.title === 'Outbox' ? '#28A745' : 
                     stage.title === 'No' ? '#007BFF' : 
                     stage.title === 'yes' ? '#007BFF' : 
                     stage.title === 'Replied' ? '#28A745' : '',

            'background-color': stage.title === 'No Reply' ? '#FFEDED' : 
                                stage.title === 'Removed' ? '#FFEDED' : 
                                stage.title === 'New' ? '#F1F1F4' : 
                                stage.title === 'Waiting For Reply' ? '#FFF9E6' : 
                                stage.title === 'Outbox' ? '#EAF6EC' : 
                                stage.title === 'No' ? '#CCE5FF' : 
                                stage.title === 'yes' ? '#CCE5FF' : 
                                stage.title === 'Replied' ? '#EAF6EC' : ''
          }"
          >
            {{ stage.title }}
          </div>
          <div class="card-body">
            <div *ngFor="let email of stageEmailsMap[stage.id];">
              <div *ngFor="let org of email.Organization;" class="organization-card">
                <!-- Organization Header with Click Event -->
                <div 
                  class="organization-header" 
                  (click)="toggleContacts(org)"
                  style="cursor: pointer; display: flex;"
                >
                  <div class="left col-2">
                    <img 
                      [src]="'https://api.cherrypick.com/api/Organization/GetOrgImag?orgId=' + org.OrganizationId"
                      width="30" 
                      height="30" 
                      style="border-radius: 50%;"
                    >
                  </div>
                  <div class="right col-10 ms-2 d-flex justify-content-between">
                    <span class="org-name">{{ org.OrganizationName }}</span>
                    <div class="d-flex align-items-center">
                      <span 
                        class="total-emails"
                        *ngIf="getTotalOrganizationEmails(org.Contact) > 0"
                      >
                        {{ getTotalOrganizationEmails(org.Contact) }}
                      </span>
                    </div>
                  </div>
                </div>
          
                <div *ngIf="org.showContacts" class="contacts-list">
                  <ul class="contact-ul" style="padding: 5px;">
                    <!-- Limit the number of contacts initially based on 'showMoreContacts' -->
                    <li 
                      *ngFor="let contact of getVisibleContacts(org)" 
                      (click)="onContactClick(contact.ContactId, org.OrganizationId)" 
                      class="d-flex justify-content-between"
                    >
                      <div style="cursor: pointer; display: flex; justify-content: space-between; width: 100%;">
                        <span class="namecontact">
                          {{ contact.Firstname }} {{ contact.Lastname }}
                        </span>
                        <span 
                          class="namecontact ms-2" 
                          style="color: #4D65B4;" 
                          *ngIf="getTotalEmails(contact) > 0"
                        >
                          {{ getTotalEmails(contact) }}
                        </span>
                      </div>
                    </li>
          
                    <!-- View More / View Less Button -->
                    <li *ngIf="org.Contact.length > 2">
                      <div class="d-flex justify-content-center mt-2">
                        <span 
                          (click)="toggleViewMore(org)" 
                          class="view-more-less-toggle" 
                        >
                          {{ org.showMoreContacts ? 'View Less' : 'View More' }}
                          <i class="fa" [ngClass]="org.showMoreContacts ? 'fa-chevron-up' : 'fa-chevron-down'" style="font-size: 14px;"></i>
                        </span>
                      </div>
                    </li>
                  </ul>
          
                  <p *ngIf="!org.Contact || org.Contact.length === 0" class="no-contact-msg">
                    No contacts available in this organization.
                  </p>
                </div>
              </div>
            </div>
          </div>
          
        </div>
      </div>
    </div>
  </div>

</div>
