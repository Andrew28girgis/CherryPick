<ngx-spinner type="ball-scale-multiple"></ngx-spinner>

<!-- 
  Row wrapper for everything 
  (stages in multiple columns at the top, Email Dashboard below).
-->
<div class="row m-0 p-0 mb-5">

  <div class="col-12 p-0 m-0">
    <div class="row" style="flex-wrap: nowrap; overflow-x: scroll; min-height: 70vh;">
      <div 
        class="col-12 col-sm-6 col-md-4 col-lg-2 mb-3" 
        style="float: none; display: inline-block;" 
        *ngFor="let stage of Stages;"
      >
        <div class="card">
          <div class="card-header"
          [ngStyle]="{
            'background-color': stage.title === 'No Reply' ? '#FFEDED' : 
                                stage.title === 'New' ? '#F1F1F4' : 
                                stage.title === 'Waiting For Reply' ? '#FFF9E6' : 
                                stage.title === 'Outbox' ? '#CCE5FF' : 
                                stage.title === 'No' ? '#CCE5FF' : 
                                stage.title === 'yes' ? '#CCE5FF' : 
                                stage.title === 'Replied' ? '#EAF6EC' : ''
          }"
          >
            {{ stage.title }}
          </div>
          <div class="card-body">
            <div *ngFor="let email of stageEmailsMap[stage.id];">
              <div *ngFor="let org of email.Organization;" class="organization-card">
                <!-- Organization Header with Click Event -->
                <div 
                  class="organization-header" 
                  (click)="toggleContacts(org)"
                  style="cursor: pointer; display: flex;"
                >
                <div class="left">
                  <img 
                    [src]="'https://api.cherrypick.com/api/Organization/GetOrgImag?orgId=' + org.OrganizationId"
                    width="30" 
                    height="30" 
                    style="border-radius: 50%;"
                  >
                </div>
                  <div class="right ms-2">
                      <span class="org-name">{{ org.OrganizationName }}</span>
                      <!-- <span 
                        class="mx-2" 
                        [routerLink]="['/emily', buyBoxId, org.OrganizationId, email.id]"
                      >
                        <i 
                          style="font-size: 16px; color: #001f3f" 
                          class="fa-solid fa-pen-to-square"
                        ></i>
                      </span> -->
                  </div>
                </div>
  
                <!-- Contacts List (Conditionally Rendered) -->
                <div *ngIf="org.showContacts" class="contacts-list">
                  <ul class="contact-ul">
                    <li 
                      *ngFor="let contact of org.Contact;" 
                      (click)="onContactClick(contact.ContactId, org.OrganizationId)" 
                      class="d-flex justify-content-between"
                    >
                    <div style="cursor: pointer;">
                      <span class="namecontact">
                        {{ contact.Firstname }} {{ contact.Lastname }}
                      </span>
                      
                        <span 
                          class="namecontact ms-2"  style="color: #ce0000;"
                          *ngIf="getTotalEmails(contact) > 0"
                        >
                          {{ getTotalEmails(contact) }}
                        </span>
                      </div>
                    </li>
                  </ul>
                  <p 
                    *ngIf="!org.Contact || org.Contact.length === 0" 
                    class="no-contact-msg"
                  >
                    No contacts available in this organization.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  


  <!-- <div class="col-12">
    @if(!ShowSection) {
      <div *ngFor="let items of EmailDashboard; let i = index" [ngClass]="{'mt-3': i !== 0}">
        <div class="card p-0" *ngIf="items.Organizations">
          <p-table [columns]="cols" [value]="items.Organizations">
            <ng-template pTemplate="caption">
              <div class="flex items-center justify-between">
                <span class="text-xl font-bold">{{ items.Title }}</span>
              </div>
            </ng-template>

            <ng-template pTemplate="header">
              <tr>
                <th *ngFor="let col of cols" class="col-header">
                  {{ col.header }}
                </th>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-rowData>
              <tr>
                <td class="col-body d-flex justify-content-between">
                  <div style="width: 30px; height: 30px; margin-inline: 5px;">
                    <img 
                      src="https://api.cherrypick.com/api/Organization/GetOrgImag?orgId={{ rowData.ID }}"
                      width="30" height="30" style="border-radius: 50%;">
                  </div>
                  <span (click)="Openaccordion(items.Id, rowData.ID)">
                    {{ rowData.Name }}
                  </span>
                  <span class="buttonSave2" 
                        [routerLink]="['/emily', buyBoxId, rowData.ID, rowData.MicroDealId]">
                    <i class="fa-solid fa-pen-to-square"></i>
                  </span>
                </td>
                <td class="col-body">
                  {{ (rowData.LastActivityDate | date : "medium")}}
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>
    } @else {
      <div class="row m-0 p-0">
        <div class="d-flex justify-content-between align-items-center selectedContactdiv col-12">
          <p *ngIf="selectedContact" class="selectedContact">
            {{ selectedContact.Firstname }} {{ selectedContact.Lastname }}
          </p>
          <div *ngIf="selectedContact" class="filterEmails">
            <span (click)="checkAndFilterEmails('all')" 
                  [ngClass]="{'active': selectedFilter === 'all'}">
              All
            </span>
            <span (click)="checkAndFilterEmails('sent')" 
                  [ngClass]="{'active': selectedFilter === 'sent'}">
              {{ selectedContact.EmailStats[0].Sent }} Sent
            </span>
            <span (click)="checkAndFilterEmails('inbox')" 
                  [ngClass]="{'active': selectedFilter === 'inbox'}">
              {{ selectedContact.EmailStats[0].Inbox }} Inbox
            </span>
            <span (click)="checkAndFilterEmails('outbox')" 
                  [ngClass]="{'active': selectedFilter === 'outbox'}">
              {{ selectedContact.EmailStats[0].Outbox }} Outbox
            </span>
            <span (click)="ShowSection = false">Over View</span>
          </div>
        </div>

        <div class="col-12 col-sm-12 p-2 card-pTemplate" 
             *ngFor="let email of emailsSentContact"
             (click)="GetMail(email.id)">
          <p-card>
            <ng-template pTemplate="header">
              <div class="custom-header">
                <span class="Direction-class">
                  {{ getDirection(email.Direction) }}
                </span>
                <span class="date-text">
                  {{ email.Date | date: 'yyyy-MM-dd HH:mm' }}
                </span>
              </div>
            </ng-template>

            <p class="m-0">
              <strong>Subject:</strong> {{ email.Subject }}
            </p>
          </p-card>
        </div>

        <div class="modal-content" *ngIf="selectedEmail">
          <div class="modal-body p-0 openreply">
            <div class="row m-0 p-0 d-flex justify-content-center">
              <div class="col-12 p-0">
                <div class="card shadow-sm border-0">
                  <div class="card-body bg-light">
                    <div>
                      <div class="d-flex justify-content-between align-items-center">
                        <label class="fw-bold text-secondary">Body</label>
                      </div>
                      <div class="p-3 border rounded bg-white text-dark">
                        <div class="col-5 p-0 m-0" [innerHTML]="selectedEmail.Body"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer mt-2">
            <button class="btn buttonSave me-2"
                    (click)="openmodel(openreply, selectedEmail.Body, selectedContact?.ContactId)"
                    *ngIf="selectedEmail.Direction === 1">
              Reply
            </button>
            <button class="btn btn-secondary" (click)="close()">
              Close
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="emailsSentContact.length === 0" 
           class="d-flex justify-content-start Empty-data">
        {{ emptyMessage }}
      </div>
    }
  </div> -->
</div>



<ng-template #Viewemail let-modal>
  <div class="modal-content">
    <div class="modal-body p-0">
      <div class="row m-0 p-0 d-flex justify-content-center">
        <div class="col-12 p-0">
          <div class="card shadow-sm border-0">
            <div class="card-header text-white GeneratedEmail">
              <h5 class="mb-0 d-flex justify-content-between">
                <p>
                  <span class="firstemail">
                    {{ getDirection(Emails[0].Direction) }}
                  </span>
                </p>
                <p>
                  <span class="creationdate">
                    {{ Emails[0].Date | date: 'yyyy-MM-dd HH:mm' }}</span>
                </p>
              </h5>
            </div>
            <div class="card-body bg-light">
              <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center">
                  <label class="fw-bold text-secondary">Subject</label>
                </div>
                <div class="p-3 border rounded bg-white text-dark">
                  <div class="col-5 p-0 m-0">{{ Emails[0].Subject }}</div>
                </div>
              </div>
              <div>
                <div class="d-flex justify-content-between align-items-center">
                  <label class="fw-bold text-secondary">Body</label>
                </div>
                <div class="p-3 border rounded bg-white text-dark">
                  <div class="col-5 p-0 m-0" [innerHTML]="Emails[0].Body"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="modal.dismiss('Close click')">
        Close
      </button>
    </div>
  </div>
</ng-template>

<ng-template #openreply let-modal>
  <div class="modal-content">
    <div class="modal-body p-0">
      <div class="row m-0 p-2 d-flex justify-content-center">
        <div class="d-flex gap-3 selectedOptionDiv">
          <app-emily [buyBoxIdReply]="buyBoxId" [orgIdReply]="openedOrgId" [emailBodyReply]="bodyemail"
            [selectedContactContactId]="contactIdemail" [modal]="modal"> </app-emily>
        </div>
        <div class="col-12 p-0">
          <!-- <form [formGroup]="formGroup">
              <div class="p-3">
                <div class="d-flex pb-3 align-items-center">
                  <label for="subject"class="IsCC_checkbox me-2">Subject: </label>
                  <input type="text" class="input_checkbox form-control w-25" formControlName="subject" name="subject" id="subject" placeholder="Enter your subject email">
                </div>
                <div class="checkbox-section">
                  <input type="checkbox"  formControlName="IsCC" name="IsCC" id="IsCC" class="form-check-input m-0"/>
                  <label for="IsCC" class="ms-2 IsCC_checkbox" >IsCC</label>
                </div>
              </div>
              {{ email }}
              <p-editor [(ngModel)]="email" [style]="{ height: '250px' }"></p-editor>
              <div class="d-flex justify-content-end">
                <button type="button" (click)="Send()" class="mt-2 mb-4 me-2 buttonSave">Send</button>
                <button class="btn btn-secondary mt-2 mb-4 me-2" (click)="modal.dismiss('Close click')">
                  Close
                </button>
              </div>
            </form> -->

        </div>
      </div>
    </div>
  </div>
</ng-template>
