<div class="floating-chat-wrapper" #chatWrapper>
  <section class="notifications-overlay">
    <div class="floating-header">
      <div class="header-content">
        <img
          class=""
          width="20"
          height="20"
          src="../../../../assets/Images/bot.png"
          alt="Emily"
        />
        <h3 class="floating-title">Emily</h3>
      </div>

      <div class="d-flex align-items-center justify-content-center gap-2">
        <button
          class="g-button clear-button"
          (click)="clearEmilyChat()"
          aria-label="Close"
        >
          Clear
        </button>
        <button class="close-button" (click)="closeAll()" aria-label="Close">
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
    </div>

    <div
      class="chat-messages-container"
      #messagesContainer
      (scroll)="onScroll()"
    >
      <div
        class="scroll-down-button"
        *ngIf="showScrollButton"
        (click)="scrollToBottom()"
      >
        <div class="scroll-icon">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </div>
        <div class="new-message-count" *ngIf="newNotificationsCount > 0">
          {{ newNotificationsCount }}
        </div>
      </div>

      <div
        *ngIf="chatTimeline.length > 0; else noMessages"
        class="chat-messages"
      >
        <div
          class="message-bubble"
          *ngFor="
            let item of chatTimeline;
            trackBy: trackByChatItem;
            let i = index
          "
          [class.user]="item.from === 'user'"
          [class.system]="item.from === 'system'"
          [class.ai]="item.from === 'ai'"
          [class.clickable]="item.notification?.userSubmissionId"
          [attr.id]="
            item.notification?.id
              ? 'msg-' + item.notification?.id
              : 'msg-' + item.key
          "
        >
          <div class="message-content">
            <p
              class="message-text"
              *ngIf="
                isAutomationLoading(item, i) &&
                  item.message.includes(
                    'searching the web now for your request'
                  );
                else staticAutomation
              "
            >
              I am searching the web now for your request.

              <span class="search-loading-icon" aria-hidden="true">
                <i class="fa fa-search"></i>
              </span>
            </p>
            <p
              class="message-text"
              *ngIf="
                isAutomationLoading(item, i) &&
                  item.message.includes(
                    'start scanning and analyzing the current page'
                  );
                else staticScannning
              "
            >
              I will start scanning and analyzing the current page for you
              <span class="stat-bars" aria-hidden="true">
                <span></span><span></span><span></span><span></span><span></span
                ><span></span>
              </span>
            </p>

            <p
              class="message-text"
              *ngIf="isCompilingReport(item, i); else staticCompiling"
            >
              Got some results, Compiling them into a nice report.
              <span class="professional-loading-icon" aria-hidden="true">
                <i class="fa-regular fa-file"></i>
              </span>
            </p>
            <p
              class="message-text"
              *ngIf="
                isScanningPageContents(item, i);
                else staticScanPageContents
              "
            >
              I am scanning the page contents now, please wait ...

              <span class="search-loading-icon" aria-hidden="true">
                <i class="fa fa-search"></i>
              </span>
            </p>

            <ng-template #staticScanPageContents>
              <p
                class="message-text"
                *ngIf="
                  item.message.includes('I am scanning the page contents now')
                "
              >
                I am scanning the page contents now, please wait ...
              </p>
            </ng-template>

            <ng-template #staticCompiling>
              <p
                *ngIf="
                  item.message.includes('Compiling them into a nice report')
                "
                class="message-text"
              >
                Got some results, Compiling them into a nice report.
              </p>
            </ng-template>

            <ng-template #staticAutomation>
              <p
                class="message-text"
                *ngIf="
                  item.message.includes(
                    'I am searching the web now for your request'
                  )
                "
              >
                I am searching the web now for your request
              </p>
            </ng-template>
            <ng-template #staticScannning>
              <p
                class="message-text"
                *ngIf="
                  item.message.includes(
                    'I will start scanning and analyzing the current page for you'
                  )
                "
              >
                I will start scanning and analyzing the current page for you
              </p>
            </ng-template>

            <p
              class="message-text"
              *ngIf="
                item.from === 'ai' &&
                item.notification?.html &&
                !item.message.includes(
                  'I am searching the web now for your request'
                ) &&
                !item.message.includes('Compiling them into a nice report') &&
                !item.message.includes('scanning and analyzing the current') &&
                !item.message.includes('I am scanning the page contents now')
              "
            >
              Search Result
            </p>

            <p
              class="message-text"
              *ngIf="
                item.from !== 'ai' &&
                !item.message.includes(
                  'I am searching the web now for your request'
                ) &&
                !item.message.includes('Compiling them into a nice report') &&
                !item.message.includes('scanning and analyzing the current ') &&
                !item.message.includes('I am scanning the page contents now')
              "
            >
              {{ item.message }}
            </p>

            <div class="choose">
              <div>
                <button
                  *ngIf="item.notification?.html"
                  class="view-details"
                  (click)="
                    openOverlayModal(item.notification!);
                    loadNotificationViewComponent(item.notification!)
                  "
                >
                  View
                </button>
              </div>

              <time
                class="message-time"
                [dateTime]="item.created.toISOString()"
              >
                {{ item.created | date : "shortTime" }}
              </time>
            </div>
          </div>
        </div>
      </div>
      <div *ngIf="isTyping" class="message-row system">
        <div class="message-bubble typing">
          <span class="dot"></span>
          <span class="dot"></span>
          <span class="dot"></span>
        </div>
      </div>

      <ng-template #noMessages>
        <div class="no-messages">
          <p>No messages yet.</p>
          <p class="no-messages-subtext">
            Start chatting with Emily for updates and assistance.
          </p>
        </div>
      </ng-template>
    </div>

    <div class="composer">
      <div class="input-container">
        <div
          class="composer-input"
          contenteditable="true"
          #messageInput
          (input)="onInputChange($event)"
          (keydown)="onKeyDown($event)"
          [attr.data-placeholder]="outgoingText ? null : 'Type a messageâ€¦'"
          [class.has-text]="outgoingText"
        ></div>
      </div>

      <button class="composer-send-btn" (click)="sendMessage()">
        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
          <path
            d="M22 2L11 13"
            stroke="currentColor"
            stroke-width="2"
            fill="none"
          />
          <path
            d="M22 2L15 22L11 13L2 9L22 2Z"
            stroke="currentColor"
            stroke-width="2"
            fill="none"
          />
        </svg>
      </button>
    </div>
  </section>

  <div
    class="chat-details-panel"
    *ngIf="overlayOpen"
    [ngStyle]="{
      top: overlayTop + 'px',
      left: overlayLeft + 'px',
      width: overlayWidth + 'px',
      height: overlayHeight + 'px'
    }"
  >
    <!-- HEADER -->
    <div
      class="chat-details-header d-flex justify-content-between align-items-center flex-wrap gap-2"
    >
      <h4 class="mb-0">Details</h4>

      <div class="d-flex align-items-center gap-2">
        <input
          type="text"
          placeholder="Enter Title"
          class="form-control form-control-sm"
          [(ngModel)]="pdfTitle"
          (input)="updateSaveButtons()"
          style="width: 180px"
        />

        <button
          class="btn btn-sm title-btn"
          [disabled]="!canSaveTitle"
          (click)="saveTitleInOverlay()"
        >
          Save Title
        </button>
        <button class="btn btn-sm save-pdf-btn" (click)="savePdfInOverlay()">
          ðŸ“„ Save PDF
        </button>
        <button
          class="chat-details-close btn btn-sm btn-light border"
          (click)="closeOverlay()"
        >
          Ã—
        </button>
      </div>
    </div>

    <!-- BODY -->
    <div class="chat-details-body" #detailsBody>
      <div [innerHTML]="safeHtmlString"></div>
    </div>

    <!-- BOTTOM SAVE BUTTON -->
    <div class="save-div" *ngIf="showBottomSave">
      <button class="btn save-btn" (click)="saveNotificationInOverlay()">
        Save
      </button>
    </div>
  </div>
</div>

<ng-template #savingTpl>
  <span class="btn-spinner"></span>
  <span>Savingâ€¦</span>
</ng-template>
<div class="save-toast" *ngIf="showSaveToast">Saved successfully</div>
