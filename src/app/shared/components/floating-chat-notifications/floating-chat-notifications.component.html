<div class="floating-chat-wrapper">
  <section class="notifications-overlay">
    <div class="floating-header">
      <div class="header-content">
        <img
          class=""
          width="20"
          height="20"
          src="../../../../assets/Images/bot.png"
          alt="Emily"
        />
        <h3 class="floating-title">Emily</h3>
      </div>

      <div style="display: flex; gap: 6px; align-items: center">
        <button
          class="g-button"
          [ngClass]="{ 'close-route': isChatbotRoute }"
          style="height: 10px"
          (click)="clearEmilyChat()"
          aria-label="Close"
        >
          Clear
        </button>
      </div>
    </div>

    <div
      class="chat-messages-container"
      #messagesContainer
      (scroll)="onScroll()"
    >
      <div
        class="scroll-down-button"
        *ngIf="showScrollButton && isOpen"
        (click)="scrollToBottom()"
      >
        <div class="scroll-icon">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </div>
        <div class="new-message-count" *ngIf="newNotificationsCount > 0">
          {{ newNotificationsCount }}
        </div>
      </div>

      <div
        *ngIf="chatTimeline.length > 0; else noMessages"
        class="chat-messages"
      >
        <div
          class="message-bubble"
          *ngFor="
            let item of chatTimeline;
            trackBy: trackByChatItem;
            let i = index
          "
          [class.user]="item.from === 'user'"
          [class.system]="item.from === 'system'"
          [class.ai]="item.from === 'ai'"
          [class.clickable]="item.notification?.userSubmissionId"
          [attr.id]="
            item.notification?.id
              ? 'msg-' + item.notification?.id
              : 'msg-' + item.key
          "
        >
          <div
            *ngIf="
              item.from === 'system' && isNotificationLoading(item.notification)
            "
            class="spinner-container full-message"
          >
            <div class="spinner-overlay"></div>
            <div class="spinner-central"></div>
          </div>

          <div class="message-content">
            <p
              class="message-text"
              *ngIf="
                isAutomationLoading(item, i) &&
                  item.message.includes(
                    'searching the web now for your request'
                  );
                else staticAutomation
              "
            >
              I am searching the web now for your request.

              <span class="search-loading-icon" aria-hidden="true">
                <i class="fa fa-search"></i>
              </span>
            </p>
            <p
              class="message-text"
              *ngIf="
                isAutomationLoading(item, i) &&
                  item.message.includes(
                    'start scanning and analyzing the current page'
                  );
                else staticScannning
              "
            >
              I will start scanning and analyzing the current page for you
              <span class="stat-bars" aria-hidden="true">
                <span></span><span></span><span></span><span></span><span></span
                ><span></span>
              </span>
            </p>

            <p
              class="message-text"
              *ngIf="isCompilingReport(item, i); else staticCompiling"
            >
              Got some results, Compiling them into a nice report.
              <span class="professional-loading-icon" aria-hidden="true">
                <i class="fa-regular fa-file" style="color: #baa26c"></i>
              </span>
            </p>

            <ng-template #staticCompiling>
              <p
                *ngIf="
                  item.message.includes('Compiling them into a nice report')
                "
                class="message-text"
              >
                Got some results, Compiling them into a nice report.
              </p>
            </ng-template>

            <ng-template #staticAutomation>
              <p
                class="message-text"
                *ngIf="
                  item.message.includes(
                    'I am searching the web now for your request'
                  )
                "
              >
                I am searching the web now for your request
              </p>
            </ng-template>
            <ng-template #staticScannning>
              <p
                class="message-text"
                *ngIf="
                  item.message.includes(
                    'I will start scanning and analyzing the current page for you'
                  )
                "
              >
                I will start scanning and analyzing the current page for you
              </p>
            </ng-template>

            <p
              class="message-text"
              *ngIf="
                item.from === 'ai' &&
                item.notification?.html &&
                !item.message.includes(
                  'I am searching the web now for your request'
                ) &&
                !item.message.includes('Compiling them into a nice report') &&
                !item.message.includes('scanning and analyzing the current ')
              "
            >
              Search Result
            </p>
            <div
              *ngIf="
                item.from === 'ai' &&
                !item.notification?.html &&
                !item.message.includes(
                  'I am searching the web now for your request'
                ) &&
                !item.message.includes('Compiling them into a nice report') &&
                !item.message.includes('scanning and analyzing the current ')
              "
            >
              <p class="message-text">Not Found Results</p>
              <button
                class="choose emily-btn"
                (click)="showprompt(item.notification?.contextExtendPrompt)"
              >
                Try Again
              </button>
            </div>

            <div></div>

            <p
              class="message-text"
              *ngIf="
                item.from !== 'ai' &&
                !item.message.includes(
                  'I am searching the web now for your request'
                ) &&
                !item.message.includes('Compiling them into a nice report') &&
                !item.message.includes('scanning and analyzing the current ')
              "
            >
              {{ item.message }}
            </p>

            <div class="message-actions">
              <button
                *ngIf="
                  item.from === 'system' &&
                  item.message.toLowerCase().includes('show map')
                "
                class="icon-btn"
                style="
                  width: fit-content;
                  padding: 4px !important;
                  border-radius: 10px;
                "
                (click)="openPolygonOverlay(item.notification!)"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                >
                  <path
                    d="M20.3799 21.13C20.1799 21.13 19.9899 21.05 19.8499 20.91L13.4699 14.53C13.1799 14.24 13.1799 13.76 13.4699 13.47L21.2 5.74001C21.39 5.55001 21.6799 5.48001 21.9399 5.55001C22.1999 5.63001 22.3999 5.84001 22.4599 6.10001C22.6499 6.95001 22.7499 7.90001 22.7499 9.00001V15C22.7499 17.77 22.1699 19.64 20.9099 20.91C20.7699 21.05 20.5599 21.08 20.3799 21.13ZM15.0599 14L20.3199 19.26C20.9499 18.29 21.2499 16.91 21.2499 15V9.00001C21.2499 8.59001 21.2399 8.21001 21.2099 7.85001L15.0599 14Z"
                    fill="#fff"
                  />
                  <path
                    d="M6.26999 22.48C6.20999 22.48 6.16001 22.47 6.10001 22.46C2.79001 21.7 1.25 19.33 1.25 15V9C1.25 3.57 3.57 1.25 9 1.25H15C19.33 1.25 21.7 2.79001 22.46 6.10001C22.52 6.35001 22.44 6.62 22.26 6.8L6.79999 22.26C6.65999 22.4 6.46999 22.48 6.26999 22.48ZM9 2.75C4.39 2.75 2.75 4.39 2.75 9V15C2.75 18.47 3.71001 20.21 6.04001 20.9L20.89 6.05C20.21 3.72 18.46 2.75999 14.99 2.75999H9V2.75Z"
                    fill="#fff"
                  />
                  <path
                    d="M14.9999 22.7499H8.99989C7.89989 22.7499 6.95989 22.6599 6.09989 22.4599C5.82989 22.3999 5.61987 22.1999 5.54987 21.9399C5.46987 21.6799 5.54988 21.3999 5.73988 21.1999L13.4699 13.4699C13.7599 13.1799 14.2399 13.1799 14.5299 13.4699L20.9099 19.8499C21.0499 19.9899 21.1299 20.1799 21.1299 20.3799C21.1299 20.5799 21.0499 20.7699 20.9099 20.9099C19.6399 22.1699 17.7699 22.7499 14.9999 22.7499ZM7.84989 21.2099C8.20989 21.2399 8.58989 21.2499 8.99989 21.2499H14.9999C16.9199 21.2499 18.2899 20.9499 19.2599 20.3199L13.9999 15.0599L7.84989 21.2099Z"
                    fill="#fff"
                  />
                  <path
                    d="M9.11994 13.31C8.48994 13.31 7.85993 13.08 7.35993 12.61C5.76993 11.1 5.12996 9.44005 5.50996 7.82005C5.88996 6.16005 7.33994 5.04004 9.11994 5.04004C10.8999 5.04004 12.35 6.16005 12.73 7.82005C13.1 9.45005 12.4599 11.1 10.8699 12.61C10.3799 13.07 9.74994 13.31 9.11994 13.31ZM6.96995 8.15004C6.64995 9.51004 7.56994 10.7301 8.39994 11.5201C8.80994 11.91 9.43994 11.91 9.83994 11.5201C10.6599 10.7401 11.5799 9.52004 11.2699 8.15004C10.9999 6.96004 9.93994 6.53004 9.11994 6.53004C8.29994 6.53004 7.24995 6.96004 6.96995 8.15004Z"
                    fill="#fff"
                  />
                  <path
                    d="M9.1499 9.49023C8.5999 9.49023 8.1499 9.04023 8.1499 8.49023C8.1499 7.94023 8.5899 7.49023 9.1499 7.49023H9.15991C9.70991 7.49023 10.1599 7.94023 10.1599 8.49023C10.1599 9.04023 9.6999 9.49023 9.1499 9.49023Z"
                    fill="#fff"
                  />
                </svg>
              </button>
            </div>
            <div class="choose">
              <div>

              <button
                *ngIf="item.notification?.html"
                class="view-details"
                (click)="loadNotificationViewComponent(item.notification!)"
              >
                View
              </button>
              <button *ngIf="electronSideBar" class="emily-btn">Save</button>
            </div>

              <time
                class="message-time"
                [dateTime]="item.created.toISOString()"
              >
                {{ item.created | date : "shortTime" }}
              </time>
            </div>
          </div>

          <div class="d-flex gap-2">
            <div
              *ngIf="
                (item.from === 'system' &&
                  item.notification?.json &&
                  !isNotificationLoaded(item.notification) &&
                  item.notification?.html) ||
                item.notification?.notificationCategoryId === 4
              "
              class="choose"
            >
              <button
                *ngIf="item.notification?.notificationCategoryId === 4"
                class="emily-btn"
                (click)="getSCsDataFromJsons(true)"
                [disabled]="isNotificationLoading(item.notification)"
              >
                Yes
              </button>
              <button
                *ngIf="item.notification?.notificationCategoryId === 4"
                class="emily-btn"
                (click)="getSCsDataFromJsons(false)"
                [disabled]="isNotificationLoading(item.notification)"
              >
                No
              </button>
            </div>
          </div>
        </div>
      </div>
      <div *ngIf="isTyping" class="message-row system">
        <div class="message-bubble typing">
          <span class="dot"></span>
          <span class="dot"></span>
          <span class="dot"></span>
        </div>
      </div>

      <ng-template #noMessages>
        <div class="no-messages">
          <p>No messages yet.</p>
          <p class="no-messages-subtext">
            Start chatting with Emily for updates and assistance.
          </p>
        </div>
      </ng-template>
    </div>

    <div class="composer">
      <div class="input-container">
        <div
          class="composer-input"
          contenteditable="true"
          #messageInput
          (input)="onInputChange($event)"
          (keydown)="onKeyDown($event)"
          [attr.data-placeholder]="outgoingText ? null : 'Type a messageâ€¦'"
          [class.has-text]="outgoingText"
        ></div>
      </div>

      <button class="composer-send-btn" (click)="sendMessage()">
        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
          <path
            d="M22 2L11 13"
            stroke="currentColor"
            stroke-width="2"
            fill="none"
          />
          <path
            d="M22 2L15 22L11 13L2 9L22 2Z"
            stroke="currentColor"
            stroke-width="2"
            fill="none"
          />
        </svg>
      </button>
    </div>
  </section>
</div>

<ng-template #notificationModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Notification</h4>
    <button
      type="button"
      class="btn-close"
      aria-label="Close"
      (click)="modal.dismiss()"
    ></button>
  </div>
  <div class="modal-body">
    <p>{{ currentMessage }}</p>
  </div>
  <div class="modal-footer">
    <button
      class="choose emily-btn"
      (click)="sendPromptMessage(currentMessage); modal.close()"
    >
      Try Again
    </button>
  </div>
</ng-template>
<ng-template #savingTpl>
  <span class="btn-spinner"></span>
  <span>Savingâ€¦</span>
</ng-template>
<ng-template #overlayModal let-modal>
  <div
    class="modal-header d-flex justify-content-between align-items-center flex-wrap gap-2"
  >
    <h4 class="modal-title mb-0">Details</h4>
    <div class="d-flex align-items-center gap-2">
      <input
        type="text"
        [(ngModel)]="pdfTitle"
        placeholder="Enter Title"
        class="form-control form-control-sm"
        style="width: 180px"
      />

      <button
        class="btn btn-sm btn-success title-btn"
        (click)="saveTitleInNotification()"
        [disabled]="!pdfTitle.trim()"
      >
        Save Title
      </button>

      <button
        class="btn btn-sm btn-outline-primary save-pdf-btn"
        (click)="downloadPDF(contentToDownload)"
        *ngIf="overlayHtml && !isGeneratingPdf"
        [disabled]="isGeneratingPdf"
      >
        ðŸ“„ Save PDF
      </button>

      <button
        type="button"
        class="btn-close"
        aria-label="Close"
        (click)="modal.dismiss()"
      ></button>
    </div>
  </div>

  <div class="modal-body p-0">
    <section class="overlay-left-modal">
      <div #contentToDownload class="overlay-content p-0">
        <div *ngIf="overlayHtml" [innerHTML]="overlayHtml"></div>
      </div>
    </section>
    <div
      class="save-div"
      *ngIf="
        selectedNotification &&
        (+selectedNotification.taskId === 2 ||
          +selectedNotification.taskId === 3 ||
          +selectedNotification.taskId === 4 ||
          +selectedNotification.taskId === 5) &&
        +selectedNotification.isEndInsertion === 0
      "
    >
      <button
        *ngIf="
          selectedNotification &&
          (+selectedNotification.taskId === 2 ||
            +selectedNotification.taskId === 3 ||
            +selectedNotification.taskId === 4 ||
            +selectedNotification.taskId === 5) &&
          +selectedNotification.isEndInsertion === 0
        "
        class="btn save-btn"
        (click)="saveNotification(selectedNotification)"
        [disabled]="isSaving"
      >
        <ng-container *ngIf="!isSaving; else savingTpl">Save</ng-container>
      </button>
    </div>
  </div>
</ng-template>
