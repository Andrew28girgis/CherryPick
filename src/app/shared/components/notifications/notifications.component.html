<!-- Copilot-style sidebar container (chat can open/close with isOpen) -->
<div
  class="copilot-sidebar-container"
  [ngClass]="{ responsive: electronSideBar, 'overlay-mode': isOverlayMode }"
  [class.open]="isOpen"
>
  <!-- Add backdrop click handler for overlay mode -->
  <div
    *ngIf="isOverlayMode"
    class="overlay-backdrop"
    (click)="onOverlayBackdropClick($event)"
  ></div>

  <!-- Sidebar Panel -->
  <div
    class="sidebar-panel"
    [ngClass]="{ responsive: electronSideBar }"
    [class.visible]="isOpen"
    (click)="$event.stopPropagation()"
  >
    <!-- ========================================================= -->
    <!-- ONE GRID for both states:
         - overlay OFF: left column is hidden via CSS, chat fills width
         - overlay ON : left (content) | right (chat = 380px)        -->
    <!-- ========================================================= -->

    <div class="overlay-grid" (click)="$event.stopPropagation()">
      <!-- LEFT: Content column (appears only when overlay is ON via CSS) -->
      <section *ngIf="!electronSideBar" class="overlay-left">
        <header class="overlay-content-header">
          <div class="d-flex align-items-center justify-content-between w-100">
            <h3 class="overlay-title">Details</h3>
          </div>
          <button
            class="overlay-toggle-button"
            (click)="toggleOverlayMode()"
          ></button>
        </header>

        <!-- Wrapper: fills column height, content scrolls, button stays visible -->
        <div class="container-overlay-btn">
          <div class="overlay-content" [innerHTML]="overlayHtml"></div>

          <div
            class="save-div"
            *ngIf="
              selectedNotification &&
              (+selectedNotification.taskId === 2 ||
                +selectedNotification.taskId === 3) &&
              +selectedNotification.isEndInsertion === 0
            "
          >
            <button
              *ngIf="
                selectedNotification &&
                (+selectedNotification.taskId === 2 ||
                  +selectedNotification.taskId === 3) &&
                +selectedNotification.isEndInsertion === 0
              "
              class="btn save-btn"
              (click)="saveNotification(selectedNotification)"
              [disabled]="isSaving"
            >
              <ng-container *ngIf="!isSaving; else savingTpl"
                >Save</ng-container
              >
            </button>
          </div>
        </div>
      </section>

      <ng-template #savingTpl>
        <span class="btn-spinner"></span>
        <span>Saving…</span>
      </ng-template>

      <!-- Toast (alert) -->
      <div class="save-toast" *ngIf="showSaveToast">Saved successfully</div>

      <!-- RIGHT: Chat column (single instance, always rendered when panel is visible) -->
      <section class="overlay-right">
        <!-- Header -->
        <div class="sidebar-header">
          <div class="header-content">
            <img
              width="20"
              height="20"
              src="../../../../assets/Images/bot.png"
              alt="Emily"
            />
            <h3 class="sidebar-title">Emily</h3>
          </div>

          <div style="display: flex; gap: 6px; align-items: center">
            <!-- Close (closes chat panel AND ensures overlay off) -->
            <button
              class="close-button"
              (click)="closeAll()"
              aria-label="Close"
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
        </div>

        <!-- THE ONLY messages container (works for both states) -->
        <div
          class="chat-messages-container"
          #messagesContainer
          (scroll)="onScroll($event)"
        >
          <div
            class="scroll-down-button"
            *ngIf="showScrollButton && isOpen"
            (click)="scrollToBottom()"
          >
            <div class="scroll-icon">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </div>
            <div class="new-message-count" *ngIf="newNotificationsCount > 0">
              {{ newNotificationsCount }}
            </div>
          </div>

          <!-- Single merged, time-ordered list -->
          <div
            *ngIf="chatTimeline.length > 0; else noMessages"
            class="chat-messages"
          >
            <div
              class="message-bubble"
              *ngFor="let item of chatTimeline; trackBy: trackByChatItem"
              [class.user]="item.from === 'user'"
              [class.system]="item.from === 'system'"
              [class.ai]="item.from === 'ai'"
              [class.clickable]="item.notification?.userSubmissionId"
              (click)="
                item.notification?.userSubmissionId &&
                  handleNotificationClick(item.notification!)
              "
              [attr.id]="
                item.notification?.id
                  ? 'msg-' + item.notification?.id
                  : 'msg-' + item.key
              "
            >
              <!-- If you still need the loading overlay for system notifications: -->
              <div
                *ngIf="
                  item.from === 'system' &&
                  isNotificationLoading(item.notification)
                "
                class="spinner-container full-message"
              >
                <div class="spinner-overlay"></div>
                <div class="spinner-central"></div>
              </div>

              <div class="message-content">
                <p class="message-text">{{ item.message }}</p>
                <time
                  class="message-time"
                  [dateTime]="item.created.toISOString()"
                >
                  {{ item.created | date : "shortTime" }}
                </time>
              </div>

              <!-- Action buttons only for system notifications with JSON (unchanged) -->
              <div
                *ngIf="
                  item.from === 'system' &&
                  item.notification?.json &&
                  !isNotificationLoaded(item.notification)
                "
                class="choose"
              >
                <button
                  class="emily-btn"
                  (click)="choose(1, item.notification)"
                  [disabled]="isNotificationLoading(item.notification)"
                >
                  Yes
                </button>
                <button
                  class="emily-btn"
                  (click)="choose(0, item.notification)"
                  [disabled]="isNotificationLoading(item.notification)"
                >
                  No
                </button>
                <button
                  *ngIf="item.notification?.html"
                  class="emily-btn"
                  (click)="loadHtmlInsideNewWindow(item.notification?.html)"
                >
                  View
                </button>
              </div>
            </div>
          </div>
          <!-- Typing indicator bubble -->
          <div *ngIf="isTyping" class="message-row system">
            <div class="message-bubble typing">
              <span class="dot"></span>
              <span class="dot"></span>
              <span class="dot"></span>
            </div>
          </div>

          <!-- Empty state -->
          <ng-template #noMessages>
            <div class="no-messages">
              <p>No messages yet.</p>
              <p class="no-messages-subtext">
                Start chatting with Emily for updates and assistance.
              </p>
            </div>
          </ng-template>
        </div>

        <!-- Composer -->
        <div class="composer">
          <div class="input-container">
            <div
              class="composer-input"
              contenteditable="true"
              #messageInput
              (input)="onInputChange($event)"
              (keydown)="onKeyDown($event)"
              [attr.data-placeholder]="outgoingText ? null : 'Type a message…'"
              [class.has-text]="outgoingText"
            ></div>
          </div>

          <button
            class="composer-send-btn"
            (click)="sendMessage()"
            [disabled]="!outgoingText.trim() || isSending"
          >
            <div *ngIf="isSending" class="spinner"></div>
            <svg
              *ngIf="!isSending"
              viewBox="0 0 24 24"
              width="18"
              height="18"
              aria-hidden="true"
            >
              <path
                d="M22 2L11 13"
                stroke="currentColor"
                stroke-width="2"
                fill="none"
              />
              <path
                d="M22 2L15 22L11 13L2 9L22 2Z"
                stroke="currentColor"
                stroke-width="2"
                fill="none"
              />
            </svg>
          </button>
        </div>
      </section>
    </div>
    <!-- /overlay-grid -->
  </div>
</div>
