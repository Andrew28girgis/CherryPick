<!-- Copilot-style sidebar container (chat can open/close with isOpen) -->
<div
  class="copilot-sidebar-container"
  [ngClass]="{
    responsive: electronSideBar,
    'overlay-mode': isOverlayMode,
    'chatbot-route': isChatbotRoute,
    'chatbot-overlay': isChatbotRoute && isOverlayMode
  }"
  [class.open]="isOpen"
>
  <!-- Add backdrop click handler for overlay mode -->
  <div
    *ngIf="isOverlayMode"
    class="overlay-backdrop"
    (click)="onOverlayBackdropClick($event)"
  ></div>

  <!-- Sidebar Panel -->
  <div
    class="sidebar-panel"
    [ngClass]="{ responsive: electronSideBar }"
    [class.visible]="isOpen"
    (click)="$event.stopPropagation()"
  >
    <!-- ========================================================= -->
    <!-- ONE GRID for both states:
         - overlay OFF: left column is hidden via CSS, chat fills width
         - overlay ON : left (content) | right (chat = 380px)        -->
    <!-- ========================================================= -->

    <div class="overlay-grid" (click)="$event.stopPropagation()">
      <!-- LEFT: Content column (appears only when overlay is ON via CSS) -->
      <section
        *ngIf="!electronSideBar && (isOverlayMode || !isChatbotRoute)"
        class="overlay-left"
      >
        <header
          class="overlay-content-header d-flex align-items-center justify-content-between w-100"
        >
          <h3 class="overlay-title mb-0">Details</h3>

          <div *ngIf="isOverlayMode" class="d-flex align-items-center gap-2">
            <!-- Title input -->
            <input
              type="text"
              [(ngModel)]="pdfTitle"
              placeholder="Enter Title"
              class="form-control form-control-sm"
              style="width: 180px"
            />

            <!-- Save Title -->
            <button
              class="btn btn-sm btn-success title-btn"
              (click)="saveTitleInNotification()"
            >
              Save Title
            </button>

            <!-- Save PDF -->
            <button
              *ngIf="overlayHtml && !isGeneratingPdf"
              class="btn btn-sm btn-outline-primary save-pdf-btn"
              (click)="downloadPDF()"
              title="Save as PDF"
            >
              ðŸ“„ Save PDF
            </button>

            <!-- Spinner -->
            <div *ngIf="isGeneratingPdf" class="pdf-spinner">
              Generating PDF...
            </div>

            <!-- Toggle Overlay -->
            <button
              class="overlay-toggle-button btn btn-sm btn-light"
              (click)="toggleOverlayMode()"
              title="Toggle overlay"
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
              </svg>
            </button>
          </div>
        </header>

        <!-- PDF Title Dialog -->
        <div
          *ngIf="showPdfTitleDialog"
          class="pdf-dialog-backdrop"
          (click)="cancelPdfDialog()"
        >
          <div class="pdf-dialog" (click)="$event.stopPropagation()">
            <h4 class="mb-3">Save as PDF</h4>

            <input
              type="text"
              [(ngModel)]="pdfTitle"
              placeholder="Enter PDF title..."
              class="form-control mb-3"
              (keydown.enter)="confirmPdfDownload()"
              (keydown.escape)="cancelPdfDialog()"
            />

            <div class="d-flex justify-content-end gap-2">
              <button class="btn btn-secondary" (click)="cancelPdfDialog()">
                Cancel
              </button>
              <button
                class="btn btn-primary"
                (click)="confirmPdfDownload()"
                [disabled]="!pdfTitle.trim()"
              >
                Save PDF
              </button>
            </div>
          </div>
        </div>

        <!-- Wrapper: fills column height, content scrolls, button stays visible -->
        <div *ngIf="isOverlayMode" class="container-overlay-btn">
          <div
            #contentToDownload
            class="overlay-content"
            [innerHTML]="overlayHtml"
          ></div>

          <div
            class="save-div"
            *ngIf="
              selectedNotification &&
              (+selectedNotification.taskId === 2 ||
                +selectedNotification.taskId === 3) &&
              +selectedNotification.isEndInsertion === 0
            "
          >
            <button
              *ngIf="
                selectedNotification &&
                (+selectedNotification.taskId === 2 ||
                  +selectedNotification.taskId === 3) &&
                +selectedNotification.isEndInsertion === 0
              "
              class="btn save-btn"
              (click)="saveNotification(selectedNotification)"
              [disabled]="isSaving"
            >
              <ng-container *ngIf="!isSaving; else savingTpl"
                >Save</ng-container
              >
            </button>
          </div>
        </div>
      </section>

      <ng-template #savingTpl>
        <span class="btn-spinner"></span>
        <span>Savingâ€¦</span>
      </ng-template>

      <!-- Toast (alert) -->
      <div class="save-toast" *ngIf="showSaveToast">Saved successfully</div>

      <!-- RIGHT: Chat column (single instance, always rendered when panel is visible) -->
      <section class="overlay-right">
        <!-- Header -->
        <div class="sidebar-header">
          <div class="header-content">
            <img
              width="20"
              height="20"
              src="../../../../assets/Images/bot.png"
              alt="Emily"
            />
            <h3 class="sidebar-title">Emily</h3>
          </div>

          <div style="display: flex; gap: 6px; align-items: center">
            <!-- Close (closes chat panel AND ensures overlay off) -->
            <button
              class="close-button"
              [ngClass]="{ 'close-route': isChatbotRoute }"
              (click)="closeAll()"
              aria-label="Close"
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
        </div>

        <!-- THE ONLY messages container (works for both states) -->
        <div
          class="chat-messages-container"
          #messagesContainer
          (scroll)="onScroll($event)"
        >
          <div
            class="scroll-down-button"
            *ngIf="showScrollButton && isOpen"
            (click)="scrollToBottom()"
          >
            <div class="scroll-icon">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </div>
            <div class="new-message-count" *ngIf="newNotificationsCount > 0">
              {{ newNotificationsCount }}
            </div>
          </div>

          <!-- Single merged, time-ordered list -->
          <div
            *ngIf="chatTimeline.length > 0; else noMessages"
            class="chat-messages"
          >
            <div
              class="message-bubble"
              *ngFor="let item of chatTimeline; trackBy: trackByChatItem"
              [class.user]="item.from === 'user'"
              [class.system]="item.from === 'system'"
              [class.ai]="item.from === 'ai'"
              [class.clickable]="item.notification?.userSubmissionId"
              (click)="
                item.notification?.userSubmissionId &&
                  handleNotificationClick(item.notification!)
              "
              [attr.id]="
                item.notification?.id
                  ? 'msg-' + item.notification?.id
                  : 'msg-' + item.key
              "
            >
              <!-- If you still need the loading overlay for system notifications: -->
              <div
                *ngIf="
                  item.from === 'system' &&
                  isNotificationLoading(item.notification)
                "
                class="spinner-container full-message"
              >
                <div class="spinner-overlay"></div>
                <div class="spinner-central"></div>
              </div>

              <div class="message-content">
                <p
                  class="message-text"
                  *ngIf="item.from === 'ai' && item.notification?.html"
                >
                  Search Result
                </p>
                <div *ngIf="item.from === 'ai' && item.notification?.html">
                  <p class="message-text">Not Found Results </p>
                  <button class="choose emily-btn" (click)="showprompt(item.notification?.contextExtendPrompt)">Try Again</button>
                </div>
                <p class="message-text" *ngIf="item.from !== 'ai'">
                  {{ item.message }}
                </p>
                <time
                  class="message-time"
                  [dateTime]="item.created.toISOString()"
                >
                  {{ item.created | date : "shortTime" }}
                </time>
              </div>

              <!-- Action buttons only for system notifications with JSON (unchanged) -->
              <div class="d-flex gap-2">
                <div
                  *ngIf="
                    item.from === 'system' &&
                    item.notification?.json &&
                    !isNotificationLoaded(item.notification)
                  "
                  class="choose"
                >
                  <button
                    *ngIf="item.notification?.notificationCategoryId === 4"
                    class="emily-btn"
                    (click)="choose(1, item.notification)"
                    [disabled]="isNotificationLoading(item.notification)"
                  >
                    Yes
                  </button>
                  <!-- <button
                    class="emily-btn"
                    (click)="choose(0, item.notification)"
                    [disabled]="isNotificationLoading(item.notification)"
                  >
                    No
                  </button> -->
                </div>
                <div class="choose" *ngIf="item.notification?.html">
                  <button
                    class="emily-btn"
                    (click)="loadHtmlInsideNewWindow(item.notification!)"
                  >
                    View
                  </button>
                </div>
              </div>
            </div>
          </div>
          <!-- Typing indicator bubble -->
          <div *ngIf="isTyping" class="message-row system">
            <div class="message-bubble typing">
              <span class="dot"></span>
              <span class="dot"></span>
              <span class="dot"></span>
            </div>
          </div>

          <!-- Empty state -->
          <ng-template #noMessages>
            <div class="no-messages">
              <p>No messages yet.</p>
              <p class="no-messages-subtext">
                Start chatting with Emily for updates and assistance.
              </p>
            </div>
          </ng-template>
        </div>

        <!-- Composer -->
        <div class="composer">
          <div class="input-container">
            <div
              class="composer-input"
              contenteditable="true"
              #messageInput
              (input)="onInputChange($event)"
              (keydown)="onKeyDown($event)"
              [attr.data-placeholder]="outgoingText ? null : 'Type a messageâ€¦'"
              [class.has-text]="outgoingText"
            ></div>
          </div>

          <button class="composer-send-btn" (click)="sendMessage()">
            <!-- <div *ngIf="isSending" class="spinner"></div> -->
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path
                d="M22 2L11 13"
                stroke="currentColor"
                stroke-width="2"
                fill="none"
              />
              <path
                d="M22 2L15 22L11 13L2 9L22 2Z"
                stroke="currentColor"
                stroke-width="2"
                fill="none"
              />
            </svg>
          </button>
        </div>
      </section>
    </div>
    <!-- /overlay-grid -->
  </div>
</div>


<ng-template #notificationModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Notification</h4>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <p>{{ currentMessage }}</p>
  </div>
  <div class="modal-footer">
    <button class="choose emily-btn" (click)="sendPromptMessage(currentMessage);modal.close()">Try Again</button>
  </div>
</ng-template>
