<ngx-spinner type="ball-scale-multiple"></ngx-spinner>
<div class="campaign-manager-container container-fluid">
  <div
    class="w-100 d-flex align-items-center justify-content-end"
    style="padding-top: 24px; padding-bottom: 21px"
  >
    <div
      class="d-flex align-items-center gap-3 toggle-cont"
      *ngIf="!hideViewToggles"
    >
      <div class="view-toggle" *ngIf="0">
        <button
          class="toggle-btn"
          [class.active]="viewMode === 'table'"
          (click)="toggleView('table')"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="3" y1="9" x2="21" y2="9"></line>
            <line x1="3" y1="15" x2="21" y2="15"></line>
            <line x1="9" y1="3" x2="9" y2="21"></line>
            <line x1="15" y1="3" x2="15" y2="21"></line>
          </svg>
        </button>
        <button
          class="toggle-btn"
          [class.active]="viewMode === 'card'"
          (click)="toggleView('card')"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <rect x="3" y="3" width="7" height="7"></rect>
            <rect x="14" y="3" width="7" height="7"></rect>
            <rect x="14" y="14" width="7" height="7"></rect>
            <rect x="3" y="14" width="7" height="7"></rect>
          </svg>
        </button>
      </div>
      <button class="add-new-campaign" (click)="openCampaignModal()">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 20 20"
          fill="none"
        >
          <path
            d="M10.0001 18.3333C14.5834 18.3333 18.3334 14.5833 18.3334 9.99996C18.3334 5.41663 14.5834 1.66663 10.0001 1.66663C5.41675 1.66663 1.66675 5.41663 1.66675 9.99996C1.66675 14.5833 5.41675 18.3333 10.0001 18.3333Z"
            stroke="white"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M6.66675 10H13.3334"
            stroke="white"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M10 13.3333V6.66663"
            stroke="white"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
        <span>Add Campaign</span>
      </button>
    </div>
  </div>

  <!-- Skeleton loading for Card View -->
  <div class="campaign-manager-body" *ngIf="isLoading && viewMode === 'card'">
    <div class="campaign-cards-container">
      <div
        class="campaign-card skeleton-card"
        *ngFor="let i of skeletonCardArray"
      >
        <div class="campaign-card-header">
          <div class="skeleton-title"></div>
          <div class="skeleton-privacy"></div>
        </div>
        <div class="tenant-section">
          <div class="d-flex align-items-center gap-2">
            <div class="skeleton-logo"></div>
            <div class="skeleton-tenant-name"></div>
          </div>
          <div class="skeleton-date"></div>
        </div>
        <div class="campaign-stats">
          <div class="stat-item">
            <div class="skeleton-stat-label"></div>
            <div class="skeleton-stat-value"></div>
          </div>
          <div class="stat-item">
            <div class="skeleton-stat-label"></div>
            <div class="skeleton-stat-value"></div>
          </div>
          <div class="stat-item">
            <div class="skeleton-stat-label"></div>
            <div class="skeleton-stat-value"></div>
          </div>
        </div>
        <div class="campaign-actions">
          <div class="skeleton-button"></div>
          <div class="skeleton-button"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Skeleton loading for Table View -->
  <div class="campaign-manager-body" *ngIf="isLoading && viewMode === 'table'">
    <div class="table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th style="width: 250px">Campaign Name</th>
            <th style="width: 80px; text-align: center">Emily</th>
            <th style="width: 120px; text-align: center">Date</th>
            <th style="width: 100px; text-align: center">Privacy</th>
            <th style="width: 80px; text-align: center">Sites</th>
            <th style="width: 120px; text-align: center">Submissions</th>
            <th style="width: 80px; text-align: center">Sent</th>
            <ng-container *ngFor="let stage of stages">
              <th scope="col" style="width: 100px; text-align: center">
                {{ stage.stageName }}
              </th>
            </ng-container>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let i of skeletonTableArray">
            <td style="width: 250px">
              <div class="skeleton-campaign-name"></div>
              <div class="d-flex align-items-center gap-2 mt-2">
                <div class="skeleton-logo"></div>
                <div class="skeleton-tenant-name"></div>
              </div>
            </td>
            <td style="text-align: center">
              <div class="skeleton-date-cell"></div>
            </td>
            <td style="text-align: center">
              <div class="skeleton-privacy-cell"></div>
            </td>
            <td style="text-align: center">
              <div class="skeleton-sites-cell"></div>
            </td>
            <td style="text-align: center">
              <div class="skeleton-submissions-cell"></div>
            </td>
            <td style="text-align: center">
              <div class="skeleton-sent-cell"></div>
            </td>
            <td style="text-align: center">
              <div class="skeleton-actions-cell"></div>
            </td>
            <ng-container *ngFor="let j of skeletonStagesArray">
              <td style="text-align: center">
                <div class="skeleton-stage-cell"></div>
              </td>
            </ng-container>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Actual content -->
  <div
    *ngIf="
      !isLoading &&
      filteredCampaigns &&
      filteredCampaigns.length > 0 &&
      stages.length > 0
    "
    class="campaign-manager-body"
  >
    <div class="campaign-cards-container" *ngIf="viewMode === 'card'">
      <ng-container
        *ngFor="let campaign of filteredCampaigns; let index = index"
      >
        <div class="campaign-card">
          <div class="date-privacy d-flex justify-content-between">
            <div class="tenant-section-card">
              <div class="date-created-card">
                {{ (campaign.CreatedDate | date : "MMM d, y") ?? "N/A" }}
              </div>
            </div>
            <div
              class="campaign-privacy"
              [ngClass]="{
                'campaign-privacy-public': campaign.CampaignPrivacy == 0,
                'campaign-privacy-private': campaign.CampaignPrivacy == 1
              }"
            >
              <div class="campaign-privacy-icon"></div>
              <span class="campaign-privacy-text">
                {{ campaign.CampaignPrivacy == 0 ? "Public" : "Private" }}
              </span>
            </div>
          </div>
          <div class="campaign-card-header">
            <div
              class="d-flex align-items-center gap-2 d-flex flex-column tenant-header"
            >
              <img
                *ngIf="campaign.OrganizationId"
                [src]="
                  'https://api.cherrypick.com/api/Organization/GetOrgImag?orgId=' +
                  campaign.OrganizationId
                "
                [alt]="campaign.OrganizationName"
                class="tenant-logo-card"
                (error)="onImageError($event)"
              />
              <h3
                style="cursor: pointer"
                [routerLink]="[
                  '/dashboard',
                  campaign.OrganizationId,
                  campaign.OrganizationName,
                  campaign.Id
                ]"
                class="campaign-name"
              >
                {{ campaign.CampaignName }}
              </h3>
            </div>
          </div>

          <div class="campaign-stats">
            <div class="stat-item">
              <div class="stat-label">Sites</div>
              <div class="stat-value">
                <div
                  class="d-flex align-items-center justify-content-center gap-2"
                >
                  <div>{{ campaign.Sites }}</div>
                  <svg
                    [routerLink]="[
                      '/dashboard',
                      campaign.OrganizationId,
                      campaign.OrganizationName,
                      campaign.Id
                    ]"
                    style="cursor: pointer"
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                  >
                    <path
                      d="M12.9999 11.75C12.8099 11.75 12.6199 11.68 12.4699 11.53C12.1799 11.24 12.1799 10.76 12.4699 10.47L20.6699 2.26999C20.9599 1.97999 21.4399 1.97999 21.7299 2.26999C22.0199 2.55999 22.0199 3.03999 21.7299 3.32999L13.5299 11.53C13.3799 11.68 13.1899 11.75 12.9999 11.75Z"
                      fill="#292D32"
                    />
                    <path
                      d="M22 7.55C21.59 7.55 21.25 7.21 21.25 6.8V2.75H17.2C16.79 2.75 16.45 2.41 16.45 2C16.45 1.59 16.79 1.25 17.2 1.25H22C22.41 1.25 22.75 1.59 22.75 2V6.8C22.75 7.21 22.41 7.55 22 7.55Z"
                      fill="#292D32"
                    />
                    <path
                      d="M15 22.75H9C3.57 22.75 1.25 20.43 1.25 15V9C1.25 3.57 3.57 1.25 9 1.25H11C11.41 1.25 11.75 1.59 11.75 2C11.75 2.41 11.41 2.75 11 2.75H9C4.39 2.75 2.75 4.39 2.75 9V15C2.75 19.61 4.39 21.25 9 21.25H15C19.61 21.25 21.25 19.61 21.25 15V13C21.25 12.59 21.59 12.25 22 12.25C22.41 12.25 22.75 12.59 22.75 13V15C22.75 20.43 20.43 22.75 15 22.75Z"
                      fill="#292D32"
                    />
                  </svg>
                </div>
              </div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Submissions</div>
              <div
                class="d-flex align-items-center justify-content-center gap-3"
              >
                <!-- [routerLink]="['/submissions', campaign.Id]" -->
                <div *ngIf="campaign.Submissions" style="cursor: pointer">
                  <span style="color: orange" title="New Submissions">{{
                    getSubmissionsCountNew(campaign.Submissions)
                  }}</span>
                  |
                  <span
                    style="color: rgb(0, 207, 35)"
                    title="Accepted Submissions"
                    >{{
                      getSumbmissionsCountAcceppted(campaign.Submissions)
                    }}</span
                  >
                  |
                  <span
                    style="color: rgb(207, 0, 0)"
                    title="Rejected Submissions"
                    >{{
                      getSumbmissionsCountRejected(campaign.Submissions)
                    }}</span
                  >

                  <ng-container
                    *ngFor="
                      let submission of sortedSubmissions(campaign.Submissions);
                      let i = index
                    "
                  >
                  </ng-container>
                </div>
                <div *ngIf="!campaign.Submissions">N/A</div>
              </div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Mails Sent</div>
              <div class="stat-value" *ngIf="campaign.MailsSent">
                {{ campaign.MailsSent }}
              </div>
            </div>
          </div>
          <!-- <a
            class="inbox text-center"
            [routerLink]="['./ataglance', campaign.Id]"
            >At a Glance</a
          > -->
          <div class="campaign-actions">
            <div class="inbox mail d-flex justify-content-between">
              <i class="fa-regular fa-envelope"></i>
              <a
                [routerLink]="[
                  '/organization-mail',
                  campaign.OrganizationId,
                  campaign.Id
                ]"
                >Emily</a
              >
            </div>

            <button
              class="expand-btn"
              (click)="toggleExpand(campaign)"
              *ngIf="campaign.Kanban"
            >
              {{ campaign.expanded ? "Hide Stages" : "Show Stages" }}
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                [style.transform]="
                  campaign.expanded ? 'rotate(180deg)' : 'rotate(0)'
                "
              >
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
          </div>

          <div class="campaign-stages" [class.expanded]="campaign.expanded">
            <div class="stages-grid">
              <ng-container *ngFor="let kanbanStage of campaign.Kanban">
                <div class="stage-item">
                  <div class="stage-name">{{ kanbanStage.stageName }}</div>
                  <div class="stage-value">
                    {{
                      kanbanStage.MarketSurveyShoppingCenters[0].Id
                        ? kanbanStage.MarketSurveyShoppingCenters.length
                        : 0
                    }}
                  </div>
                  <!-- <a
                    class="hyber-link"
                    *ngIf="
                      kanbanStage.stageName.toLowerCase() ==
                      'Precontact'.toLowerCase()
                    "
                    (click)="goToEmily(c, index, true)"
                    >Launch Campaign</a
                  > -->
                </div>
              </ng-container>
            </div>
          </div>
        </div>
      </ng-container>
    </div>

    <!-- Original Table View -->
    <div class="table-responsive" *ngIf="viewMode === 'table'">
      <div class="table-inner">
        <table class="table align-middle">
          <thead>
            <tr>
              <th class="col-name">Campaign Name</th>
              <th class="col-emily">Emily</th>
              <!-- <th class="col-date">Date</th> -->
              <!-- <th class="col-privacy">Privacy</th> -->
              <th class="col-sites">Sites</th>
              <th class="col-submissions">Submissions</th>
              <th class="col-sent">Sent</th>
              <ng-container *ngFor="let stage of stages">
                <th scope="col" class="col-stage">
                  {{ stage.stageName }}
                </th>
              </ng-container>
            </tr>
          </thead>
          <tbody>
            <ng-container
              *ngFor="let campaign of filteredCampaigns; let index = index"
            >
              <tr>
                <td class="col-name">
                  <div class="campaign-info">
                    <div
                      class="campaign-name"
                      [routerLink]="[
                        '/dashboard',
                        campaign.OrganizationId,
                        campaign.OrganizationName,
                        campaign.Id
                      ]"
                    >
                      {{ campaign.CampaignName }} /
                      {{ campaign.OrganizationName }}
                    </div>
                    <div
                      class="date justify-content-between gap-1 w-100"
                      style="display: flex; align-items: center"
                    >
                      {{ (campaign.CreatedDate | date : "MMM d, y") ?? "N/A" }}
                      <div
                        class="campaign-privacy"
                        [ngClass]="{
                          'campaign-privacy-public':
                            campaign.CampaignPrivacy == 0,
                          'campaign-privacy-private':
                            campaign.CampaignPrivacy == 1
                        }"
                      >
                        <div class="campaign-privacy-icon"></div>
                        <span>
                          {{
                            campaign.CampaignPrivacy == 0 ? "Public" : "Private"
                          }}</span
                        >
                      </div>
                    </div>
                    <!-- <div class="organization-info">
                    <img
                      *ngIf="campaign.OrganizationId"
                      [src]="
                        'https://api.cherrypick.com/api/Organization/GetOrgImag?orgId=' +
                        campaign.OrganizationId
                      "
                      [alt]="campaign.OrganizationName"
                      class="tenant-logo"
                      (error)="onImageError($event)"
                      (load)="checkImage($event)"
                    />
                    <span
                      class="tenant-name"
                      [routerLink]="[
                        '/dashboard',
                        campaign.OrganizationId,
                        campaign.OrganizationName,
                        campaign.Id
                      ]"
                    >
                      {{ campaign.OrganizationName }}
                    </span>
                  </div> -->
                  </div>
                </td>

                <td class="col-emily">
                  <div
                    class="inbox mail"
                    [routerLink]="[
                      '/organization-mail',
                      campaign.OrganizationId,
                      campaign.Id
                    ]"
                  >
                    <i class="fa-regular fa-envelope"></i>
                  </div>
                </td>

                <!-- <td class="col-date">
                  {{ (campaign.CreatedDate | date : "MMM d, y") ?? "N/A" }}
                </td> -->

                <!-- <td class="col-privacy">
                  <div
                    class="campaign-privacy"
                    [ngClass]="{
                      'campaign-privacy-public': campaign.CampaignPrivacy == 0,
                      'campaign-privacy-private': campaign.CampaignPrivacy == 1
                    }"
                  >
                    <div class="campaign-privacy-icon"></div>
                    <span>
                      {{
                        campaign.CampaignPrivacy == 0 ? "Public" : "Private"
                      }}</span
                    >
                  </div>
                </td> -->

                <td class="col-sites">
                  <div class="sites-info">
                    <div>{{ campaign.Sites }}</div>
                    <svg
                      [routerLink]="[
                        '/dashboard',
                        campaign.OrganizationId,
                        campaign.OrganizationName,
                        campaign.Id
                      ]"
                      class="external-link-icon"
                      xmlns="http://www.w3.org/2000/svg"
                      width="18"
                      height="18"
                      viewBox="0 0 24 24"
                      fill="none"
                    >
                      <path
                        d="M12.9999 11.75C12.8099 11.75 12.6199 11.68 12.4699 11.53C12.1799 11.24 12.1799 10.76 12.4699 10.47L20.6699 2.26999C20.9599 1.97999 21.4399 1.97999 21.7299 2.26999C22.0199 2.55999 22.0199 3.03999 21.7299 3.32999L13.5299 11.53C13.3799 11.68 13.1899 11.75 12.9999 11.75Z"
                        fill="#292D32"
                      />
                      <path
                        d="M22 7.55C21.59 7.55 21.25 7.21 21.25 6.8V2.75H17.2C16.79 2.75 16.45 2.41 16.45 2C16.45 1.59 16.79 1.25 17.2 1.25H22C22.41 1.25 22.75 1.59 22.75 2V6.8C22.75 7.21 22.41 7.55 22 7.55Z"
                        fill="#292D32"
                      />
                      <path
                        d="M15 22.75H9C3.57 22.75 1.25 20.43 1.25 15V9C1.25 3.57 3.57 1.25 9 1.25H11C11.41 1.25 11.75 1.59 11.75 2C11.75 2.41 11.41 2.75 11 2.75H9C4.39 2.75 2.75 4.39 2.75 9V15C2.75 19.61 4.39 21.25 9 21.25H15C19.61 21.25 21.25 19.61 21.25 15V13C21.25 12.59 21.59 12.25 22 12.25C22.41 12.25 22.75 12.59 22.75 13V15C22.75 20.43 20.43 22.75 15 22.75Z"
                        fill="#292D32"
                      />
                    </svg>
                  </div>
                </td>

                <td class="col-submissions">
                  <div class="submissions-info">
                    <div *ngIf="campaign.Submissions" class="submission-counts">
                      <span class="count-new" title="New Submissions">{{
                        getSubmissionsCountNew(campaign.Submissions)
                      }}</span>
                      |
                      <span
                        class="count-accepted"
                        title="Accepted Submissions"
                        >{{
                          getSumbmissionsCountAcceppted(campaign.Submissions)
                        }}</span
                      >
                      |
                      <span
                        class="count-rejected"
                        title="Rejected Submissions"
                        >{{
                          getSumbmissionsCountRejected(campaign.Submissions)
                        }}</span
                      >

                      <ng-container
                        *ngFor="
                          let submission of sortedSubmissions(
                            campaign.Submissions
                          );
                          let i = index
                        "
                      >
                      </ng-container>
                    </div>
                    <div *ngIf="!campaign.Submissions" class="no-data">N/A</div>
                  </div>
                </td>

                <td class="col-sent">
                  <ng-container *ngIf="campaign.MailsSent">
                    {{ campaign.MailsSent }}</ng-container
                  >
                </td>

                <ng-container *ngFor="let stage of stages">
                  <td class="col-stage">
                    <div class="stage-count">
                      {{ getKanbanCount(stage.stageName, campaign.Kanban) }}
                    </div>
                  </td>
                </ng-container>
              </tr>
            </ng-container>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div
    *ngIf="!isLoading && !(filteredCampaigns && filteredCampaigns.length > 0)"
    class="empty-campaigns"
  >
    <img src="../../../assets/Images/empty-state.png" alt="Empty Campaigns" />
    <h4>Campaigns Will Appear Here!</h4>
    <p>Create, Track, and Manage Expansion Campaigns Here.</p>
  </div>
</div>

<ng-template #content let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Add Campaign</h4>
    <button
      type="button"
      class="btn-close"
      aria-label="Close"
      (click)="modal.dismiss('Cross click')"
    ></button>
  </div>
  <div class="modal-body">
    <div class="campaign-drawing-component">
      <app-campaign-drawing
        [userBuyBoxes]="userBuyBoxes"
        (onCampaignCreated)="onCampaignCreated()"
      ></app-campaign-drawing>
    </div>
  </div>
</ng-template>
