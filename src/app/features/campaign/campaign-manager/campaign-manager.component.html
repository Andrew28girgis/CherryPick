<ngx-spinner type="ball-scale-multiple"></ngx-spinner>

<div>
  <div class="title-div">
    <h2 class="title">Campaigns</h2>
  </div>

  <div
    class="d-flex align-items-center gap-3 justify-content-between w-100 py-3"
    *ngIf="!hideViewToggles"
  >
    <div *ngIf="filteredCampaigns?.length" class="organization-tabs-container">
      <div
        class="organization-tab"
        [class.active]="selectedOrganizationId === 'all'"
        (click)="filterByOrganization('all')"
      >
        All
      </div>

      <div
        class="organization-tab"
        *ngFor="let org of organizations"
        [class.active]="selectedOrganizationId === org.id"
        (click)="filterByOrganization(org.id)"
      >
        <ng-container *ngIf="org.logo; else logoPlaceholder">
          <img
            [src]="org.logo"
            class="org-c-logo"
            #logoImg
            crossorigin="anonymous"
          />
        </ng-container>
        <ng-template #logoPlaceholder>
          <div class="org-logo org-c-logo placeholder">
            {{ getInitials(org.name) }}
          </div>
        </ng-template>
        <!-- {{ org.name }} -->
      </div>
    </div>
    <div class="d-flex align-items-center gap-3 flex-row">
      <div class="view-toggle" *ngIf="true">
        <button
          class="toggle-btn"
          [class.active]="viewMode === 'table'"
          (click)="toggleView('table')"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="lucide lucide-table-properties-icon lucide-table-properties"
          >
            <path d="M15 3v18" />
            <rect width="18" height="18" x="3" y="3" rx="2" />
            <path d="M21 9H3" />
            <path d="M21 15H3" />
          </svg>
        </button>
        <button
          class="toggle-btn"
          [class.active]="viewMode === 'card'"
          (click)="toggleView('card')"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <rect x="3" y="3" width="7" height="7"></rect>
            <rect x="14" y="3" width="7" height="7"></rect>
            <rect x="14" y="14" width="7" height="7"></rect>
            <rect x="3" y="14" width="7" height="7"></rect>
          </svg>
        </button>
      </div>
      <button class="g-button" (click)="openAddCampaign(addCampaign)">
        <span>Add Campaign</span>
      </button>
    </div>
  </div>

  <div
    *ngIf="
      filteredCampaigns && filteredCampaigns.length > 0 && stages.length > 0
    "
  >
    <!-- Updated card view to dashboard cards layout -->
    <div class="dashboard-cards-container" *ngIf="viewMode === 'card'">
      <ng-container
        *ngFor="let campaign of filteredCampaigns; let index = index"
      >
        <div
          class="dashboard-card"
          [class.click-disabled]="openMenuId === campaign.Id"
          [class.changed]="campaign.changed"
        >
          <div class="card-overlay">
            <div class="menu-wrapper" (click)="$event.stopPropagation()">
              <button
                class="menu-btn"
                (click)="toggleMenu(campaign.Id, $event)"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 20 20"
                  fill="none"
                >
                  <path
                    d="M4.16699 8.20801C5.15737 8.20818 5.95801 9.00958 5.95801 10C5.95783 10.9903 5.15726 11.7908 4.16699 11.791C3.17658 11.791 2.37518 10.9904 2.375 10C2.375 9.00948 3.17647 8.20801 4.16699 8.20801ZM4.16699 8.45801C3.31585 8.45801 2.625 9.14886 2.625 10C2.62518 10.851 3.31596 11.541 4.16699 11.541C5.01788 11.5408 5.70783 10.8509 5.70801 10C5.70801 9.14897 5.01799 8.45818 4.16699 8.45801Z"
                    fill="#18171F"
                    stroke="#18171F"
                  />
                  <path
                    d="M15.8334 12.2913C14.5667 12.2913 13.5417 11.2663 13.5417 9.99967C13.5417 8.73301 14.5667 7.70801 15.8334 7.70801C17.1001 7.70801 18.1251 8.73301 18.1251 9.99967C18.1251 11.2663 17.1001 12.2913 15.8334 12.2913ZM15.8334 8.95801C15.2584 8.95801 14.7917 9.42467 14.7917 9.99967C14.7917 10.5747 15.2584 11.0413 15.8334 11.0413C16.4084 11.0413 16.8751 10.5747 16.8751 9.99967C16.8751 9.42467 16.4084 8.95801 15.8334 8.95801Z"
                    fill="#18171F"
                  />
                  <path
                    d="M9.99992 12.2913C8.73325 12.2913 7.70825 11.2663 7.70825 9.99967C7.70825 8.73301 8.73325 7.70801 9.99992 7.70801C11.2666 7.70801 12.2916 8.73301 12.2916 9.99967C12.2916 11.2663 11.2666 12.2913 9.99992 12.2913ZM9.99992 8.95801C9.42492 8.95801 8.95825 9.42467 8.95825 9.99967C8.95825 10.5747 9.42492 11.0413 9.99992 11.0413C10.5749 11.0413 11.0416 10.5747 11.0416 9.99967C11.0416 9.42467 10.5749 8.95801 9.99992 8.95801Z"
                    fill="#18171F"
                  />
                </svg>
              </button>

              <!-- DROPDOWN -->
              <div class="menu-dropdown" *ngIf="openMenuId === campaign.Id">
                <button
                  class="menu-item"
                  (click)="viewSpecs(campaign); closeMenu()"
                >
                  View Specs
                </button>
                <button
                  class="menu-item"
                  (click)="deleteCampaign(campaign.Id); closeMenu()"
                >
                  Delete Campaign
                </button>
                <button
                  class="menu-item"
                  (click)="viewSpecsNew(campaign, true); closeMenu()"
                >
                  Edit Campaign
                </button>
                <!-- <button
                  class="menu-item"
                  (click)="editWithEMily(campaign); closeMenu()"
                >
                  Edit Campaign with emily
                </button> -->
              </div>
            </div>
            <div
              class="click-shield"
              *ngIf="openMenuId === campaign.Id"
              (click)="closeMenu()"
            ></div>
          </div>

          <div
            class="card-badge date-flag"
            [attr.aria-label]="campaign.CreatedDate | date : 'MMMM d, y'"
          >
            <span class="date-flag__day">{{
              campaign.CreatedDate | date : "d"
            }}</span>
            <span class="date-flag__mon">{{
              campaign.CreatedDate | date : "MMM"
            }}</span>
          </div>

          <div class="card-header">
            <div class="campaign-title-section">
              <a
                class="title-with-logo"
                [ngClass]="{ 'title-hover': campaign.Sites }"
                [routerLink]="
                  campaign.Sites
                    ? ['/dashboard', campaign.OrganizationId, campaign.Id]
                    : null
                "
              >
                <!-- Logo or placeholder -->
                <ng-container *ngIf="campaign.LogoUrl; else logoPlaceholder">
                  <img
                    [src]="campaign.LogoUrl"
                    class="org-logo"
                    #logoImg
                    crossorigin="anonymous"
                  />
                </ng-container>
                <ng-template #logoPlaceholder>
                  <div class="org-logo placeholder">
                    {{ getInitials(campaign.CampaignName) }}
                  </div>
                </ng-template>

                <!-- Text block -->
                <div>
                  <div class="organization-name">
                    {{ campaign.OrganizationName | uppercase }}
                  </div>
                  <div class="campaign-title">
                    {{ campaign.CampaignName }}
                  </div>
                </div>
              </a>
              <div
                style="margin-left: 70px"
                (click)="editWithEMily(campaign)"
                class="emily-button"
                aria-label=" Emily  "
              >
                Ask Emily
              </div>
            </div>

            <!-- <div
              class="privacy-badge"
              [ngClass]="{
                'privacy-public': campaign.CampaignPrivacy == 0,
                'privacy-private': campaign.CampaignPrivacy == 1
              }"
            >
              <div class="privacy-icon"></div>
              <span>{{
                campaign.CampaignPrivacy == 0 ? "Public" : "Private"
              }}</span>
            </div> -->
          </div>

          <div class="card-metrics">
            <div
              class="metric-item"
              [ngClass]="{ link: campaign.Sites }"
              [routerLink]="
                campaign.Sites > 0
                  ? ['/dashboard', campaign.OrganizationId, campaign.Id]
                  : null
              "
            >
              <div class="metric-value" [class.changed]="campaign.changed">
                <span>{{ campaign.Sites }}</span>
                <svg
                  *ngIf="campaign.Sites"
                  class="external-icon"
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                >
                  <path
                    d="M12.9999 11.75C12.8099 11.75 12.6199 11.68 12.4699 11.53C12.1799 11.24 12.1799 10.76 12.4699 10.47L20.6699 2.26999C20.9599 1.97999 21.4399 1.97999 21.7299 2.26999C22.0199 2.55999 22.0199 3.03999 21.7299 3.32999L13.5299 11.53C13.3799 11.68 13.1899 11.75 12.9999 11.75Z"
                    fill="currentColor"
                  />
                  <path
                    d="M22 7.55C21.59 7.55 21.25 7.21 21.25 6.8V2.75H17.2C16.79 2.75 16.45 2.41 16.45 2C16.45 1.59 16.79 1.25 17.2 1.25H22C22.41 1.25 22.75 1.59 22.75 2V6.8C22.75 7.21 22.41 7.55 22 7.55Z"
                    fill="currentColor"
                  />
                  <path
                    d="M15 22.75H9C3.57 22.75 1.25 20.43 1.25 15V9C1.25 3.57 3.57 1.25 9 1.25H11C11.41 1.25 11.75 1.59 11.75 2C11.75 2.41 11.41 2.75 11 2.75H9C4.39 2.75 2.75 4.39 2.75 9V15C2.75 19.61 4.39 21.25 9 21.25H15C19.61 21.25 21.25 19.61 21.25 15V13C21.25 12.59 21.59 12.25 22 12.25C22.41 12.25 22.75 12.59 22.75 13V15C22.75 20.43 20.43 22.75 15 22.75Z"
                    fill="currentColor"
                  />
                </svg>
              </div>
              <div class="metric-label">Sites</div>
            </div>

            <div class="metric-item">
              <div class="metric-value">{{ campaign.MailsSent || "0" }}</div>
              <div class="metric-label">Mails Sent</div>
            </div>
          </div>

          <!-- Card stages: tiny chips row -->
          <div class="card-stages always-visible">
            <div class="stages-chips">
              <ng-container *ngFor="let stage of stages">
                <div class="stage-chip" [ngClass]="stageClass(stage.stageName)">
                  <span class="stage-chip__label">{{ stage.stageName }}</span>
                  <span class="stage-chip__count">
                    {{ getKanbanCount(stage.stageName, campaign.Kanban) }}
                  </span>
                </div>
              </ng-container>
            </div>
          </div>
        </div>
      </ng-container>
    </div>

    <div class="table-responsive mt-3" *ngIf="viewMode === 'table'">
      <div class="table-inner">
        <table class="table align-middle">
          <thead>
            <tr>
              <th class="col-name">Name</th>
              <th class="col-sent">Sent</th>
              <ng-container *ngFor="let stage of stages">
                <th scope="col" class="col-stage">
                  {{ stage.stageName }}
                </th>
              </ng-container>
            </tr>
          </thead>
          <tbody>
            <ng-container
              *ngFor="let campaign of filteredCampaigns; let index = index"
            >
              <tr>
                <td class="col-name">
                  <div class="campaign-info">
                    <div
                      class="t-name d-flex justify-content-between w-100 align-items-center mt-2"
                    >
                      <div
                        class="tenant-title d-flex align-items-center"
                        [routerLink]="[
                          '/dashboard',
                          campaign.OrganizationId,
                          campaign.Id
                        ]"
                      >
                        <ng-container
                          *ngIf="campaign.LogoUrl; else logoPlaceholder"
                        >
                          <img
                            [src]="campaign.LogoUrl"
                            class="org-c-logo"
                            #logoImg
                            crossorigin="anonymous"
                          />
                        </ng-container>
                        <ng-template #logoPlaceholder>
                          <div class="org-logo org-c-logo placeholder">
                            {{ getInitials(campaign.CampaignName) }}
                          </div>
                        </ng-template>
                        <span class="ms-2">{{
                          campaign.OrganizationName | uppercase
                        }}</span>
                      </div>
                      <div ngbDropdown container="body" class="dropdown">
                        <button
                          class="btn btn-light btn-sm p-0"
                          ngbDropdownToggle
                          (click)="$event.stopPropagation()"
                        >
                          <!-- Three Dots Icon -->
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="20"
                            height="20"
                            viewBox="0 0 20 20"
                            fill="none"
                          >
                            <path
                              d="M4.16699 8.20801C5.15737 8.20818 5.95801 9.00958 5.95801 10C5.95783 10.9903 5.15726 11.7908 4.16699 11.791C3.17658 11.791 2.37518 10.9904 2.375 10C2.375 9.00948 3.17647 8.20801 4.16699 8.20801ZM4.16699 8.45801C3.31585 8.45801 2.625 9.14886 2.625 10C2.62518 10.851 3.31596 11.541 4.16699 11.541C5.01788 11.5408 5.70783 10.8509 5.70801 10C5.70801 9.14897 5.01799 8.45818 4.16699 8.45801Z"
                              fill="#18171F"
                              stroke="#18171F"
                            />
                            <path
                              d="M15.8334 12.2913C14.5667 12.2913 13.5417 11.2663 13.5417 9.99967C13.5417 8.73301 14.5667 7.70801 15.8334 7.70801C17.1001 7.70801 18.1251 8.73301 18.1251 9.99967C18.1251 11.2663 17.1001 12.2913 15.8334 12.2913ZM15.8334 8.95801C15.2584 8.95801 14.7917 9.42467 14.7917 9.99967C14.7917 10.5747 15.2584 11.0413 15.8334 11.0413C16.4084 11.0413 16.8751 10.5747 16.8751 9.99967C16.8751 9.42467 16.4084 8.95801 15.8334 8.95801Z"
                              fill="#18171F"
                            />
                            <path
                              d="M9.99992 12.2913C8.73325 12.2913 7.70825 11.2663 7.70825 9.99967C7.70825 8.73301 8.73325 7.70801 9.99992 7.70801C11.2666 7.70801 12.2916 8.73301 12.2916 9.99967C12.2916 11.2663 11.2666 12.2913 9.99992 12.2913ZM9.99992 8.95801C9.42492 8.95801 8.95825 9.42467 8.95825 9.99967C8.95825 10.5747 9.42492 11.0413 9.99992 11.0413C10.5749 11.0413 11.0416 10.5747 11.0416 9.99967C11.0416 9.42467 10.5749 8.95801 9.99992 8.95801Z"
                              fill="#18171F"
                            />
                          </svg>
                        </button>

                        <div ngbDropdownMenu>
                          <button ngbDropdownItem (click)="viewSpecs(campaign)">
                            View Specs
                          </button>
                          <button
                            ngbDropdownItem
                            (click)="viewSpecsNew(campaign, true)"
                          >
                            Edit Campaign
                          </button>
                          <button
                            ngbDropdownItem
                            (click)="deleteCampaign(campaign.Id)"
                          >
                            Delete Campaign
                          </button>
                        </div>
                      </div>
                    </div>
                    <div
                      class="d-flex justify-content-between w-100 align-items-center mt-2"
                    >
                      <div
                        class="campaign-name"
                        [routerLink]="[
                          '/dashboard',
                          campaign.OrganizationId,
                          campaign.Id
                        ]"
                      >
                        <p class="m-0" style="font-weight: 500">
                          {{ campaign.CampaignName }}
                        </p>
                      </div>
                      <div
                        class="inbox mail"
                        [routerLink]="[
                          '/organization-mail',
                          campaign.OrganizationId,
                          campaign.Id
                        ]"
                      >
                        <i class="fa-regular fa-envelope"></i>
                      </div>
                    </div>
                    <div class="mt-1">
                      <div class="sites-info">
                        <div>{{ campaign.Sites }} Property Available</div>
                      </div>
                      <p class="created-date m-0">
                        {{
                          (campaign.CreatedDate | date : "MMM d, y") ?? "N/A"
                        }}
                      </p>
                    </div>

                    <div
                      (click)="editWithEMily(campaign)"
                      class="emily-button emily-button-table mt-2"
                      aria-label=" Emily  "
                    >
                      Ask Emily
                    </div>
                  </div>
                </td>

                <td class="col-sent">
                  <ng-container *ngIf="campaign.MailsSent">
                    {{ campaign.MailsSent }}</ng-container
                  >
                </td>

                <ng-container *ngFor="let stage of stages">
                  <td class="col-stage">
                    <div class="stage-count">
                      {{ getKanbanCount(stage.stageName, campaign.Kanban) }}
                    </div>
                  </td>
                </ng-container>
              </tr>
            </ng-container>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div
    *ngIf="!(filteredCampaigns && filteredCampaigns.length > 0)"
    class="empty-campaigns"
  >
    <h4>Campaigns Will Appear Here!</h4>
    <p>Create, Track, and Manage Expansion Campaigns Here.</p>
  </div>
</div>

<ng-template #content let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Add Campaign</h4>
    <button
      type="button"
      class="btn-close"
      aria-label="Close"
      (click)="modal.dismiss('Cross click')"
    ></button>
  </div>
  <div class="modal-body">
    <div class="campaign-drawing-component">
      <app-campaign-drawing
        [userBuyBoxes]="userBuyBoxes"
        (onCampaignCreated)="onCampaignCreated()"
      ></app-campaign-drawing>
    </div>
  </div>
</ng-template>

<ng-template #addCampaign let-modal>
  <div class="modal-header d-flex justify-content-between align-items-center">
    <h4 class="modal-title mb-0">Add Campaign</h4>

    <div class="selected-tenant-header mx-3" *ngIf="selectedTenant">
      <ng-container *ngIf="selectedTenant.logoUrl; else logoPlaceholder">
        <img
          [src]="selectedTenant.logoUrl"
          class="tenant-logop"
          crossorigin="anonymous"
        />
      </ng-container>
      <ng-template #logoPlaceholder>
        <div class="tenant-logop placeholder">
          {{ getInitials(selectedTenant.name) }}
        </div>
      </ng-template>

      <span class="tenant-name">
        {{ selectedTenant.name }}
      </span>
    </div>

    <button
      type="button"
      class="btn-close d-flex align-items-center justify-content-center"
      aria-label="Close"
      (click)="modal.dismiss()"
    >
      <i class="fa-solid fa-xmark"></i>
    </button>
  </div>

  <div class="modal-body">
    <!-- Stepper + Finish button inline -->
    <div
      class="stepper-container d-flex justify-content-between align-items-center mb-2 gap-2"
    >
      <!-- Stepper -->
      <div class="stepper d-flex align-items-center">
        <div class="step" [class.active]="step === 'tenant'">Select Tenant</div>
        <div class="step-line"></div>
        <div class="step" [class.active]="step === 'campaign'">
          Campaign Details
        </div>
        <div class="step-line"></div>
        <div class="step" [class.active]="step === 'polygon'">Locations</div>
      </div>

      <!-- Finish button -->
      <div>
        <button
          *ngIf="step === 'polygon'"
          class="btn btn-primary next-btn"
          (click)="finish()"
        >
          Finish
        </button>
      </div>
    </div>

    <div
      *ngIf="TenantStepLoad"
      class="d-flex justify-content-center align-items-center p-5"
    >
      <div class="spinner-border custom-spinner" role="status">
        <span class="visually-hidden">Loading tenants...</span>
      </div>
    </div>
    <!-- Step 1: Tenants -->
    <div *ngIf="!TenantStepLoad && step === 'tenant'">
      <div class="tenant-cards-grid">
        <div
          *ngFor="let tenant of tenants"
          class="tenant-card"
          [class.selected]="selectedTenant === tenant"
          (click)="selectTenant(tenant)"
        >
          <!-- logo + name -->
          <div class="tenant-header">
            <ng-container *ngIf="tenant.logoUrl; else logoPlaceholder">
              <img
                [src]="tenant.logoUrl"
                class="tenant-logo"
                crossorigin="anonymous"
              />
            </ng-container>
            <ng-template #logoPlaceholder>
              <div class="tenant-logo placeholder">
                {{ getInitials(tenant.OrganizationName || tenant.name) }}
              </div>
            </ng-template>
            <h3 class="tenant-name">
              {{ tenant.OrganizationName || tenant.name }}
            </h3>
          </div>

          <!-- selection mark -->
          <div class="tenant-check" *ngIf="selectedTenant === tenant">✓</div>
        </div>
        <div
          class="tenant-card add-card"
          (click)="openAddTenantModal(tenantModal)"
        >
          <div class="add-card-content">
            <div class="plus-icon">+</div>
            <h3 class="tenant-name">Add Tenant</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 2: Campaign Details -->
    <div *ngIf="step === 'campaign'" class="campaign-step">
      <!-- Left side: Campaign name -->
      <div class="left">
        <label for="campaignName" class="form-label">Campaign Name</label>
        <input
          id="campaignName"
          type="text"
          class="form-control"
          [(ngModel)]="campaignName"
          placeholder="Enter campaign name"
        />
      </div>
      <div class="right">
        <label class="form-label">Campaign Type</label>

        <div class="campaign-type-selection">
          <label class="campaign-type-card" [class.active]="forSale">
            <input
              type="checkbox"
              [(ngModel)]="forSale"
              class="visually-hidden"
            />
            <div class="card-content">
              <i class="fa-solid fa-tag"></i>
              <span>For Sale</span>
              <div class="custom-checkbox">
                <i *ngIf="forSale" class="fa-solid fa-check"></i>
              </div>
            </div>
          </label>
          <div class="d-flex flex-column">
            <label
              class="campaign-type-card"
              [class.active]="forLease"
              (click)="toggleForLease()"
            >
              <input
                type="checkbox"
                [(ngModel)]="forLease"
                class="visually-hidden"
                (change)="toggleForLease()"
              />
              <div class="card-content">
                <i class="fa-solid fa-building-user"></i>
                <span>For Lease</span>
                <div class="custom-checkbox">
                  <i *ngIf="forLease" class="fa-solid fa-check"></i>
                </div>
              </div>
            </label>
            <div class="lease-options-container" *ngIf="forLease">
              <div class="type-options">
                <div
                  class="type-option"
                  [class.active]="campaignType === 'standalone'"
                  (click)="selectLeaseType('standalone')"
                >
                  <i class="fa-solid fa-store"></i>
                  <span>Standalone Only</span>
                  <i
                    *ngIf="campaignType === 'standalone'"
                    class="fa-solid fa-check check-indicator"
                  ></i>
                </div>

                <div
                  class="type-option"
                  [class.active]="campaignType === 'standaloneShopping'"
                  (click)="selectLeaseType('standaloneShopping')"
                >
                  <i class="fa-solid fa-shop"></i>
                  <span>Vacant Spaces Inside Shopping Center</span>
                  <i
                    *ngIf="campaignType === 'standaloneShopping'"
                    class="fa-solid fa-check check-indicator"
                  ></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Unit Size Selection -->
      <div class="unit-size-section">
        <label class="form-label">Unit Size Range (sq ft)</label>

        <div class="d-flex gap-3">
          <div class="flex-grow-1">
            <input
              type="number"
              class="form-control"
              placeholder="Min Unit Size"
              [(ngModel)]="MinUnitSize"
              min="0"
            />
          </div>

          <div class="flex-grow-1">
            <input
              type="number"
              class="form-control"
              placeholder="Max Unit Size"
              [(ngModel)]="MaxUnitSize"
              [min]="MinUnitSize || 0"
            />
          </div>
        </div>

        <!-- Optional small validation message -->
        <div
          class="text-danger mt-1"
          *ngIf="MaxUnitSize && MinUnitSize && MaxUnitSize < MinUnitSize"
        >
          Max unit size cannot be smaller than min unit size.
        </div>
      </div>
      <!-- Tenant Search and Selection -->
      <div class="cotenant-selection">
        <label for="campaignName" class="form-label"
          >Search Complementary and Conflicting Tenants</label
        >
        <input
          type="text"
          class="form-control cotenant-search"
          placeholder="Search tenants..."
          [(ngModel)]="tenantSearch"
          (ngModelChange)="onTenantSearchChange($event)"
        />

        <!-- Tenants list -->
        <div *ngIf="cotenants.length > 0" class="cotenant-cards">
          <div
            class="cotenant-card"
            *ngFor="let tenant of cotenants"
            [ngClass]="{
              'complementary-border': isSelected(tenant, 'complementary'),
              'conflicting-border': isSelected(tenant, 'conflicting')
            }"
          >
            <div
              class="card-badge"
              [ngClass]="{
                'complementary-badge': isSelected(tenant, 'complementary'),
                'conflicting-badge': isSelected(tenant, 'conflicting')
              }"
            >
              <span
                class="complementary"
                *ngIf="isSelected(tenant, 'complementary')"
              >
                Complementary
              </span>
              <span
                class="conflicting"
                *ngIf="isSelected(tenant, 'conflicting')"
              >
                Conflicting
              </span>
            </div>

            <div>
              <img
                *ngIf="tenant.logoURL"
                [src]="tenant.logoURL"
                alt="{{ tenant.name }}"
                class="cotenant-logo"
              />
              <div *ngIf="!tenant.logoURL" class="cotenant-logo-placeholder">
                <i class="fa-solid fa-store"></i>
              </div>

              <div class="cotenant-info">
                <span class="cotenant-name">{{ tenant.name }}</span>
              </div>
            </div>

            <div class="cotenant-buttons">
              <button
                class="btn btn-success btn-sm"
                (click)="addComplementary(tenant, true)"
              >
                Complementary
              </button>

              <button
                class="btn btn-danger btn-sm"
                (click)="addConflicting(tenant, true)"
              >
                Conflicting
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 3: Polygons -->
    <div *ngIf="step === 'polygon'">
      <app-polygons
        *ngIf="polygonsStep"
        (saveLocationCriteria)="handleSave($event)"
      >
      </app-polygons>
    </div>
  </div>
  <div class="modal-footer modal-nav-footer">
    <!-- Previous button -->
    <button
      *ngIf="step !== 'tenant'"
      class="btn btn-outline-secondary back-btn"
      (click)="prevStep()"
    >
      Previous
    </button>

    <!-- Next from Tenant -->
    <button
      *ngIf="step === 'tenant'"
      class="btn btn-primary next-btn ms-auto"
      [disabled]="!selectedTenant"
      (click)="nextStep()"
    >
      Next
    </button>

    <!-- Next from Campaign -->
    <button
      *ngIf="step === 'campaign'"
      class="btn btn-primary next-btn ms-auto"
      [disabled]="!campaignName || !campaignType"
      (click)="nextStep()"
    >
      Next
    </button>
  </div>
</ng-template>
<ng-template #tenantModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title" id="modal-basic-title" ngbAutofocus>
      Add New Tenant
    </h5>
    <button
      type="button"
      class="btn-close"
      aria-label="Close"
      (click)="modal.dismiss('Cross click')"
    ></button>
  </div>
  <div class="modal-body" style="height: fit-content !important">
    <form #tenantForm="ngForm">
      <div class="mb-3">
        <label for="name" class="form-label d-flex align-items-center gap-2">
          Name *
          <span
            class="text-danger name-isrequired"
            *ngIf="nameInput.invalid && nameInput.touched"
          >
            required
          </span>
        </label>

        <input
          type="text"
          id="name"
          class="form-control"
          name="name"
          required
          [(ngModel)]="newTenant.name"
          #nameInput="ngModel"
          [ngClass]="{
            'is-invalid': nameInput.invalid && nameInput.touched
          }"
        />
      </div>

      <div class="mb-3">
        <label for="url" class="form-label">URL</label>
        <input
          type="url"
          id="url"
          class="form-control"
          name="url"
          pattern="https?://.+"
          [(ngModel)]="newTenant.url"
          #urlInput="ngModel"
        />
      </div>

      <div class="mb-3">
        <label for="linkedin" class="form-label">LinkedIn</label>
        <input
          type="text"
          id="linkedin"
          class="form-control"
          name="linkedin"
          [(ngModel)]="newTenant.linkedin"
        />
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button
      type="button"
      class="g-button g-button-outline cancel-tenant-btn"
      (click)="modal.close('Save click')"
    >
      <span>Cancel</span>
    </button>

    <button
      class="g-button g-button-primary add-tenant-btn-text"
      [disabled]="tenantForm.invalid"
      (click)="addNewTenant()"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
      >
        <path
          d="M6 12H18M12 18V6"
          stroke="white"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
      </svg>
      <span class="add-tenant-text">Add Tenant</span>
    </button>
  </div>
</ng-template>

<ng-template #campaignDetailsModal let-modal>
  <!-- Modal Header -->
  <div class="modal-header">
    <div class="d-flex align-items-center flex-row gap-2">
      <ng-container *ngIf="campaignLogo; else logoPlaceholder">
        <img
          [src]="campaignLogo"
          class="tenant-logo"
          style="width: 50px; height: 50px"
          crossorigin="anonymous"
        />
      </ng-container>
      <ng-template #logoPlaceholder>
        <div class="tenant-logo placeholder">
          {{ getInitials(selectedCampaignDetails?.CampaignName || "") }}
        </div>
      </ng-template>

      <h4 class="modal-title">
        {{ selectedCampaignDetails?.CampaignName ?? "Campaign" }}
      </h4>
    </div>

    <button class="btn btn-primary g-button" (click)="modal.close()">X</button>
  </div>

  <!-- Modal Body -->
  <div class="modal-body popup-body">
    <!-- Campaign Info -->
    <section>
      <h5>Campaign Info</h5>

      <!-- Campaign Name -->
      <div class="form-group sec mb-2 grop">
        <label style="width: 150px">Campaign Name:</label>
        <div>{{ selectedCampaignDetails?.CampaignName }}</div>
      </div>

      <!-- Organization -->
      <div
        *ngIf="selectedCampaignDetails?.OrganizationName"
        class="form-group sec mb-2"
      >
        <label style="width: 150px">Organization:</label>
        <div>{{ selectedCampaignDetails?.OrganizationName }}</div>
      </div>

      <!-- Standalone -->
      <div
        *ngIf="selectedCampaignDetails?.IsStandAlone ?? false"
        class="form-group sec mb-2"
      >
        <label>Standalone:</label>
        <div>{{ selectedCampaignDetails?.IsStandAlone ? "Yes" : "No" }}</div>
      </div>

      <!-- Min Unit Size -->
      <div
        *ngIf="selectedCampaignDetails?.MinUnitSize"
        class="form-group sec mb-2"
      >
        <label>Min Unit Size:</label>
        <div>{{ selectedCampaignDetails?.MinUnitSize }}</div>
      </div>

      <!-- Max Unit Size -->
      <div
        *ngIf="selectedCampaignDetails?.MaxUnitSize"
        class="form-group sec mb-2"
      >
        <label>Max Unit Size:</label>
        <div>{{ selectedCampaignDetails?.MaxUnitSize }}</div>
      </div>

      <!-- Created Date -->
      <div
        *ngIf="selectedCampaignDetails?.CreatedDate"
        class="form-group sec mb-2"
      >
        <label>Created Date:</label>
        <div>{{ selectedCampaignDetails?.CreatedDate | date : "medium" }}</div>
      </div>
    </section>

    <!-- Locations -->
    <section *ngIf="selectedCampaignDetails?.Locations?.length">
      <h5 class="mt-3">Locations</h5>

      <!-- Read Mode -->
      <div class="pills-container">
        <span
          *ngFor="let loc of selectedCampaignDetails.Locations"
          class="data-pill"
        >
          {{ loc.CityName ? loc.CityName + ", " : ""
          }}{{ loc.State ? loc.State : "" }}
        </span>
      </div>
    </section>

    <!-- Relations -->
    <section
      *ngIf="selectedCampaignDetails?.Relations?.length"
      style="height: fit-content"
    >
      <h5 class="mt-3">Relations</h5>

      <!-- Read Mode -->
      <div class="pills-container">
        <span
          *ngFor="let r of selectedCampaignDetails.Relations"
          class="data-pill"
          [ngClass]="{
            'complementary-pill': r.RelationType === 'complementary',
            'conflict-pill': r.RelationType === 'conflict'
          }"
        >
          {{ r.RelationOrganizationName }} ({{ r.RelationType }})
        </span>
      </div>
    </section>

    <!-- Read-Only JSON -->
    <section
      *ngIf="parsedCampaignDetails.length"
      class="border-top pt-3"
      style="height: fit-content"
    >
      <h5>Campaign Details (JSON)</h5>
      <div class="key-value-list">
        <ng-container *ngFor="let entry of parsedCampaignDetails">
          <div class="key-value-item">
            <div class="key">{{ entry.key }}:</div>
            <div class="value">
              <ng-container *ngIf="isArray(entry.value); else nonArray">
                <div class="nested">
                  <ng-container *ngFor="let item of entry.value">
                    <ng-container *ngIf="isObject(item); else simpleItem">
                      <div class="nested">
                        <ng-container
                          *ngFor="let sub of getKeyValuePairs(item)"
                        >
                          <div class="key-value-item">
                            <div class="key">{{ sub.key }}:</div>
                            <div class="value">{{ sub.value }}</div>
                          </div>
                        </ng-container>
                      </div>
                    </ng-container>
                    <ng-template #simpleItem>
                      <div class="value">{{ item }}</div>
                    </ng-template>
                  </ng-container>
                </div>
              </ng-container>
              <ng-template #nonArray>
                <ng-container *ngIf="isObject(entry.value); else simpleValue">
                  <div class="nested">
                    <ng-container
                      *ngFor="let sub of getKeyValuePairs(entry.value)"
                    >
                      <div class="key-value-item">
                        <div class="key">{{ sub.key }}:</div>
                        <div class="value">{{ sub.value }}</div>
                      </div>
                    </ng-container>
                  </div>
                </ng-container>
                <ng-template #simpleValue>{{ entry.value }}</ng-template>
              </ng-template>
            </div>
          </div>
        </ng-container>
      </div>
    </section>
  </div>

  <!-- Modal Footer -->
  <!-- <div class="modal-footer justify-content-end">
    <button *ngIf="!isEditing" class="btn btn-secondary" (click)="startEdit()">
      Edit
    </button>
    <button *ngIf="isEditing" class="g-button" (click)="saveEdit()">
      Save
    </button>
    <button
      *ngIf="isEditing"
      class="btn btn-outline-secondary"
      (click)="cancelEdit()"
    >
      Cancel
    </button>
  </div> -->
</ng-template>
<ng-template #editCampaign let-modal>
  <div class="modal-header d-flex justify-content-between align-items-center">
    <h4 class="modal-title mb-0">Edit Campaign</h4>

    <div class="selected-tenant-header mx-3" *ngIf="selectedTenant">
      <ng-container *ngIf="selectedTenant.logoUrl; else logoPlaceholder">
        <img
          [src]="selectedTenant.logoUrl"
          class="tenant-logop"
          crossorigin="anonymous"
        />
      </ng-container>
      <ng-template #logoPlaceholder>
        <div class="tenant-logop placeholder">
          {{ getInitials(selectedTenant.name) }}
        </div>
      </ng-template>

      <span class="tenant-name">
        {{ selectedTenant?.name }}
      </span>
    </div>

    <button
      type="button"
      class="btn-close d-flex align-items-center justify-content-center"
      aria-label="Close"
      (click)="modal.dismiss()"
    >
      <i class="fa-solid fa-xmark"></i>
    </button>
  </div>

  <div class="modal-body">
    <!-- Stepper + Finish button inline -->
    <div
      class="stepper-container d-flex justify-content-between align-items-center mb-2 gap-2"
    >
      <div class="stepper d-flex align-items-center">
        <div class="step" [class.active]="step === 'tenant'">Select Tenant</div>
        <div class="step-line"></div>
        <div class="step" [class.active]="step === 'campaign'">
          Campaign Details
        </div>
        <div class="step-line"></div>
        <div class="step" [class.active]="step === 'polygon'">Locations</div>
      </div>

      <div>
        <button
          *ngIf="step === 'polygon'"
          class="btn btn-primary next-btn"
          (click)="finish()"
        >
          Finish
        </button>
      </div>
    </div>

    <!-- Loading state -->
    <div
      *ngIf="TenantStepLoad"
      class="d-flex justify-content-center align-items-center p-5"
    >
      <div class="spinner-border custom-spinner" role="status">
        <span class="visually-hidden">Loading tenants...</span>
      </div>
    </div>

    <!-- Step 1: Select Tenant -->
    <div *ngIf="!TenantStepLoad && step === 'tenant'">
      <div class="tenant-cards-grid">
        <div
          *ngFor="let tenant of tenants"
          class="tenant-card"
          [class.selected]="selectedTenant.id === tenant.id"
          (click)="selectTenant(tenant)"
        >
          <div class="tenant-header">
            <ng-container *ngIf="tenant.logoUrl; else logoPlaceholder">
              <img
                [src]="tenant.logoUrl"
                class="tenant-logo"
                crossorigin="anonymous"
              />
            </ng-container>
            <ng-template #logoPlaceholder>
              <div class="tenant-logo placeholder">
                {{ getInitials(tenant.name) }}
              </div>
            </ng-template>
            <h3 class="tenant-name">{{ tenant.name }}</h3>
          </div>

          <div class="tenant-check" *ngIf="selectedTenant.id === tenant.id">
            ✓
          </div>
        </div>
      </div>
    </div>

    <!-- Step 2: Campaign Details -->
    <div *ngIf="step === 'campaign'" class="campaign-step">
      <div class="left">
        <label for="campaignName" class="form-label">Campaign Name</label>
        <input
          id="campaignName"
          type="text"
          class="form-control"
          [(ngModel)]="campaignName"
          placeholder="Enter campaign name"
        />
      </div>
      <div class="right">
        <label class="form-label">Campaign Type</label>

        <div class="campaign-type-selection">
          <label class="campaign-type-card" [class.active]="forSale">
            <input
              type="checkbox"
              [(ngModel)]="forSale"
              class="visually-hidden"
            />
            <div class="card-content">
              <i class="fa-solid fa-tag"></i>
              <span>For Sale</span>
              <div class="custom-checkbox">
                <i *ngIf="forSale" class="fa-solid fa-check"></i>
              </div>
            </div>
          </label>

          <label
            class="campaign-type-card"
            [class.active]="forLease"
            (click)="toggleForLease()"
          >
            <input
              type="checkbox"
              [(ngModel)]="forLease"
              class="visually-hidden"
              (change)="toggleForLease()"
            />
            <div class="card-content">
              <i class="fa-solid fa-building-user"></i>
              <span>For Lease</span>
              <div class="custom-checkbox">
                <i *ngIf="forLease" class="fa-solid fa-check"></i>
              </div>
            </div>
          </label>
        </div>

        <div class="lease-options-container" *ngIf="forLease">
          <div class="type-options">
            <div
              class="type-option"
              [class.active]="IsStandAlone === true"
              (click)="IsStandAlone = true"
            >
              <i class="fa-solid fa-store"></i>
              <span>Standalone Only</span>
              <i
                *ngIf="campaignType === 'standalone'"
                class="fa-solid fa-check check-indicator"
              ></i>
            </div>

            <div
              class="type-option"
              [class.active]="IsStandAlone === false"
              (click)="IsStandAlone = false"
            >
              <i class="fa-solid fa-shop"></i>
              <span>Vacant Spaces Inside Shopping Center</span>
              <i
                *ngIf="campaignType === 'standaloneShopping'"
                class="fa-solid fa-check check-indicator"
              ></i>
            </div>
          </div>
        </div>
      </div>
      <div class="unit-size-section">
        <label class="form-label">Unit Size Range (sq ft)</label>
        <div class="d-flex gap-3">
          <div class="flex-grow-1">
            <input
              type="number"
              class="form-control"
              placeholder="Min Unit Size"
              [(ngModel)]="MinUnitSize"
              min="0"
            />
          </div>

          <div class="flex-grow-1">
            <input
              type="number"
              class="form-control"
              placeholder="Max Unit Size"
              [(ngModel)]="MaxUnitSize"
              [min]="MinUnitSize || 0"
            />
          </div>
        </div>

        <div
          class="text-danger mt-1"
          *ngIf="MaxUnitSize && MinUnitSize && MaxUnitSize < MinUnitSize"
        >
          Max unit size cannot be smaller than min unit size.
        </div>
      </div>
      <!-- Tenant Search and Selection -->
      <div class="cotenant-selection">
        <label for="tenantSearch" class="form-label"
          >Search Complementary and Conflicting Tenants</label
        >
        <input
          type="text"
          class="form-control cotenant-search"
          placeholder="Search tenants..."
          [(ngModel)]="tenantSearch"
          (ngModelChange)="onTenantSearchChange($event)"
        />
        <div class="contenats-wrapper">
          <div *ngIf="cotenants.length > 0" class="cotenant-cards">
            <div
              class="cotenant-card"
              *ngFor="let tenant of cotenants"
              [ngClass]="{
                'complementary-border': isSelected(tenant, 'complementary'),
                'conflicting-border': isSelected(tenant, 'conflicting')
              }"
            >
              <div
                class="card-badge"
                [ngClass]="{
                  'complementary-badge': isSelected(tenant, 'complementary'),
                  'conflicting-badge': isSelected(tenant, 'conflicting')
                }"
              >
                <span
                  class="complementary"
                  *ngIf="isSelected(tenant, 'complementary')"
                  >Complementary</span
                >
                <span
                  class="conflicting"
                  *ngIf="isSelected(tenant, 'conflicting')"
                  >Conflicting</span
                >
              </div>
              <div>
                <img
                  *ngIf="tenant.logoURL"
                  [src]="tenant.logoURL"
                  alt="{{ tenant.name }}"
                  class="cotenant-logo"
                />
                <div *ngIf="!tenant.logoURL" class="cotenant-logo-placeholder">
                  <i class="fa-solid fa-store"></i>
                </div>
                <div class="cotenant-info">
                  <span class="cotenant-name">{{ tenant.name }}</span>
                </div>
              </div>
              <div class="cotenant-buttons">
                <button
                  class="btn btn-success btn-sm"
                  (click)="addComplementary(tenant, true)"
                >
                  Complementary
                </button>
                <button
                  class="btn btn-danger btn-sm"
                  (click)="addConflicting(tenant, true)"
                >
                  Conflicting
                </button>
              </div>
            </div>
          </div>

          <div *ngIf="allTenants.length > 0" class="cotenant-cards">
            <div
              class="cotenant-card"
              *ngFor="let tenant of allTenants"
              [ngClass]="{
                'complementary-border': isSelected2(tenant, 'complementary'),
                'conflicting-border': isSelected2(tenant, 'conflicting')
              }"
            >
              <div
                class="card-badge"
                [ngClass]="{
                  'complementary-badge': isSelected2(tenant, 'complementary'),
                  'conflicting-badge': isSelected2(tenant, 'conflicting')
                }"
              >
                <span
                  class="complementary"
                  *ngIf="isSelected2(tenant, 'complementary')"
                  >Complementary</span
                >
                <span
                  class="conflicting"
                  *ngIf="isSelected2(tenant, 'conflicting')"
                  >Conflicting</span
                >
              </div>
              <div>
                <img
                  *ngIf="tenant.logoURL"
                  [src]="tenant.logoURL"
                  alt="{{ tenant.name }}"
                  class="cotenant-logo"
                />
                <div *ngIf="!tenant.logoURL" class="cotenant-logo-placeholder">
                  <i class="fa-solid fa-store"></i>
                </div>
                <div class="cotenant-info">
                  <span class="cotenant-name">{{
                    tenant.RelationOrganizationName
                  }}</span>
                </div>
              </div>
              <div class="cotenant-buttons">
                <button
                  class="btn btn-success btn-sm"
                  (click)="addComplementary(tenant)"
                >
                  Complementary
                </button>
                <button
                  class="btn btn-danger btn-sm"
                  (click)="addConflicting(tenant)"
                >
                  Conflicting
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 3: Locations -->
    <div *ngIf="step === 'polygon'">
      <app-polygons
        *ngIf="polygonsStep"
        (saveLocationCriteria)="handleSave($event, true)"
        [campaignId]="campaignId"
      ></app-polygons>
    </div>
  </div>

  <div class="modal-footer modal-nav-footer">
    <button
      *ngIf="step !== 'tenant'"
      class="btn btn-outline-secondary back-btn"
      (click)="prevStep()"
    >
      Previous
    </button>
    <button
      *ngIf="step === 'tenant'"
      class="btn btn-primary next-btn ms-auto"
      [disabled]="!selectedTenant"
      (click)="nextStep()"
    >
      Next
    </button>
    <button
      *ngIf="step === 'campaign'"
      class="btn btn-primary next-btn ms-auto"
      [disabled]="!campaignName"
      (click)="nextStep()"
    >
      Next
    </button>
  </div>
</ng-template>
