<ngx-spinner type="ball-scale-multiple"></ngx-spinner>
<div class="campaign-manager-container container-fluid">
  <div class=" title-div ">
    
    <h2 class="title">Campaigns</h2>
  </div>
  <div
    class="w-100 d-flex align-items-center justify-content-end"
    style=" padding-bottom: 21px"
  >

    <div
      class="d-flex align-items-center gap-3 toggle-cont"
      *ngIf="!hideViewToggles"
    >
      <div class="view-toggle" *ngIf="0">
        <button
          class="toggle-btn"
          [class.active]="viewMode === 'table'"
          (click)="toggleView('table')"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="3" y1="9" x2="21" y2="9"></line>
            <line x1="3" y1="15" x2="21" y2="15"></line>
            <line x1="9" y1="3" x2="9" y2="21"></line>
            <line x1="15" y1="3" x2="15" y2="21"></line>
          </svg>
        </button>
        <button
          class="toggle-btn"
          [class.active]="viewMode === 'card'"
          (click)="toggleView('card')"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <rect x="3" y="3" width="7" height="7"></rect>
            <rect x="14" y="3" width="7" height="7"></rect>
            <rect x="14" y="14" width="7" height="7"></rect>
            <rect x="3" y="14" width="7" height="7"></rect>
          </svg>
        </button>
      </div>
      <button class="add-new-campaign" (click)="openCampaignModal()">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 20 20"
          fill="none"
        >
          <path
            d="M10.0001 18.3333C14.5834 18.3333 18.3334 14.5833 18.3334 9.99996C18.3334 5.41663 14.5834 1.66663 10.0001 1.66663C5.41675 1.66663 1.66675 5.41663 1.66675 9.99996C1.66675 14.5833 5.41675 18.3333 10.0001 18.3333Z"
            stroke="white"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M6.66675 10H13.3334"
            stroke="white"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M10 13.3333V6.66663"
            stroke="white"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
        <span>Add Campaign</span>
      </button>
    </div>
  </div>

  <!-- Skeleton loading for Card View -->
  <div class="campaign-manager-body" *ngIf="isLoading && viewMode === 'card'">
    <div class="dashboard-cards-container">
      <div
        class="dashboard-card skeleton-card"
        *ngFor="let i of skeletonCardArray"
      >
        <div class="card-header">
          <div class="skeleton-title"></div>
          <div class="skeleton-privacy"></div>
        </div>
        <div class="card-organization">
          <div class="skeleton-logo"></div>
          <div class="skeleton-tenant-name"></div>
        </div>
        <div class="card-metrics">
          <div class="metric-item">
            <div class="skeleton-stat-value"></div>
            <div class="skeleton-stat-label"></div>
          </div>
          <div class="metric-item">
            <div class="skeleton-stat-value"></div>
            <div class="skeleton-stat-label"></div>
          </div>
          <div class="metric-item">
            <div class="skeleton-stat-value"></div>
            <div class="skeleton-stat-label"></div>
          </div>
        </div>
        <div class="card-actions">
          <div class="skeleton-button"></div>
          <div class="skeleton-button"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Skeleton loading for Table View -->
  <div class="campaign-manager-body" *ngIf="isLoading && viewMode === 'table'">
    <div class="table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th style="width: 250px">Campaign Name</th>
            <th style="width: 80px; text-align: center">Emily</th>
            <th style="width: 120px; text-align: center">Date</th>
            <th style="width: 100px; text-align: center">Privacy</th>
            <th style="width: 80px; text-align: center">Sites</th>
            <th style="width: 120px; text-align: center">Submissions</th>
            <th style="width: 80px; text-align: center">Sent</th>
            <ng-container *ngFor="let stage of stages">
              <th scope="col" style="width: 100px; text-align: center">
                {{ stage.stageName }}
              </th>
            </ng-container>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let i of skeletonTableArray">
            <td style="width: 250px">
              <div class="skeleton-campaign-name"></div>
              <div class="d-flex align-items-center gap-2 mt-2">
                <div class="skeleton-logo"></div>
                <div class="skeleton-tenant-name"></div>
              </div>
            </td>
            <td style="text-align: center">
              <div class="skeleton-date-cell"></div>
            </td>
            <td style="text-align: center">
              <div class="skeleton-privacy-cell"></div>
            </td>
            <td style="text-align: center">
              <div class="skeleton-sites-cell"></div>
            </td>
            <td style="text-align: center">
              <div class="skeleton-submissions-cell"></div>
            </td>
            <td style="text-align: center">
              <div class="skeleton-sent-cell"></div>
            </td>
            <td style="text-align: center">
              <div class="skeleton-actions-cell"></div>
            </td>
            <ng-container *ngFor="let j of skeletonStagesArray">
              <td style="text-align: center">
                <div class="skeleton-stage-cell"></div>
              </td>
            </ng-container>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Actual content -->
  <div
    *ngIf="
      !isLoading &&
      filteredCampaigns &&
      filteredCampaigns.length > 0 &&
      stages.length > 0
    "
    class="campaign-manager-body"
  >
    <!-- Updated card view to dashboard cards layout -->
    <div class="dashboard-cards-container" *ngIf="viewMode === 'card'">
      <ng-container
        *ngFor="let campaign of filteredCampaigns; let index = index"
      >
        <div class="dashboard-card">
          <div
            class="card-badge date-flag"
            [attr.aria-label]="campaign.CreatedDate | date : 'MMMM d, y'"
          >
            <span class="date-flag__day">{{
              campaign.CreatedDate | date : "d"
            }}</span>
            <span class="date-flag__mon">{{
              campaign.CreatedDate | date : "MMM"
            }}</span>
          </div>

          <div class="card-header">
            <div class="campaign-title-section">
              <a
                class="title-with-logo"
                [ngClass]="{ 'title-hover': campaign.Sites }"
                [routerLink]="
                  campaign.Sites
                    ? ['/dashboard', campaign.OrganizationId, campaign.OrganizationName, campaign.Id]
                    : null
                "
              >
                <!-- Logo or placeholder -->
                <ng-container *ngIf="0; else logoPlaceholder">
                  <!-- <img
                    [src]="campaign.OrganizationLogo"
                    alt="{{ campaign.OrganizationName }} logo"
                    class="org-logo"
                  /> -->
                </ng-container>
                <ng-template #logoPlaceholder>
                  <div class="org-logo placeholder">
                    {{ getInitials(campaign.CampaignName) }}
                  </div>
                </ng-template>
            
                <!-- Text block -->
                <div class="title-text">
                  <div class="campaign-title">{{ campaign.CampaignName }}</div>
                  <div class="organization-name">{{ campaign.OrganizationName }}</div>
                </div>
              </a>
            </div>
            
            <div
              class="privacy-badge"
              [ngClass]="{
                'privacy-public': campaign.CampaignPrivacy == 0,
                'privacy-private': campaign.CampaignPrivacy == 1
              }"
            >
              <div class="privacy-icon"></div>
              <span>{{
                campaign.CampaignPrivacy == 0 ? "Public" : "Private"
              }}</span>
            </div>
          </div>

          <div class="card-metrics">
            <div
              class="metric-item"
              [ngClass]="{ link: campaign.Sites }"
              [routerLink]="[
                '/dashboard',
                campaign.OrganizationId,
                campaign.OrganizationName,
                campaign.Id
              ]"
            >
              <div class="metric-value">
                <span>{{ campaign.Sites }}</span>
                <svg
                  *ngIf="campaign.Sites"
                  class="external-icon"
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                >
                  <path
                    d="M12.9999 11.75C12.8099 11.75 12.6199 11.68 12.4699 11.53C12.1799 11.24 12.1799 10.76 12.4699 10.47L20.6699 2.26999C20.9599 1.97999 21.4399 1.97999 21.7299 2.26999C22.0199 2.55999 22.0199 3.03999 21.7299 3.32999L13.5299 11.53C13.3799 11.68 13.1899 11.75 12.9999 11.75Z"
                    fill="currentColor"
                  />
                  <path
                    d="M22 7.55C21.59 7.55 21.25 7.21 21.25 6.8V2.75H17.2C16.79 2.75 16.45 2.41 16.45 2C16.45 1.59 16.79 1.25 17.2 1.25H22C22.41 1.25 22.75 1.59 22.75 2V6.8C22.75 7.21 22.41 7.55 22 7.55Z"
                    fill="currentColor"
                  />
                  <path
                    d="M15 22.75H9C3.57 22.75 1.25 20.43 1.25 15V9C1.25 3.57 3.57 1.25 9 1.25H11C11.41 1.25 11.75 1.59 11.75 2C11.75 2.41 11.41 2.75 11 2.75H9C4.39 2.75 2.75 4.39 2.75 9V15C2.75 19.61 4.39 21.25 9 21.25H15C19.61 21.25 21.25 19.61 21.25 15V13C21.25 12.59 21.59 12.25 22 12.25C22.41 12.25 22.75 12.59 22.75 13V15C22.75 20.43 20.43 22.75 15 22.75Z"
                    fill="currentColor"
                  />
                </svg>
              </div>
              <div class="metric-label">Sites</div>
            </div>

            <div class="metric-item">
              <div
                class="metric-value submissions-breakdown"
                *ngIf="campaign.Submissions"
              >
                <span *ngIf="campaign.Submissions" class="count-new">{{
                  getSubmissionsCountNew(campaign.Submissions)
                }}</span>

                <span class="separator">|</span>
                <span class="count-accepted">{{
                  getSumbmissionsCountAcceppted(campaign.Submissions)
                }}</span>
                <span class="separator">|</span>
                <span class="count-rejected">{{
                  getSumbmissionsCountRejected(campaign.Submissions)
                }}</span>
              </div>
              <div class="metric-value" *ngIf="!campaign.Submissions">0</div>
              <div class="metric-label">Submissions</div>
            </div>

            <div class="metric-item">
              <div class="metric-value">{{ campaign.MailsSent || "0" }}</div>
              <div class="metric-label">Mails Sent</div>
            </div>
          </div>

          <div class="card-actions">
            <div
              class="email-action"
              [routerLink]="[
                '/organization-mail',
                campaign.OrganizationId,
                campaign.Id
              ]"
            >
              <i class="fa-regular fa-envelope"></i>
              <span>Emily</span>
            </div>
            <div
              *ngIf="campaign.Sites"
              class="email-action show-details"
              [routerLink]="[
                '/dashboard',
                campaign.OrganizationId,
                campaign.OrganizationName,
                campaign.Id
              ]"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
              >
                <path
                  d="M15.5799 11.9999C15.5799 13.9799 13.9799 15.5799 11.9999 15.5799C10.0199 15.5799 8.41992 13.9799 8.41992 11.9999C8.41992 10.0199 10.0199 8.41992 11.9999 8.41992C13.9799 8.41992 15.5799 10.0199 15.5799 11.9999Z"
                  stroke="#fff"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M11.9998 20.2702C15.5298 20.2702 18.8198 18.1902 21.1098 14.5902C22.0098 13.1802 22.0098 10.8102 21.1098 9.40021C18.8198 5.80021 15.5298 3.72021 11.9998 3.72021C8.46984 3.72021 5.17984 5.80021 2.88984 9.40021C1.98984 10.8102 1.98984 13.1802 2.88984 14.5902C5.17984 18.1902 8.46984 20.2702 11.9998 20.2702Z"
                  stroke="#fff"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              <span>Show Details</span>
            </div>
          </div>

          <!-- Card stages: tiny chips row -->
          <div class="card-stages always-visible">
            <div class="stages-chips">
              <ng-container *ngFor="let stage of stages">
                <div class="stage-chip" [ngClass]="stageClass(stage.stageName)">
                  <span class="stage-chip__label">{{ stage.stageName }}</span>
                  <span class="stage-chip__count">
                    {{ getKanbanCount(stage.stageName, campaign.Kanban) }}
                  </span>
                </div>
              </ng-container>
            </div>
          </div>
        </div>
      </ng-container>
    </div>

    <!-- Original Table View -->
    <div class="table-responsive" *ngIf="viewMode === 'table'">
      <div class="table-inner">
        <table class="table align-middle">
          <thead>
            <tr>
              <th class="col-name">Campaign Name</th>
              <th class="col-emily">Emily</th>
              <th class="col-sites">Sites</th>
              <th class="col-submissions">Submissions</th>
              <th class="col-sent">Sent</th>
              <ng-container *ngFor="let stage of stages">
                <th scope="col" class="col-stage">
                  {{ stage.stageName }}
                </th>
              </ng-container>
            </tr>
          </thead>
          <tbody>
            <ng-container
              *ngFor="let campaign of filteredCampaigns; let index = index"
            >
              <tr>
                <td class="col-name">
                  <div class="campaign-info">
                    <div
                      class="campaign-name"
                      [routerLink]="[
                        '/dashboard',
                        campaign.OrganizationId,
                        campaign.OrganizationName,
                        campaign.Id
                      ]"
                    >
                      {{ campaign.CampaignName }} /
                      {{ campaign.OrganizationName }}
                    </div>
                    <div
                      class="date justify-content-between gap-1 w-100"
                      style="display: flex; align-items: center"
                    >
                      {{ (campaign.CreatedDate | date : "MMM d, y") ?? "N/A" }}
                      <div
                        class="campaign-privacy"
                        [ngClass]="{
                          'campaign-privacy-public':
                            campaign.CampaignPrivacy == 0,
                          'campaign-privacy-private':
                            campaign.CampaignPrivacy == 1
                        }"
                      >
                        <div class="campaign-privacy-icon"></div>
                        <span>
                          {{
                            campaign.CampaignPrivacy == 0 ? "Public" : "Private"
                          }}
                        </span>
                      </div>
                    </div>
                  </div>
                </td>

                <td class="col-emily">
                  <div
                    class="inbox mail"
                    [routerLink]="[
                      '/organization-mail',
                      campaign.OrganizationId,
                      campaign.Id
                    ]"
                  >
                    <i class="fa-regular fa-envelope"></i>
                  </div>
                </td>

                <td class="col-sites">
                  <div class="sites-info">
                    <div>{{ campaign.Sites }}</div>
                    <svg
                      [routerLink]="[
                        '/dashboard',
                        campaign.OrganizationId,
                        campaign.OrganizationName,
                        campaign.Id
                      ]"
                      class="external-link-icon"
                      xmlns="http://www.w3.org/2000/svg"
                      width="18"
                      height="18"
                      viewBox="0 0 24 24"
                      fill="none"
                    >
                      <path
                        d="M12.9999 11.75C12.8099 11.75 12.6199 11.68 12.4699 11.53C12.1799 11.24 12.1799 10.76 12.4699 10.47L20.6699 2.26999C20.9599 1.97999 21.4399 1.97999 21.7299 2.26999C22.0199 2.55999 22.0199 3.03999 21.7299 3.32999L13.5299 11.53C13.3799 11.68 13.1899 11.75 12.9999 11.75Z"
                        fill="currentColor"
                      />
                      <path
                        d="M22 7.55C21.59 7.55 21.25 7.21 21.25 6.8V2.75H17.2C16.79 2.75 16.45 2.41 16.45 2C16.45 1.59 16.79 1.25 17.2 1.25H22C22.41 1.25 22.75 1.59 22.75 2V6.8C22.75 7.21 22.41 7.55 22 7.55Z"
                        fill="currentColor"
                      />
                      <path
                        d="M15 22.75H9C3.57 22.75 1.25 20.43 1.25 15V9C1.25 3.57 3.57 1.25 9 1.25H11C11.41 1.25 11.75 1.59 11.75 2C11.75 2.41 11.41 2.75 11 2.75H9C4.39 2.75 2.75 4.39 2.75 9V15C2.75 19.61 4.39 21.25 9 21.25H15C19.61 21.25 21.25 19.61 21.25 15V13C21.25 12.59 21.59 12.25 22 12.25C22.41 12.25 22.75 12.59 22.75 13V15C22.75 20.43 20.43 22.75 15 22.75Z"
                        fill="currentColor"
                      />
                    </svg>
                  </div>
                </td>

                <td class="col-submissions">
                  <div class="submissions-info">
                    <div *ngIf="campaign.Submissions" class="submission-counts">
                      <span class="count-new">{{
                        getSubmissionsCountNew(campaign.Submissions)
                      }}</span>
                      <span class="separator">|</span>
                      <span class="count-accepted">{{
                        getSumbmissionsCountAcceppted(campaign.Submissions)
                      }}</span>
                      <span class="separator">|</span>
                      <span class="count-rejected">{{
                        getSumbmissionsCountRejected(campaign.Submissions)
                      }}</span>
                    </div>
                    <div *ngIf="!campaign.Submissions" class="no-data">N/A</div>
                  </div>
                </td>

                <td class="col-sent">
                  <ng-container *ngIf="campaign.MailsSent">
                    {{ campaign.MailsSent }}</ng-container
                  >
                </td>

                <ng-container *ngFor="let stage of stages">
                  <td class="col-stage">
                    <div class="stage-count">
                      {{ getKanbanCount(stage.stageName, campaign.Kanban) }}
                    </div>
                  </td>
                </ng-container>
              </tr>
            </ng-container>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div
    *ngIf="!isLoading && !(filteredCampaigns && filteredCampaigns.length > 0)"
    class="empty-campaigns"
  >
    <img
      loading="lazy"
      src="../../../assets/Images/empty-state.png"
      alt="Empty Campaigns"
    />
    <h4>Campaigns Will Appear Here!</h4>
    <p>Create, Track, and Manage Expansion Campaigns Here.</p>
  </div>
</div>

<ng-template #content let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Add Campaign</h4>
    <button
      type="button"
      class="btn-close"
      aria-label="Close"
      (click)="modal.dismiss('Cross click')"
    ></button>
  </div>
  <div class="modal-body">
    <div class="campaign-drawing-component">
      <app-campaign-drawing
        [userBuyBoxes]="userBuyBoxes"
        (onCampaignCreated)="onCampaignCreated()"
      ></app-campaign-drawing>
    </div>
  </div>
</ng-template>
