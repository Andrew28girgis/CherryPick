<ngx-spinner type="ball-scale-multiple"></ngx-spinner>

<div class="campaign-manager-container container-fluid">
  <div class="title-div">
    <h2 class="title">Campaigns</h2>
  </div>

  <div
    class="w-100 d-flex align-items-center justify-content-end"
    style="padding-block: 21px;"
  >
    <div
      class="d-flex align-items-center gap-3 toggle-cont justify-content-between w-100"
      *ngIf="!hideViewToggles"
    >
      <!-- Organization Tabs -->
      <div
        *ngIf="filteredCampaigns?.length"
        class="organization-tabs-container"
      >
        <div
          class="organization-tab"
          [class.active]="selectedOrganizationId === 'all'"
          (click)="filterByOrganization('all')"
        >
          All
        </div>

        <div
          class="organization-tab"
          *ngFor="let org of organizations"
          [class.active]="selectedOrganizationId === org.id"
          (click)="filterByOrganization(org.id)"
        >
          <!-- <img
            *ngIf="org.logo; else logoPlaceholder"
            [src]="org.logo"
            class="org-c-logo"
          /> -->

          <ng-container *ngIf="org.logo; else logoPlaceholder">
            <img
              [src]="org.logo"
              class="org-c-logo"
              #logoImg
              crossorigin="anonymous"
            />
          </ng-container>
          <ng-template #logoPlaceholder>
            <div class="org-logo org-c-logo placeholder">
              {{ getInitials(org.name) }}
            </div>
          </ng-template>
          {{ org.name }}
        </div>
      </div>
      <div class="d-flex align-items-center gap-3 flex-row">
        <div class="view-toggle" *ngIf="true">
          <button
            class="toggle-btn"
            [class.active]="viewMode === 'table'"
            (click)="toggleView('table')"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="3" y1="9" x2="21" y2="9"></line>
              <line x1="3" y1="15" x2="21" y2="15"></line>
              <line x1="9" y1="3" x2="9" y2="21"></line>
              <line x1="15" y1="3" x2="15" y2="21"></line>
            </svg>
          </button>
          <button
            class="toggle-btn"
            [class.active]="viewMode === 'card'"
            (click)="toggleView('card')"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <rect x="3" y="3" width="7" height="7"></rect>
              <rect x="14" y="3" width="7" height="7"></rect>
              <rect x="14" y="14" width="7" height="7"></rect>
              <rect x="3" y="14" width="7" height="7"></rect>
            </svg>
          </button>
        </div>
        <button class="g-button" (click)="openAddCampaign(addCampaign)">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 20 20"
            fill="none"
          >
            <path
              d="M10.0001 18.3333C14.5834 18.3333 18.3334 14.5833 18.3334 9.99996C18.3334 5.41663 14.5834 1.66663 10.0001 1.66663C5.41675 1.66663 1.66675 5.41663 1.66675 9.99996C1.66675 14.5833 5.41675 18.3333 10.0001 18.3333Z"
              stroke="white"
              stroke-width="1.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
            <path
              d="M6.66675 10H13.3334"
              stroke="white"
              stroke-width="1.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
            <path
              d="M10 13.3333V6.66663"
              stroke="white"
              stroke-width="1.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          <span>Add Campaign</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Skeleton loading for Card View -->
  <!-- <div class="campaign-manager-body" *ngIf="isLoading && viewMode === 'card'">
    <div class="dashboard-cards-container">
      <div
        class="dashboard-card skeleton-card"
        *ngFor="let i of skeletonCardArray"
      >
        <div class="card-header">
          <div class="skeleton-title"></div>
          <div class="skeleton-privacy"></div>
        </div>
        <div class="card-organization">
          <div class="skeleton-logo"></div>
          <div class="skeleton-tenant-name"></div>
        </div>
        <div class="card-metrics">
          <div class="metric-item">
            <div class="skeleton-stat-value"></div>
            <div class="skeleton-stat-label"></div>
          </div>
          <div class="metric-item">
            <div class="skeleton-stat-value"></div>
            <div class="skeleton-stat-label"></div>
          </div>
          <div class="metric-item">
            <div class="skeleton-stat-value"></div>
            <div class="skeleton-stat-label"></div>
          </div>
        </div>
        <div class="card-actions">
          <div class="skeleton-button"></div>
          <div class="skeleton-button"></div>
        </div>
      </div>
    </div>
  </div> -->

  <!-- Skeleton loading for Table View -->
  <!-- <div class="campaign-manager-body" *ngIf="isLoading && viewMode === 'table'">
    <div class="table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th style="width: 250px">Campaign Name</th>
            <th style="width: 80px; text-align: center">Emily</th>
            <th style="width: 120px; text-align: center">Date</th>
            <th style="width: 100px; text-align: center">Privacy</th>
            <th style="width: 80px; text-align: center">Sites</th>
            <th style="width: 120px; text-align: center">Submissions</th>
            <th style="width: 80px; text-align: center">Sent</th>
            <ng-container *ngFor="let stage of stages">
              <th scope="col" style="width: 100px; text-align: center">
                {{ stage.stageName }}
              </th>
            </ng-container>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let i of skeletonTableArray">
            <td style="width: 250px">
              <div class="skeleton-campaign-name"></div>
              <div class="d-flex align-items-center gap-2 mt-2">
                <div class="skeleton-logo"></div>
                <div class="skeleton-tenant-name"></div>
              </div>
            </td>
            <td style="text-align: center">
              <div class="skeleton-date-cell"></div>
            </td>
            <td style="text-align: center">
              <div class="skeleton-privacy-cell"></div>
            </td>
            <td style="text-align: center">
              <div class="skeleton-sites-cell"></div>
            </td>
            <td style="text-align: center">
              <div class="skeleton-submissions-cell"></div>
            </td>
            <td style="text-align: center">
              <div class="skeleton-sent-cell"></div>
            </td>
            <td style="text-align: center">
              <div class="skeleton-actions-cell"></div>
            </td>
            <ng-container *ngFor="let j of skeletonStagesArray">
              <td style="text-align: center">
                <div class="skeleton-stage-cell"></div>
              </td>
            </ng-container>
          </tr>
        </tbody>
      </table>
    </div>
  </div> -->

  <!-- Actual content -->
  <div
    *ngIf="
      filteredCampaigns && filteredCampaigns.length > 0 && stages.length > 0
    "
    class="campaign-manager-body"
  >
    <!-- Updated card view to dashboard cards layout -->
    <div class="dashboard-cards-container" *ngIf="viewMode === 'card'">
      <ng-container
        *ngFor="let campaign of filteredCampaigns; let index = index"
      >
        <div
          class="dashboard-card"
          [class.click-disabled]="openMenuId === campaign.Id"
          [class.changed]="campaign.changed"
        >
          <div class="card-overlay">
            <div class="menu-wrapper" (click)="$event.stopPropagation()">
              <button
                class="menu-btn"
                (click)="toggleMenu(campaign.Id, $event)"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 20 20"
                  fill="none"
                >
                  <path
                    d="M4.16699 8.20801C5.15737 8.20818 5.95801 9.00958 5.95801 10C5.95783 10.9903 5.15726 11.7908 4.16699 11.791C3.17658 11.791 2.37518 10.9904 2.375 10C2.375 9.00948 3.17647 8.20801 4.16699 8.20801ZM4.16699 8.45801C3.31585 8.45801 2.625 9.14886 2.625 10C2.62518 10.851 3.31596 11.541 4.16699 11.541C5.01788 11.5408 5.70783 10.8509 5.70801 10C5.70801 9.14897 5.01799 8.45818 4.16699 8.45801Z"
                    fill="#18171F"
                    stroke="#18171F"
                  />
                  <path
                    d="M15.8334 12.2913C14.5667 12.2913 13.5417 11.2663 13.5417 9.99967C13.5417 8.73301 14.5667 7.70801 15.8334 7.70801C17.1001 7.70801 18.1251 8.73301 18.1251 9.99967C18.1251 11.2663 17.1001 12.2913 15.8334 12.2913ZM15.8334 8.95801C15.2584 8.95801 14.7917 9.42467 14.7917 9.99967C14.7917 10.5747 15.2584 11.0413 15.8334 11.0413C16.4084 11.0413 16.8751 10.5747 16.8751 9.99967C16.8751 9.42467 16.4084 8.95801 15.8334 8.95801Z"
                    fill="#18171F"
                  />
                  <path
                    d="M9.99992 12.2913C8.73325 12.2913 7.70825 11.2663 7.70825 9.99967C7.70825 8.73301 8.73325 7.70801 9.99992 7.70801C11.2666 7.70801 12.2916 8.73301 12.2916 9.99967C12.2916 11.2663 11.2666 12.2913 9.99992 12.2913ZM9.99992 8.95801C9.42492 8.95801 8.95825 9.42467 8.95825 9.99967C8.95825 10.5747 9.42492 11.0413 9.99992 11.0413C10.5749 11.0413 11.0416 10.5747 11.0416 9.99967C11.0416 9.42467 10.5749 8.95801 9.99992 8.95801Z"
                    fill="#18171F"
                  />
                </svg>
              </button>

              <!-- DROPDOWN -->
              <div class="menu-dropdown" *ngIf="openMenuId === campaign.Id">
                <button
                  class="menu-item"
                  (click)="viewSpecsNew(campaign); closeMenu()"
                >
                  View Specs
                </button>
                <button
                  class="menu-item"
                  (click)="deleteCampaign(campaign.Id); closeMenu()"
                >
                  Delete Campaign
                </button>
                <!-- <button
                  class="menu-item"
                  (click)="editCampaign(campaign); closeMenu()"
                >
                  Edit Campaign
                </button> -->
              </div>
            </div>
            <div
              class="click-shield"
              *ngIf="openMenuId === campaign.Id"
              (click)="closeMenu()"
            ></div>
          </div>

          <div
            class="card-badge date-flag"
            [attr.aria-label]="campaign.CreatedDate | date : 'MMMM d, y'"
          >
            <span class="date-flag__day">{{
              campaign.CreatedDate | date : "d"
            }}</span>
            <span class="date-flag__mon">{{
              campaign.CreatedDate | date : "MMM"
            }}</span>
          </div>

          <div class="card-header">
            <div class="campaign-title-section">
              <a
                class="title-with-logo"
                [ngClass]="{ 'title-hover': campaign.Sites }"
                [routerLink]="
                  campaign.Sites
                    ? [
                        '/dashboard',
                        campaign.OrganizationId,
                        campaign.OrganizationName,
                        campaign.Id
                      ]
                    : null
                "
              >
                <!-- Logo or placeholder -->
                <ng-container *ngIf="campaign.LogoUrl; else logoPlaceholder">
                  <img
                    [src]="campaign.LogoUrl"
                    class="org-logo"
                    #logoImg
                    crossorigin="anonymous"
                  />
                </ng-container>
                <ng-template #logoPlaceholder>
                  <div class="org-logo placeholder">
                    {{ getInitials(campaign.CampaignName) }}
                  </div>
                </ng-template>

                <!-- Text block -->
                <div class="title-text">
                  <div class="campaign-title">{{ campaign.CampaignName }}</div>
                  <div class="organization-name">
                    {{ campaign.OrganizationName }}
                  </div>
                </div>
              </a>
            </div>

            <!-- <div
              class="privacy-badge"
              [ngClass]="{
                'privacy-public': campaign.CampaignPrivacy == 0,
                'privacy-private': campaign.CampaignPrivacy == 1
              }"
            >
              <div class="privacy-icon"></div>
              <span>{{
                campaign.CampaignPrivacy == 0 ? "Public" : "Private"
              }}</span>
            </div> -->
          </div>

          <div class="card-metrics">
            <div
              class="metric-item"
              [ngClass]="{ link: campaign.Sites }"
              [routerLink]="
                campaign.Sites > 0
                  ? [
                      '/dashboard',
                      campaign.OrganizationId,
                      campaign.OrganizationName,
                      campaign.Id
                    ]
                  : null
              "
            >
              <div class="metric-value" [class.changed]="campaign.changed">
                <span>{{ campaign.Sites }}</span>
                <svg
                  *ngIf="campaign.Sites"
                  class="external-icon"
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                >
                  <path
                    d="M12.9999 11.75C12.8099 11.75 12.6199 11.68 12.4699 11.53C12.1799 11.24 12.1799 10.76 12.4699 10.47L20.6699 2.26999C20.9599 1.97999 21.4399 1.97999 21.7299 2.26999C22.0199 2.55999 22.0199 3.03999 21.7299 3.32999L13.5299 11.53C13.3799 11.68 13.1899 11.75 12.9999 11.75Z"
                    fill="currentColor"
                  />
                  <path
                    d="M22 7.55C21.59 7.55 21.25 7.21 21.25 6.8V2.75H17.2C16.79 2.75 16.45 2.41 16.45 2C16.45 1.59 16.79 1.25 17.2 1.25H22C22.41 1.25 22.75 1.59 22.75 2V6.8C22.75 7.21 22.41 7.55 22 7.55Z"
                    fill="currentColor"
                  />
                  <path
                    d="M15 22.75H9C3.57 22.75 1.25 20.43 1.25 15V9C1.25 3.57 3.57 1.25 9 1.25H11C11.41 1.25 11.75 1.59 11.75 2C11.75 2.41 11.41 2.75 11 2.75H9C4.39 2.75 2.75 4.39 2.75 9V15C2.75 19.61 4.39 21.25 9 21.25H15C19.61 21.25 21.25 19.61 21.25 15V13C21.25 12.59 21.59 12.25 22 12.25C22.41 12.25 22.75 12.59 22.75 13V15C22.75 20.43 20.43 22.75 15 22.75Z"
                    fill="currentColor"
                  />
                </svg>
              </div>
              <div class="metric-label">Sites</div>
            </div>

            <div class="metric-item">
              <div
                class="metric-value submissions-breakdown"
                *ngIf="campaign.Submissions"
              >
                <span *ngIf="campaign.Submissions" class="count-new">{{
                  getSubmissionsCountNew(campaign.Submissions)
                }}</span>

                <span class="separator">|</span>
                <span class="count-accepted">{{
                  getSumbmissionsCountAcceppted(campaign.Submissions)
                }}</span>
                <span class="separator">|</span>
                <span class="count-rejected">{{
                  getSumbmissionsCountRejected(campaign.Submissions)
                }}</span>
              </div>
              <div class="metric-value" *ngIf="!campaign.Submissions">0</div>
              <div class="metric-label">Submissions</div>
            </div>

            <div class="metric-item">
              <div class="metric-value">{{ campaign.MailsSent || "0" }}</div>
              <div class="metric-label">Mails Sent</div>
            </div>
          </div>

          <div class="card-actions">
            <div
              class="email-action"
              [routerLink]="[
                '/organization-mail',
                campaign.OrganizationId,
                campaign.Id
              ]"
            >
              <i class="fa-regular fa-envelope"></i>
              <span>Emily</span>
            </div>
            <div
              *ngIf="campaign.Sites"
              class="email-action show-details"
              [routerLink]="[
                '/dashboard',
                campaign.OrganizationId,
                campaign.OrganizationName,
                campaign.Id
              ]"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
              >
                <path
                  d="M15.5799 11.9999C15.5799 13.9799 13.9799 15.5799 11.9999 15.5799C10.0199 15.5799 8.41992 13.9799 8.41992 11.9999C8.41992 10.0199 10.0199 8.41992 11.9999 8.41992C13.9799 8.41992 15.5799 10.0199 15.5799 11.9999Z"
                  stroke="#fff"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M11.9998 20.2702C15.5298 20.2702 18.8198 18.1902 21.1098 14.5902C22.0098 13.1802 22.0098 10.8102 21.1098 9.40021C18.8198 5.80021 15.5298 3.72021 11.9998 3.72021C8.46984 3.72021 5.17984 5.80021 2.88984 9.40021C1.98984 10.8102 1.98984 13.1802 2.88984 14.5902C5.17984 18.1902 8.46984 20.2702 11.9998 20.2702Z"
                  stroke="#fff"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              <span>Show Details</span>
            </div>
          </div>

          <!-- Card stages: tiny chips row -->
          <div class="card-stages always-visible">
            <div class="stages-chips">
              <ng-container *ngFor="let stage of stages">
                <div class="stage-chip" [ngClass]="stageClass(stage.stageName)">
                  <span class="stage-chip__label">{{ stage.stageName }}</span>
                  <span class="stage-chip__count">
                    {{ getKanbanCount(stage.stageName, campaign.Kanban) }}
                  </span>
                </div>
              </ng-container>
            </div>
          </div>
        </div>
      </ng-container>
    </div>

    <!-- Original Table View -->
    <div class="table-responsive" *ngIf="viewMode === 'table'">
      <div class="table-inner">
        <table class="table align-middle">
          <thead>
            <tr>
              <th class="col-name">Name</th>
              <th class="col-emily">Emily</th>
              <th class="col-sites">Sites</th>
              <th class="col-submissions">Submissions</th>
              <th class="col-sent">Sent</th>
              <ng-container *ngFor="let stage of stages">
                <th scope="col" class="col-stage">
                  {{ stage.stageName }}
                </th>
              </ng-container>
            </tr>
          </thead>
          <tbody>
            <ng-container
              *ngFor="let campaign of filteredCampaigns; let index = index"
            >
              <tr>
                <td class="col-name">
                  <div class="campaign-info">
                    <div
                      class="campaign-name"
                      [routerLink]="[
                        '/dashboard',
                        campaign.OrganizationId,
                        campaign.OrganizationName,
                        campaign.Id
                      ]"
                    >
                      {{ campaign.CampaignName }} /
                      {{ campaign.OrganizationName }}
                    </div>
                    <div
                      class="date justify-content-between gap-1 w-100"
                      style="display: flex; align-items: center"
                    >
                      {{ (campaign.CreatedDate | date : "MMM d, y") ?? "N/A" }}
                      <button
                        class="menu-btn"
                        (click)="toggleMenu(campaign.Id, $event)"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="20"
                          height="20"
                          viewBox="0 0 20 20"
                          fill="none"
                        >
                          <path
                            d="M4.16699 8.20801C5.15737 8.20818 5.95801 9.00958 5.95801 10C5.95783 10.9903 5.15726 11.7908 4.16699 11.791C3.17658 11.791 2.37518 10.9904 2.375 10C2.375 9.00948 3.17647 8.20801 4.16699 8.20801ZM4.16699 8.45801C3.31585 8.45801 2.625 9.14886 2.625 10C2.62518 10.851 3.31596 11.541 4.16699 11.541C5.01788 11.5408 5.70783 10.8509 5.70801 10C5.70801 9.14897 5.01799 8.45818 4.16699 8.45801Z"
                            fill="#18171F"
                            stroke="#18171F"
                          />
                          <path
                            d="M15.8334 12.2913C14.5667 12.2913 13.5417 11.2663 13.5417 9.99967C13.5417 8.73301 14.5667 7.70801 15.8334 7.70801C17.1001 7.70801 18.1251 8.73301 18.1251 9.99967C18.1251 11.2663 17.1001 12.2913 15.8334 12.2913ZM15.8334 8.95801C15.2584 8.95801 14.7917 9.42467 14.7917 9.99967C14.7917 10.5747 15.2584 11.0413 15.8334 11.0413C16.4084 11.0413 16.8751 10.5747 16.8751 9.99967C16.8751 9.42467 16.4084 8.95801 15.8334 8.95801Z"
                            fill="#18171F"
                          />
                          <path
                            d="M9.99992 12.2913C8.73325 12.2913 7.70825 11.2663 7.70825 9.99967C7.70825 8.73301 8.73325 7.70801 9.99992 7.70801C11.2666 7.70801 12.2916 8.73301 12.2916 9.99967C12.2916 11.2663 11.2666 12.2913 9.99992 12.2913ZM9.99992 8.95801C9.42492 8.95801 8.95825 9.42467 8.95825 9.99967C8.95825 10.5747 9.42492 11.0413 9.99992 11.0413C10.5749 11.0413 11.0416 10.5747 11.0416 9.99967C11.0416 9.42467 10.5749 8.95801 9.99992 8.95801Z"
                            fill="#18171F"
                          />
                        </svg>
                      </button>

                      <!-- DROPDOWN -->
                      <div
                        class="menu-dropdown"
                        style="top: 20vh; right: 44vw;z-index: 1;"
                        *ngIf="openMenuId === campaign.Id"
                      >
                        <button
                          class="menu-item"
                          (click)="viewSpecsNew(campaign); closeMenu()"
                        >
                          View Specs
                        </button>
                        <button
                          class="menu-item"
                          (click)="deleteCampaign(campaign.Id); closeMenu()"
                        >
                          Delete Campaign
                        </button>
                        <!-- <button
                          class="menu-item"
                          (click)="editCampaign(campaign); closeMenu()"
                        >
                          Edit Campaign
                        </button> -->
                      </div>
                      <div
                        class="campaign-privacy"
                        [ngClass]="{
                          'campaign-privacy-public':
                            campaign.CampaignPrivacy == 0,
                          'campaign-privacy-private':
                            campaign.CampaignPrivacy == 1
                        }"
                      >
                        <div class="campaign-privacy-icon"></div>
                        <span>
                          {{
                            campaign.CampaignPrivacy == 0 ? "Public" : "Private"
                          }}
                        </span>
                      </div>
                    </div>
                  </div>
                </td>

                <td class="col-emily">
                  <div
                    class="inbox mail"
                    [routerLink]="[
                      '/organization-mail',
                      campaign.OrganizationId,
                      campaign.Id
                    ]"
                  >
                    <i class="fa-regular fa-envelope"></i>
                  </div>
                </td>

                <td class="col-sites">
                  <div class="sites-info">
                    <div>{{ campaign.Sites }}</div>
                    <svg
                      [routerLink]="[
                        '/dashboard',
                        campaign.OrganizationId,
                        campaign.OrganizationName,
                        campaign.Id
                      ]"
                      class="external-link-icon"
                      xmlns="http://www.w3.org/2000/svg"
                      width="18"
                      height="18"
                      viewBox="0 0 24 24"
                      fill="none"
                    >
                      <path
                        d="M12.9999 11.75C12.8099 11.75 12.6199 11.68 12.4699 11.53C12.1799 11.24 12.1799 10.76 12.4699 10.47L20.6699 2.26999C20.9599 1.97999 21.4399 1.97999 21.7299 2.26999C22.0199 2.55999 22.0199 3.03999 21.7299 3.32999L13.5299 11.53C13.3799 11.68 13.1899 11.75 12.9999 11.75Z"
                        fill="currentColor"
                      />
                      <path
                        d="M22 7.55C21.59 7.55 21.25 7.21 21.25 6.8V2.75H17.2C16.79 2.75 16.45 2.41 16.45 2C16.45 1.59 16.79 1.25 17.2 1.25H22C22.41 1.25 22.75 1.59 22.75 2V6.8C22.75 7.21 22.41 7.55 22 7.55Z"
                        fill="currentColor"
                      />
                      <path
                        d="M15 22.75H9C3.57 22.75 1.25 20.43 1.25 15V9C1.25 3.57 3.57 1.25 9 1.25H11C11.41 1.25 11.75 1.59 11.75 2C11.75 2.41 11.41 2.75 11 2.75H9C4.39 2.75 2.75 4.39 2.75 9V15C2.75 19.61 4.39 21.25 9 21.25H15C19.61 21.25 21.25 19.61 21.25 15V13C21.25 12.59 21.59 12.25 22 12.25C22.41 12.25 22.75 12.59 22.75 13V15C22.75 20.43 20.43 22.75 15 22.75Z"
                        fill="currentColor"
                      />
                    </svg>
                  </div>
                </td>

                <td class="col-submissions">
                  <div class="submissions-info">
                    <div *ngIf="campaign.Submissions" class="submission-counts">
                      <span class="count-new">{{
                        getSubmissionsCountNew(campaign.Submissions)
                      }}</span>
                      <span class="separator">|</span>
                      <span class="count-accepted">{{
                        getSumbmissionsCountAcceppted(campaign.Submissions)
                      }}</span>
                      <span class="separator">|</span>
                      <span class="count-rejected">{{
                        getSumbmissionsCountRejected(campaign.Submissions)
                      }}</span>
                    </div>
                    <div *ngIf="!campaign.Submissions" class="no-data">N/A</div>
                  </div>
                </td>

                <td class="col-sent">
                  <ng-container *ngIf="campaign.MailsSent">
                    {{ campaign.MailsSent }}</ng-container
                  >
                </td>

                <ng-container *ngFor="let stage of stages">
                  <td class="col-stage">
                    <div class="stage-count">
                      {{ getKanbanCount(stage.stageName, campaign.Kanban) }}
                    </div>
                  </td>
                </ng-container>
              </tr>
            </ng-container>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div
    *ngIf="!(filteredCampaigns && filteredCampaigns.length > 0)"
    class="empty-campaigns"
  >
    <h4>Campaigns Will Appear Here!</h4>
    <p>Create, Track, and Manage Expansion Campaigns Here.</p>
  </div>
</div>

<ng-template #content let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Add Campaign</h4>
    <button
      type="button"
      class="btn-close"
      aria-label="Close"
      (click)="modal.dismiss('Cross click')"
    ></button>
  </div>
  <div class="modal-body">
    <div class="campaign-drawing-component">
      <app-campaign-drawing
        [userBuyBoxes]="userBuyBoxes"
        (onCampaignCreated)="onCampaignCreated()"
      ></app-campaign-drawing>
    </div>
  </div>
</ng-template>

<ng-template #addCampaign let-modal>
  <div class="modal-header d-flex justify-content-between align-items-center">
    <h4 class="modal-title mb-0">Add Campaign</h4>

    <div class="selected-tenant-header mx-3" *ngIf="selectedTenant">
      <ng-container *ngIf="selectedTenant.logoUrl; else logoPlaceholder">
        <img
          [src]="selectedTenant.logoUrl"
          class="tenant-logop"
          crossorigin="anonymous"
        />
      </ng-container>
      <ng-template #logoPlaceholder>
        <div class="tenant-logop placeholder">
          {{ getInitials(selectedTenant.name) }}
        </div>
      </ng-template>

      <span class="tenant-name">
        {{ selectedTenant.name }}
      </span>
    </div>

    <button
      type="button"
      class="btn-close d-flex align-items-center justify-content-center"
      aria-label="Close"
      (click)="modal.dismiss()"
    >
      <i class="fa-solid fa-xmark"></i>
    </button>
  </div>

  <div class="modal-body">
    <!-- Stepper + Finish button inline -->
    <div
      class="stepper-container d-flex justify-content-between align-items-center mb-2 gap-2"
    >
      <!-- Stepper -->
      <div class="stepper d-flex align-items-center">
        <div class="step" [class.active]="step === 'tenant'">Select Tenant</div>
        <div class="step-line"></div>
        <div class="step" [class.active]="step === 'campaign'">
          Campaign Details
        </div>
        <div class="step-line"></div>
        <div class="step" [class.active]="step === 'polygon'">Locations</div>
      </div>

      <!-- Finish button -->
      <div>
        <button
          *ngIf="step === 'polygon'"
          class="btn btn-primary next-btn"
          (click)="finish()"
        >
          Finish
        </button>
      </div>
    </div>

    <div
      *ngIf="TenantStepLoad"
      class="d-flex justify-content-center align-items-center p-5"
    >
      <div class="spinner-border custom-spinner" role="status">
        <span class="visually-hidden">Loading tenants...</span>
      </div>
    </div>
    <!-- Step 1: Tenants -->
    <div *ngIf="!TenantStepLoad && step === 'tenant'">
      <div class="tenant-cards-grid">
        <div
          *ngFor="let tenant of tenants"
          class="tenant-card"
          [class.selected]="selectedTenant === tenant"
          (click)="selectTenant(tenant)"
        >
          <!-- logo + name -->
          <div class="tenant-header">
            <ng-container *ngIf="tenant.logoUrl; else logoPlaceholder">
              <img
                [src]="tenant.logoUrl"
                class="tenant-logo"
                crossorigin="anonymous"
              />
            </ng-container>
            <ng-template #logoPlaceholder>
              <div class="tenant-logo placeholder">
                {{ getInitials(tenant.OrganizationName || tenant.name) }}
              </div>
            </ng-template>
            <h3 class="tenant-name">
              {{ tenant.OrganizationName || tenant.name }}
            </h3>
          </div>

          <!-- selection mark -->
          <div class="tenant-check" *ngIf="selectedTenant === tenant">âœ“</div>
        </div>
        <div
          class="tenant-card add-card"
          (click)="openAddTenantModal(tenantModal)"
        >
          <div class="add-card-content">
            <div class="plus-icon">+</div>
            <h3 class="tenant-name">Add Tenant</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 2: Campaign Details -->
    <div *ngIf="step === 'campaign'" class="campaign-step">
      <!-- Left side: Campaign name -->
      <div class="left">
        <label for="campaignName" class="form-label">Campaign Name</label>
        <input
          id="campaignName"
          type="text"
          class="form-control"
          [(ngModel)]="campaignName"
          placeholder="Enter campaign name"
        />
      </div>

      <!-- Right side: Campaign type -->
      <div class="right">
        <label class="form-label">Campaign Type</label>
        <div class="type-options">
          <div
            class="type-option"
            [class.active]="campaignType === 'standalone'"
            (click)="campaignType = 'standalone'"
          >
            <i class="fa-solid fa-store"></i>
            <span>Standalone Only</span>
          </div>

          <div
            class="type-option"
            [class.active]="campaignType === 'standaloneShopping'"
            (click)="campaignType = 'standaloneShopping'"
          >
            <i class="fa-solid fa-shop"></i>
            <span>Standalone + Shopping Center</span>
          </div>
        </div>
      </div>
      <!-- Unit Size Selection -->
      <div class="unit-size-section">
        <label class="form-label">Unit Size Range (sq ft)</label>

        <div class="d-flex gap-3">
          <div class="flex-grow-1">
            <input
              type="number"
              class="form-control"
              placeholder="Min Unit Size"
              [(ngModel)]="MinUnitSize"
              min="0"
            />
          </div>

          <div class="flex-grow-1">
            <input
              type="number"
              class="form-control"
              placeholder="Max Unit Size"
              [(ngModel)]="MaxUnitSize"
              [min]="MinUnitSize || 0"
            />
          </div>
        </div>

        <!-- Optional small validation message -->
        <div
          class="text-danger mt-1"
          *ngIf="MaxUnitSize && MinUnitSize && MaxUnitSize < MinUnitSize"
        >
          Max unit size cannot be smaller than min unit size.
        </div>
      </div>
      <!-- Tenant Search and Selection -->
      <div class="cotenant-selection">
        <label for="campaignName" class="form-label"
          >Search Complementary and Conflicting Tenants</label
        >
        <input
          type="text"
          class="form-control cotenant-search"
          placeholder="Search tenants..."
          [(ngModel)]="tenantSearch"
          (ngModelChange)="onTenantSearchChange($event)"
        />

        <!-- Tenants list -->
        <div *ngIf="cotenants.length > 0" class="cotenant-cards">
          <div
            class="cotenant-card"
            *ngFor="let tenant of cotenants"
            [ngClass]="{
              'complementary-border': isSelected(tenant, 'complementary'),
              'conflicting-border': isSelected(tenant, 'conflicting')
            }"
          >
            <div
              class="card-badge"
              [ngClass]="{
                'complementary-badge': isSelected(tenant, 'complementary'),
                'conflicting-badge': isSelected(tenant, 'conflicting')
              }"
            >
              <span
                class="complementary"
                *ngIf="isSelected(tenant, 'complementary')"
              >
                Complementary
              </span>
              <span
                class="conflicting"
                *ngIf="isSelected(tenant, 'conflicting')"
              >
                Conflicting
              </span>
            </div>

            <div>
              <img
                *ngIf="tenant.logoURL"
                [src]="tenant.logoURL"
                alt="{{ tenant.name }}"
                class="cotenant-logo"
              />
              <div *ngIf="!tenant.logoURL" class="cotenant-logo-placeholder">
                <i class="fa-solid fa-store"></i>
              </div>

              <div class="cotenant-info">
                <span class="cotenant-name">{{ tenant.name }}</span>
              </div>
            </div>

            <div class="cotenant-buttons">
              <button
                class="btn btn-success btn-sm"
                (click)="addComplementary(tenant)"
              >
                Complementary
              </button>

              <button
                class="btn btn-danger btn-sm"
                (click)="addConflicting(tenant)"
              >
                Conflicting
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 3: Polygons -->
    <div *ngIf="step === 'polygon'">
      <app-polygons
        *ngIf="polygonsStep"
        (saveLocationCriteria)="handleSave($event)"
      >
      </app-polygons>
    </div>
  </div>
  <div class="modal-footer modal-nav-footer">
    <!-- Previous button -->
    <button
      *ngIf="step !== 'tenant'"
      class="btn btn-outline-secondary back-btn"
      (click)="prevStep()"
    >
      Previous
    </button>

    <!-- Next from Tenant -->
    <button
      *ngIf="step === 'tenant'"
      class="btn btn-primary next-btn ms-auto"
      [disabled]="!selectedTenant"
      (click)="nextStep()"
    >
      Next
    </button>

    <!-- Next from Campaign -->
    <button
      *ngIf="step === 'campaign'"
      class="btn btn-primary next-btn ms-auto"
      [disabled]="!campaignName || !campaignType"
      (click)="nextStep()"
    >
      Next
    </button>
  </div>
</ng-template>
<ng-template #tenantModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title" id="modal-basic-title" ngbAutofocus>
      Add New Tenant
    </h5>
    <button
      type="button"
      class="btn-close"
      aria-label="Close"
      (click)="modal.dismiss('Cross click')"
    ></button>
  </div>
  <div class="modal-body" style="height: fit-content !important">
    <form #tenantForm="ngForm">
      <div class="mb-3">
        <label for="name" class="form-label d-flex align-items-center gap-2">
          Name *
          <span
            class="text-danger name-isrequired"
            *ngIf="nameInput.invalid && nameInput.touched"
          >
            required
          </span>
        </label>

        <input
          type="text"
          id="name"
          class="form-control"
          name="name"
          required
          [(ngModel)]="newTenant.name"
          #nameInput="ngModel"
          [ngClass]="{
            'is-invalid': nameInput.invalid && nameInput.touched
          }"
        />
      </div>

      <div class="mb-3">
        <label for="url" class="form-label">URL</label>
        <input
          type="url"
          id="url"
          class="form-control"
          name="url"
          pattern="https?://.+"
          [(ngModel)]="newTenant.url"
          #urlInput="ngModel"
        />
      </div>

      <div class="mb-3">
        <label for="linkedin" class="form-label">LinkedIn</label>
        <input
          type="text"
          id="linkedin"
          class="form-control"
          name="linkedin"
          [(ngModel)]="newTenant.linkedin"
        />
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button
      type="button"
      class="g-button g-button-outline cancel-tenant-btn"
      (click)="modal.close('Save click')"
    >
      <span>Cancel</span>
    </button>

    <button
      class="g-button g-button-primary add-tenant-btn-text"
      [disabled]="tenantForm.invalid"
      (click)="addNewTenant()"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
      >
        <path
          d="M6 12H18M12 18V6"
          stroke="white"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
      </svg>
      <span class="add-tenant-text">Add Tenant</span>
    </button>
  </div>
</ng-template>

<ng-template #campaignDetailsModal let-modal>
  <!-- Modal Header -->
  <div class="modal-header">
    <div class="d-flex align-items-center flex-row gap-2">
      <ng-container *ngIf="campaignLogo; else logoPlaceholder">
        <img
          [src]="campaignLogo"
          class="tenant-logo"
          style="width: 50px; height: 50px"
          crossorigin="anonymous"
        />
      </ng-container>
      <ng-template #logoPlaceholder>
        <div class="tenant-logo placeholder">
          {{ getInitials(selectedCampaignDetails?.CampaignName || "") }}
        </div>
      </ng-template>

      <h4 class="modal-title">
        {{
          isEditing
            ? "Edit Campaign"
            : selectedCampaignDetails?.CampaignName ?? "Campaign"
        }}
      </h4>
    </div>

    <button class="btn btn-primary btn-custom" (click)="modal.close()">
      X
    </button>
  </div>

  <!-- Modal Body -->
  <div class="modal-body popup-body">
    <!-- Campaign Info -->
    <section>
      <h5>Campaign Info</h5>

      <!-- Campaign Name -->
      <div class="form-group sec mb-2">
        <label>Campaign Name:</label>
        <ng-container *ngIf="!isEditing; else editName">
          <div>{{ selectedCampaignDetails?.CampaignName }}</div>
        </ng-container>
        <ng-template #editName>
          <input
            type="text"
            [(ngModel)]="editableCampaign.CampaignName"
            class="form-control form-control-sm"
          />
        </ng-template>
      </div>

      <!-- Organization -->
      <div
        *ngIf="selectedCampaignDetails?.OrganizationName"
        class="form-group sec mb-2"
      >
        <label>Organization:</label>
        <ng-container *ngIf="!isEditing; else editOrg">
          <div>{{ selectedCampaignDetails?.OrganizationName }}</div>
        </ng-container>
        <ng-template #editOrg>
          <input
            type="text"
            [(ngModel)]="editableCampaign.OrganizationName"
            class="form-control form-control-sm"
          />
        </ng-template>
      </div>

      <!-- Standalone -->
      <div
        *ngIf="selectedCampaignDetails?.IsStandAlone ?? false"
        class="form-group sec mb-2"
      >
        <label>Standalone:</label>
        <ng-container *ngIf="!isEditing; else editStandalone">
          <div>{{ selectedCampaignDetails?.IsStandAlone ? "Yes" : "No" }}</div>
        </ng-container>
        <ng-template #editStandalone>
          <input
            type="checkbox"
            [(ngModel)]="editableCampaign.IsStandAlone"
            class="form-check-input ms-2"
          />
        </ng-template>
      </div>

      <!-- Min Unit Size -->
      <div
        *ngIf="selectedCampaignDetails?.MinUnitSize"
        class="form-group sec mb-2"
      >
        <label>Min Unit Size:</label>
        <ng-container *ngIf="!isEditing; else editMin">
          <div>{{ selectedCampaignDetails?.MinUnitSize }}</div>
        </ng-container>
        <ng-template #editMin>
          <input
            type="number"
            [(ngModel)]="editableCampaign.MinUnitSize"
            class="form-control form-control-sm"
          />
        </ng-template>
      </div>

      <!-- Max Unit Size -->
      <div
        *ngIf="selectedCampaignDetails?.MaxUnitSize"
        class="form-group sec mb-2"
      >
        <label>Max Unit Size:</label>
        <ng-container *ngIf="!isEditing; else editMax">
          <div>{{ selectedCampaignDetails?.MaxUnitSize }}</div>
        </ng-container>
        <ng-template #editMax>
          <input
            type="number"
            [(ngModel)]="editableCampaign.MaxUnitSize"
            class="form-control form-control-sm"
          />
        </ng-template>
      </div>

      <!-- Created Date -->
      <div
        *ngIf="selectedCampaignDetails?.CreatedDate"
        class="form-group sec mb-2"
      >
        <label>Created Date:</label>
        <div>{{ selectedCampaignDetails?.CreatedDate | date : "medium" }}</div>
      </div>
    </section>

    <!-- Locations -->
    <section *ngIf="selectedCampaignDetails?.Locations?.length">
      <h5 class="mt-3">Locations</h5>

      <!-- Read Mode -->
      <div *ngIf="!isEditing" class="pills-container">
        <span
          *ngFor="let loc of selectedCampaignDetails.Locations"
          class="data-pill"
        >
          {{ loc.CityName ? loc.CityName + ", " : ""
          }}{{ loc.State ? loc.State : "" }}
        </span>
      </div>

      <!-- Edit Mode -->
      <div *ngIf="isEditing">
        <div
          *ngFor="let loc of editableCampaign.Locations; let i = index"
          class="d-flex gap-2 mb-2"
        >
          <input
            type="text"
            [(ngModel)]="loc.CityName"
            class="form-control form-control-sm"
            placeholder="City"
          />
          <input
            type="text"
            [(ngModel)]="loc.State"
            class="form-control form-control-sm"
            placeholder="State"
          />
        </div>
      </div>
    </section>

    <!-- Relations -->
    <section
      *ngIf="selectedCampaignDetails?.Relations?.length"
      style="height: fit-content"
    >
      <h5 class="mt-3">Relations</h5>

      <!-- Read Mode -->
      <div *ngIf="!isEditing" class="pills-container">
        <span
          *ngFor="let r of selectedCampaignDetails.Relations"
          class="data-pill"
          [ngClass]="{
            'complementary-pill': r.RelationType === 'complementary',
            'conflict-pill': r.RelationType === 'conflict'
          }"
        >
          {{ r.RelationOrganizationName }} ({{ r.RelationType }})
        </span>
      </div>

      <!-- Edit Mode -->
      <div *ngIf="isEditing">
        <div
          *ngFor="let r of editableCampaign.Relations; let i = index"
          class="relation-row"
        >
          <span class="relation-label">
            {{ r.RelationOrganizationName }} ({{ r.RelationType }})
          </span>

          <select [(ngModel)]="r.RelationType" class="relation-select">
            <option value="complementary">complementary</option>
            <option value="conflict">conflict</option>
          </select>
        </div>
      </div>
    </section>

    <!-- Read-Only JSON -->
    <section
      *ngIf="parsedCampaignDetails?.length"
      class="border-top pt-3"
      style="height: fit-content"
    >
      <h5>Campaign Details (JSON)</h5>
      <div class="key-value-list">
        <ng-container *ngFor="let entry of parsedCampaignDetails">
          <div class="key-value-item">
            <div class="key">{{ entry.key }}:</div>
            <div class="value">
              <ng-container *ngIf="isArray(entry.value); else nonArray">
                <div class="nested">
                  <ng-container *ngFor="let item of entry.value">
                    <ng-container *ngIf="isObject(item); else simpleItem">
                      <div class="nested">
                        <ng-container
                          *ngFor="let sub of getKeyValuePairs(item)"
                        >
                          <div class="key-value-item">
                            <div class="key">{{ sub.key }}:</div>
                            <div class="value">{{ sub.value }}</div>
                          </div>
                        </ng-container>
                      </div>
                    </ng-container>
                    <ng-template #simpleItem>
                      <div class="value">{{ item }}</div>
                    </ng-template>
                  </ng-container>
                </div>
              </ng-container>
              <ng-template #nonArray>
                <ng-container *ngIf="isObject(entry.value); else simpleValue">
                  <div class="nested">
                    <ng-container
                      *ngFor="let sub of getKeyValuePairs(entry.value)"
                    >
                      <div class="key-value-item">
                        <div class="key">{{ sub.key }}:</div>
                        <div class="value">{{ sub.value }}</div>
                      </div>
                    </ng-container>
                  </div>
                </ng-container>
                <ng-template #simpleValue>{{ entry.value }}</ng-template>
              </ng-template>
            </div>
          </div>
        </ng-container>
      </div>
    </section>
  </div>

  <!-- Modal Footer -->
  <div class="modal-footer">
    <button *ngIf="!isEditing" class="btn btn-secondary" (click)="startEdit()">
      Edit
    </button>
    <button *ngIf="isEditing" class="btn btn-primary" (click)="saveEdit()">
      Save
    </button>
    <button
      *ngIf="isEditing"
      class="btn btn-outline-secondary"
      (click)="cancelEdit()"
    >
      Cancel
    </button>
  </div>
</ng-template>
