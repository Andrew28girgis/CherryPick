<div class="contact-container">
  <div class="title-div">
    <h2 class="title">Contacts</h2>
  </div>

  <!-- Skeleton Loading State -->
  <div class="skeleton-container" *ngIf="isLoading">
    <div class="skeleton-grid">
      <div class="skeleton-org-card" *ngFor="let i of [1, 2, 3, 4]">
        <div class="skeleton-org-header d-flex align-items-center mb-3">
          <div class="skeleton-org-logo"></div>
          <div class="skeleton-org-title"></div>
        </div>
        <div class="row w-100">
          <div class="col-md-4" *ngFor="let j of [1, 2, 3]">
            <div class="skeleton-contact-card p-3">
              <div class="skeleton-contact-name"></div>
              <div class="skeleton-contact-title"></div>
              <div class="skeleton-contact-detail"></div>
              <div class="skeleton-contact-detail short"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Real Content -->
  <div *ngIf="!isLoading">
    <!-- Header Section (unchanged logic) -->
    <div class="header-container d-flex justify-content-between w-100">
      <div class="switch-tenant">
        <div class="role-toggle" role="tablist" aria-label="Select role">
          <button
            class="role-option"
            [class.active]="role === 'broker'"
            role="tab"
            [attr.aria-selected]="role === 'broker'"
            (click)="setRole('broker')"
          >
            Broker
          </button>
          <button
            class="role-option"
            [class.active]="role === 'tenant'"
            role="tab"
            [attr.aria-selected]="role === 'tenant'"
            (click)="setRole('tenant')"
          >
            Tenant
          </button>
        </div>
      </div>

      <div class="search-con d-flex">
        <div class="search-section">
          <div class="search-container" [class.expanded]="isSearchExpanded">
            <button
              class="search-icon-btn"
              type="button"
              (click)="toggleSearch(searchInput)"
              aria-label="Toggle search"
            >
              <svg
                class="search-icon"
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 20 20"
                fill="none"
              >
                <path
                  d="M9.583 17.5c4.372 0 7.917-3.544 7.917-7.917S13.955 1.667 9.583 1.667 1.667 5.21 1.667 9.583 5.21 17.5 9.583 17.5Z"
                  stroke="#292D32"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M18.333 18.333 16.667 16.667"
                  stroke="#292D32"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </button>

            <input
              #searchInput
              type="text"
              class="search-input"
              placeholder="Search Organizations..."
              [(ngModel)]="searchTerm"
              (input)="onSearch()"
            />
          </div>
        </div>

        <div class="actions-container">
          <div
            class="dropdown-container"
            ngbDropdown
            [container]="'body'"
            placement="bottom-end"
          >
            <button class="sort-btn" ngbDropdownToggle>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="21"
                viewBox="0 0 20 21"
                fill="none"
              >
                <path
                  d="M8.70879 6.09998L5.60876 3L2.50879 6.09998"
                  stroke="#292D32"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M5.6084 18V3"
                  stroke="#292D32"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M11.292 14.8999L14.392 17.9999L17.492 14.8999"
                  stroke="#292D32"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M14.3926 3V18"
                  stroke="#292D32"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </button>

            <div ngbDropdownMenu class="dropdown-menu sort-menu">
              <label class="radio-label">
                <input
                  type="radio"
                  name="sort"
                  value="contacts"
                  [(ngModel)]="sortBy"
                  (change)="onSortChange()"
                />
                <span class="radio-text">Most Contacts</span>
              </label>
              <label class="radio-label">
                <input
                  type="radio"
                  name="sort"
                  value="alphabetical"
                  [(ngModel)]="sortBy"
                  (change)="onSortChange()"
                />
                <span class="radio-text">Alphabetical</span>
              </label>
              <label class="radio-label">
                <input
                  type="radio"
                  name="sort"
                  value="newest"
                  [(ngModel)]="sortBy"
                  (change)="onSortChange()"
                />
                <span class="radio-text">Newest to Oldest</span>
              </label>
              <label class="radio-label">
                <input
                  type="radio"
                  name="sort"
                  value="oldest"
                  [(ngModel)]="sortBy"
                  (change)="onSortChange()"
                />
                <span class="radio-text">Oldest to Newest</span>
              </label>
              <label class="radio-label">
                <input
                  type="radio"
                  name="sort"
                  value="status"
                  [(ngModel)]="sortBy"
                  (change)="onSortChange()"
                />
                <span class="radio-text">Status</span>
              </label>
            </div>
          </div>
        </div>

        <button class="add-new-btn" (click)="onAddNew()">
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
        </button>
      </div>
    </div>

    <!-- Organization Cards -->
    <div class="organization-grid">
      <details
        class="organization-card"
        *ngFor="let org of paginatedContacts"
        [attr.aria-label]="'Organization ' + org.name"
      >
        <!-- Clickable summary (opens/closes) -->
        <summary
          [ngClass]="{ 'org-hover': org.contacts.length > 0 }"
          class="org-summary"
          aria-controls="contacts-panel"
        >
          <!-- Floating contact-count badge -->
          <span
            *ngIf="org.contacts.length > 0"
            class="card-badge"
            aria-label="Contact count"
          >
            <span class="badge-dot"></span>
            {{ org.contacts.length }} Contacts
          </span>
          <div class="tenant-card">
            <!-- <img
              loading="lazy"
              class="logo ms-2"
              src="https://api.cherrypick.com/api/Organization/GetOrgImag?orgId={{
                org.id
              }}"
              [title]="org.name"
              alt=""
              (error)="onImageError($event)"
            /> -->
            <div class="org-logo placeholder">
              {{ getInitials(org.name) }}
            </div>
            <h2 class="organization-title mb-0">{{ org.name }}</h2>
          </div>

          <!-- chevron -->
          <div
            *ngIf="org.contacts.length > 0"
            class="org-chevron"
            aria-hidden="true"
          >
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="#777199"
              stroke-width="2"
            >
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
        </summary>

        <!-- Expandable contacts panel (display via CSS; no logic changed) -->
        <div
          *ngIf="org.contacts.length > 0"
          class="contacts-panel"
          id="contacts-panel"
        >
          <div
            class="row w-100"
            #contactsRow
            (wheel)="onStripWheel($event, contactsRow)"
            *ngIf="org.contacts.length > 0"
          >
            <div class="col-md-4" *ngFor="let contact of org.contacts">
              <div
                class="contact-card"
                 [class.flipped]="contact.flipped"
              >
                <div class="flip-inner">
                  <!-- Front -->
                  <div class="flip-front flex-row d-flex">
                    <div>
                      <h3 class="contact-name">
                        {{ contact.firstName }} {{ contact.lastName }}
                      </h3>
                      <div class="contact-title" *ngIf="contact.jobTitle">
                        {{ contact.jobTitle }}
                      </div>
                      <div class="contact-item" *ngIf="contact.email">
                        <span class="value">{{ contact.email }}</span>
                      </div>
                    </div>
                 
                  </div>

                  <!-- Back -->
                  <!-- <div class="flip-back">
                    <div class="contact-title" *ngIf="contact.jobTitle">
                      {{ contact.jobTitle }}
                    </div>
                    <div class="contact-item" *ngIf="contact.email">
                      <span class="value">{{ contact.email }}</span>
                    </div>
                    <div class="contact-item" *ngIf="contact.cellPhone">
                      <span
                        >Phone:
                        <span class="value">{{ contact.cellPhone }}</span></span
                      >
                    </div>
                  </div> -->
                </div>
              </div>
            </div>
          </div>

          <!-- No contacts fallback -->
          <div class="w-100" *ngIf="org.contacts.length === 0">
            <div class="contact-card empty">
              <div class="contact-info">
                <h3 class="contact-name">No contacts available</h3>
                <p class="contact-title">
                  You can add a new contact using the button above.
                </p>
              </div>
            </div>
          </div>
        </div>
      </details>
    </div>

    <!-- Pagination (unchanged logic) -->
    <div class="pagination" *ngIf="totalItems > pageSize">
      <div class="pagination-controls">
        <button
          class="pagination-btn"
          [disabled]="currentPage === 1"
          (click)="onPageChange(currentPage - 1)"
        >
          Previous
        </button>

        <button
          class="pagination-btn"
          [class.active]="currentPage === 1"
          (click)="onPageChange(1)"
          *ngIf="pages[0] > 1"
        >
          1
        </button>
        <span class="pagination-ellipsis" *ngIf="pages[0] > 2">...</span>

        <button
          *ngFor="let page of pages"
          class="pagination-btn"
          [class.active]="currentPage === page"
          (click)="onPageChange(page)"
        >
          {{ page }}
        </button>

        <span
          class="pagination-ellipsis"
          *ngIf="pages[pages.length - 1] < totalPages - 1"
          >...</span
        >

        <button
          class="pagination-btn"
          [class.active]="currentPage === totalPages"
          (click)="onPageChange(totalPages)"
          *ngIf="pages[pages.length - 1] < totalPages"
        >
          {{ totalPages }}
        </button>

        <button
          class="pagination-btn"
          [disabled]="currentPage === totalPages"
          (click)="onPageChange(currentPage + 1)"
        >
          Next
        </button>
      </div>

      <div class="pagination-info-container">
        <span class="pagination-info">
          Showing {{ (currentPage - 1) * pageSize + 1 }} -
          {{ Math.min(currentPage * pageSize, totalItems) }} of
          {{ totalItems }} contacts
        </span>

        <div class="page-size-selector">
          <label for="pageSize">Show:</label>
          <select
            id="pageSize"
            [(ngModel)]="pageSize"
            (change)="onPageSizeChange()"
          >
            <option [value]="10">10</option>
            <option [value]="25">25</option>
            <option [value]="50">50</option>
            <option [value]="100">100</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Contact Modal (unchanged logic) -->
  <div
    class="modal-overlay"
    *ngIf="showAddForm"
    (click)="onBackdropClick($event)"
  >
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Add New Contact</h2>
        <button class="close-btn" (click)="closeAddForm()">
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <form class="contact-form" (ngSubmit)="saveContact()">
        <div class="form-group">
          <label for="firstname">First Name *</label>
          <input
            type="text"
            id="firstname"
            [(ngModel)]="newContact.firstname"
            name="firstname"
            required
            maxlength="10"
            placeholder="Enter first name"
          />
        </div>

        <div class="form-group">
          <label for="lastname">Last Name</label>
          <input
            type="text"
            id="lastname"
            [(ngModel)]="newContact.lastname"
            name="lastname"
            maxlength="5"
            placeholder="Enter last name"
          />
        </div>

        <div class="form-group">
          <label for="email">Email *</label>
          <input
            type="email"
            id="email"
            [(ngModel)]="newContact.email"
            name="email"
            required
            placeholder="Enter email address"
          />
        </div>

        <div class="form-group">
          <label for="password">Password *</label>
          <input
            type="password"
            id="password"
            [(ngModel)]="newContact.password"
            name="password"
            required
            placeholder="Enter password"
          />
        </div>

        <div class="form-group">
          <label for="organizationId">Organization *</label>
          <select
            id="organizationId"
            [(ngModel)]="newContact.organizationId"
            name="organizationId"
            required
            class="form-control"
          >
            <option value="">Select Organization</option>
            <option *ngFor="let org of organizations" [value]="org.id">
              {{ org.name }}
            </option>
          </select>
        </div>

        <div class="form-actions">
          <button type="button" class="cancel-btn" (click)="closeAddForm()">
            Cancel
          </button>
          <button
            type="submit"
            class="save-btn"
            [disabled]="
              !newContact.firstname ||
              !newContact.email ||
              !newContact.password ||
              !newContact.organizationId
            "
          >
            Save Contact
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
