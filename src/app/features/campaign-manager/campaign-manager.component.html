<div *ngIf="filteredCampaigns" class="campaign-manager-container">
  <div class="w-100 d-flex align-items-center justify-content-between">
    <div class="search-campaign-container">
      <input
        type="text"
        class="form-control search-campaign-input"
        placeholder="Search Campaigns..."
        name="searchCampaign"
        [(ngModel)]="searchCampaign"
        (input)="onSearchCampaign()"
      />
      <svg
        class="search-campaign-icon"
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
      >
        <path
          d="M11.5 21.75C5.85 21.75 1.25 17.15 1.25 11.5C1.25 5.85 5.85 1.25 11.5 1.25C17.15 1.25 21.75 5.85 21.75 11.5C21.75 17.15 17.15 21.75 11.5 21.75ZM11.5 2.75C6.67 2.75 2.75 6.68 2.75 11.5C2.75 16.32 6.67 20.25 11.5 20.25C16.33 20.25 20.25 16.32 20.25 11.5C20.25 6.68 16.33 2.75 11.5 2.75Z"
          fill="#707791"
        />
        <path
          d="M21.9999 22.7499C21.8099 22.7499 21.6199 22.6799 21.4699 22.5299L19.4699 20.5299C19.1799 20.2399 19.1799 19.7599 19.4699 19.4699C19.7599 19.1799 20.2399 19.1799 20.5299 19.4699L22.5299 21.4699C22.8199 21.7599 22.8199 22.2399 22.5299 22.5299C22.3799 22.6799 22.1899 22.7499 21.9999 22.7499Z"
          fill="#707791"
        />
      </svg>
    </div>
    <div class="d-flex align-items-center gap-3">
      <div class="view-toggle">
        <button
          class="toggle-btn"
          [class.active]="viewMode === 'table'"
          (click)="toggleView('table')"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="3" y1="9" x2="21" y2="9"></line>
            <line x1="3" y1="15" x2="21" y2="15"></line>
            <line x1="9" y1="3" x2="9" y2="21"></line>
            <line x1="15" y1="3" x2="15" y2="21"></line>
          </svg>
        </button>
        <button
          class="toggle-btn"
          [class.active]="viewMode === 'card'"
          (click)="toggleView('card')"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <rect x="3" y="3" width="7" height="7"></rect>
            <rect x="14" y="3" width="7" height="7"></rect>
            <rect x="14" y="14" width="7" height="7"></rect>
            <rect x="3" y="14" width="7" height="7"></rect>
          </svg>
        </button>
      </div>
      <button class="add-new-campaign" (click)="openAddCampaignPopup(content)">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 20 20"
          fill="none"
        >
          <path
            d="M10.0001 18.3333C14.5834 18.3333 18.3334 14.5833 18.3334 9.99996C18.3334 5.41663 14.5834 1.66663 10.0001 1.66663C5.41675 1.66663 1.66675 5.41663 1.66675 9.99996C1.66675 14.5833 5.41675 18.3333 10.0001 18.3333Z"
            stroke="white"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M6.66675 10H13.3334"
            stroke="white"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M10 13.3333V6.66663"
            stroke="white"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
        <span>Add New Campaign</span>
      </button>
    </div>
  </div>

  <div
    *ngIf="filteredCampaigns.length > 0 && stages.length > 0"
    class="campaign-manager-body"
  >
    <div class="campaign-cards-container" *ngIf="viewMode === 'card'">
      <ng-container *ngFor="let c of filteredCampaigns">
        <ng-container *ngFor="let campaign of c.Campaigns; let index = index">
          <div class="campaign-card">
            <div class="campaign-card-header">
              <h3 class="campaign-name">{{ campaign.CampaignName }}</h3>
              <div
                class="campaign-privacy"
                [ngClass]="{
                  'campaign-privacy-public': campaign.CampaignPrivacy == 0,
                  'campaign-privacy-private': campaign.CampaignPrivacy == 1
                }"
              >
                <div class="campaign-privacy-icon"></div>
                <span>
                  {{ campaign.CampaignPrivacy == 0 ? "Public" : "Private" }}
                </span>
              </div>
            </div>

            <div class="tenant-section">
              <div class="d-flex align-items-center gap-2">
                <img
                  *ngIf="c.organizationid"
                  [src]="
                    'https://api.cherrypick.com/api/Organization/GetOrgImag?orgId=' +
                    c.organizationid
                  "
                  [alt]="c.name"
                  class="tenant-logo"
                />
                <span
                  class="tenant-name"
                  [routerLink]="['/dashboard', c.id, c.organizationid, c.name]"
                  >{{ c.name }}</span
                >
              </div>
              <div class="date-created">
                {{ (campaign.CreatedDate | date : "MMM d, y") ?? "N/A" }}
              </div>
            </div>

            <div class="campaign-stats">
              <div class="stat-item">
                <div class="stat-label">Sites</div>
                <div class="stat-value">
                  <div
                    class="d-flex align-items-center justify-content-center gap-2"
                  >
                    <div>{{ campaign.Sites }}</div>
                    <svg
                      [routerLink]="[
                        '/dashboard',
                        c.id,
                        c.organizationid,
                        c.name
                      ]"
                      style="cursor: pointer"
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                    >
                      <path
                        d="M12.9999 11.75C12.8099 11.75 12.6199 11.68 12.4699 11.53C12.1799 11.24 12.1799 10.76 12.4699 10.47L20.6699 2.26999C20.9599 1.97999 21.4399 1.97999 21.7299 2.26999C22.0199 2.55999 22.0199 3.03999 21.7299 3.32999L13.5299 11.53C13.3799 11.68 13.1899 11.75 12.9999 11.75Z"
                        fill="#292D32"
                      />
                      <path
                        d="M22 7.55C21.59 7.55 21.25 7.21 21.25 6.8V2.75H17.2C16.79 2.75 16.45 2.41 16.45 2C16.45 1.59 16.79 1.25 17.2 1.25H22C22.41 1.25 22.75 1.59 22.75 2V6.8C22.75 7.21 22.41 7.55 22 7.55Z"
                        fill="#292D32"
                      />
                      <path
                        d="M15 22.75H9C3.57 22.75 1.25 20.43 1.25 15V9C1.25 3.57 3.57 1.25 9 1.25H11C11.41 1.25 11.75 1.59 11.75 2C11.75 2.41 11.41 2.75 11 2.75H9C4.39 2.75 2.75 4.39 2.75 9V15C2.75 19.61 4.39 21.25 9 21.25H15C19.61 21.25 21.25 19.61 21.25 15V13C21.25 12.59 21.59 12.25 22 12.25C22.41 12.25 22.75 12.59 22.75 13V15C22.75 20.43 20.43 22.75 15 22.75Z"
                        fill="#292D32"
                      />
                    </svg>
                  </div>
                </div>
              </div>
              <div class="stat-item">
                <div class="stat-label">Submissions</div>
                <div class="stat-value">
                  <div
                    *ngIf="campaign.Submissions"
                    style="cursor: pointer"
                    [routerLink]="['/submissions', campaign.Id]"
                  >
                    <ng-container
                      *ngFor="
                        let submission of sortedSubmissions(
                          campaign.Submissions
                        );
                        let i = index
                      "
                    >
                      <span
                        [pTooltip]="
                          submission.StatusId == 0
                            ? 'New'
                            : submission.StatusId == 1
                            ? 'Accepted'
                            : 'Rejected'
                        "
                        tooltipPosition="top"
                        [ngClass]="getStatusClass(submission?.StatusId)"
                        >{{ submission?.Submissions }}</span
                      >
                      <span *ngIf="i < 2"> - </span>
                    </ng-container>
                  </div>
                  <div *ngIf="!campaign.Submissions">N/A</div>
                </div>
              </div>
              <div class="stat-item">
                <div class="stat-label">Mails Sent</div>
                <div class="stat-value" *ngIf="campaign.MailsSent">
                  {{ campaign.MailsSent[0].MailsSent }}
                </div>
              </div>
            </div>

            <div class="campaign-actions">
              <a
                class="inbox"
                [routerLink]="['/organization-mail', c.id, c.organizationid]"
                >Inbox</a
              >
              <button class="expand-btn" (click)="toggleExpand(campaign)">
                {{ campaign.expanded ? "Hide Stages" : "Show Stages" }}
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  [style.transform]="
                    campaign.expanded ? 'rotate(180deg)' : 'rotate(0)'
                  "
                >
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </button>
            </div>

            <div class="campaign-stages" [class.expanded]="campaign.expanded">
              <div class="stages-grid">
                <ng-container *ngFor="let stage of stages">
                  <div class="stage-item">
                    <div class="stage-name">{{ stage.stageName }}</div>
                    <div class="stage-value">
                      {{
                        getStageOrganizationCount(
                          stage.stageName,
                          campaign.Stages
                        ) ?? "N/A"
                      }}
                    </div>
                    <a
                      class="hyber-link"
                      *ngIf="
                        stage.stageName.toLowerCase() ==
                        'Precontact'.toLowerCase()
                      "
                      (click)="goToEmily(c, index, true)"
                      >Generate Emails</a
                    >
                  </div>
                </ng-container>
              </div>
            </div>
          </div>
        </ng-container>
      </ng-container>
    </div>

    <!-- Original Table View -->
    <div class="table-responsive" *ngIf="viewMode === 'table'">
      <table class="table align-middle">
        <thead>
          <tr>
            <th scope="col" style="white-space: nowrap">Campaign Name</th>
            <th scope="col" style="white-space: nowrap">Tenant</th>
            <th scope="col" style="white-space: nowrap">Date Created</th>
            <th scope="col" style="white-space: nowrap">Privacy</th>
            <th scope="col" style="white-space: nowrap">Sites</th>
            <th scope="col" style="white-space: nowrap">Submissions</th>
            <th scope="col" style="white-space: nowrap">Mails Sent</th>
            <th scope="col" style="white-space: nowrap">Actions</th>
            <ng-container *ngFor="let stage of stages">
              <th scope="col" style="white-space: nowrap; text-align: center">
                {{ stage.stageName }}
              </th>
            </ng-container>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let c of filteredCampaigns">
            <ng-container
              *ngFor="let campaign of c.Campaigns; let index = index"
            >
              <tr>
                <td style="white-space: nowrap">
                  {{ campaign.CampaignName }}
                </td>
                <td style="white-space: nowrap; text-align: center">
                  <div class="d-flex align-items-center gap-2">
                    <img
                      *ngIf="c.organizationid"
                      [src]="
                        'https://api.cherrypick.com/api/Organization/GetOrgImag?orgId=' +
                        c.organizationid
                      "
                      [alt]="c.name"
                      class="tenant-logo"
                    />
                    <span
                      class="tenant-name"
                      [routerLink]="[
                        '/dashboard',
                        c.id,
                        c.organizationid,
                        c.name
                      ]"
                      >{{ c.name }}</span
                    >
                  </div>
                </td>
                <td style="white-space: nowrap; text-align: center">
                  {{ (campaign.CreatedDate | date : "MMM d, y") ?? "N/A" }}
                </td>
                <td style="white-space: nowrap; text-align: center">
                  <div
                    class="campaign-privacy"
                    [ngClass]="{
                      'campaign-privacy-public': campaign.CampaignPrivacy == 0,
                      'campaign-privacy-private': campaign.CampaignPrivacy == 1
                    }"
                  >
                    <div class="campaign-privacy-icon"></div>
                    <span>
                      {{
                        campaign.CampaignPrivacy == 0 ? "Public" : "Private"
                      }}</span
                    >
                  </div>
                </td>

                <td style="white-space: nowrap; text-align: center">
                  <div
                    class="d-flex align-items-center justify-content-center gap-3"
                  >
                    <div>{{ campaign.Sites }}</div>
                    <svg
                      [routerLink]="[
                        '/dashboard',
                        c.id,
                        c.organizationid,
                        c.name
                      ]"
                      style="cursor: pointer"
                      xmlns="http://www.w3.org/2000/svg"
                      width="18"
                      height="18"
                      viewBox="0 0 24 24"
                      fill="none"
                    >
                      <path
                        d="M12.9999 11.75C12.8099 11.75 12.6199 11.68 12.4699 11.53C12.1799 11.24 12.1799 10.76 12.4699 10.47L20.6699 2.26999C20.9599 1.97999 21.4399 1.97999 21.7299 2.26999C22.0199 2.55999 22.0199 3.03999 21.7299 3.32999L13.5299 11.53C13.3799 11.68 13.1899 11.75 12.9999 11.75Z"
                        fill="#292D32"
                      />
                      <path
                        d="M22 7.55C21.59 7.55 21.25 7.21 21.25 6.8V2.75H17.2C16.79 2.75 16.45 2.41 16.45 2C16.45 1.59 16.79 1.25 17.2 1.25H22C22.41 1.25 22.75 1.59 22.75 2V6.8C22.75 7.21 22.41 7.55 22 7.55Z"
                        fill="#292D32"
                      />
                      <path
                        d="M15 22.75H9C3.57 22.75 1.25 20.43 1.25 15V9C1.25 3.57 3.57 1.25 9 1.25H11C11.41 1.25 11.75 1.59 11.75 2C11.75 2.41 11.41 2.75 11 2.75H9C4.39 2.75 2.75 4.39 2.75 9V15C2.75 19.61 4.39 21.25 9 21.25H15C19.61 21.25 21.25 19.61 21.25 15V13C21.25 12.59 21.59 12.25 22 12.25C22.41 12.25 22.75 12.59 22.75 13V15C22.75 20.43 20.43 22.75 15 22.75Z"
                        fill="#292D32"
                      />
                    </svg>
                  </div>
                </td>
                <td style="white-space: nowrap; text-align: center">
                  <div
                    class="d-flex align-items-center justify-content-center gap-3"
                  >
                    <div
                      *ngIf="campaign.Submissions"
                      style="cursor: pointer"
                      [routerLink]="['/submissions', campaign.Id]"
                    >
                      <ng-container
                        *ngFor="
                          let submission of sortedSubmissions(
                            campaign.Submissions
                          );
                          let i = index
                        "
                      >
                        <span
                          [pTooltip]="
                            submission.StatusId == 0
                              ? 'New'
                              : submission.StatusId == 1
                              ? 'Accepted'
                              : 'Rejected'
                          "
                          tooltipPosition="top"
                          [ngClass]="getStatusClass(submission?.StatusId)"
                          >{{ submission?.Submissions }}</span
                        >
                        <span *ngIf="i < 2"> - </span>
                      </ng-container>
                    </div>
                    <div *ngIf="!campaign.Submissions">N/A</div>
                  </div>
                </td>
                <td style="white-space: nowrap; text-align: center" >
                <ng-container *ngIf="campaign.MailsSent"> {{ campaign.MailsSent[0].MailsSent }}</ng-container> 
                </td>

                <td style="white-space: nowrap; text-align: center">
                  <a
                    class="inbox"
                    [routerLink]="[
                      '/organization-mail',
                      c.id,
                      c.organizationid
                    ]"
                    >Inbox</a
                  >
                </td>

                <ng-container *ngFor="let stage of stages">
                  <td style="white-space: nowrap; text-align: center">
                    <div
                      class="d-flex flex-column align-items-center justify-content-center gap-2"
                    >
                      <div>
                        {{
                          getStageOrganizationCount(
                            stage.stageName,
                            campaign.Stages
                          ) ?? "N/A"
                        }}
                      </div>
                      <a
                        class="hyber-link"
                        *ngIf="
                          stage.stageName.toLowerCase() ==
                          'Precontact'.toLowerCase()
                        "
                        (click)="goToEmily(c, index, true)"
                        >Generate Emails</a
                      >
                    </div>
                  </td>
                </ng-container>
              </tr>
            </ng-container>
          </ng-container>
        </tbody>
      </table>
    </div>
  </div>

  <div *ngIf="!(filteredCampaigns.length > 0)" class="empty-campaigns">
    <img src="../../../assets/Images/empty-state.png" alt="Empty Campaigns" />
    <h4>Campaigns Will Appear Here!</h4>
    <p>Create, Track, and Manage Expansion Campaigns Here.</p>
  </div>
</div>

<ng-template #content let-modal>
  <div class="modal-body">
    <label for="user-buybox" class="form-label mb-2">Select Tenants</label>
    <select
      id="user-buybox"
      class="form-select mb-3"
      aria-label="Buybox select"
      name="userBuybox"
      [(ngModel)]="selectedBuyBoxId"
    >
      <ng-container *ngFor="let buyBox of userBuyBoxes">
        <option [value]="buyBox.id">
          {{ buyBox.name }}
        </option>
      </ng-container>
    </select>

    <div class="campaign-drawing-component">
      <app-campaign-drawing
        [buyBoxId]="selectedBuyBoxId"
        (onCampaignCreated)="onCampaignCreated()"
      ></app-campaign-drawing>
    </div>
  </div>
</ng-template>

<ngx-spinner type="ball-scale-multiple"> </ngx-spinner>
