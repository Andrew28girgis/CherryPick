<ngx-spinner type="ball-scale-multiple"></ngx-spinner>

<div class="row m-0 p-0 mb-5">
  @if (ShowSection) {
    <div class="d-flex ">
      <button (click)="OverView()" class="btn buttonSave "> <i class="fa-solid fa-house me-2"></i> Home</button>
    </div>
  }
  <div class="col-12 col-sm-3 mt-2">
    @for(stage of Stages; track stage){
      <div [ngClass]="{'hide-accordion': accordionClicked && getActiveIndex(stage.id) !== 0}">
        <p-accordion [activeIndex]="getActiveIndex(stage.id)">
          <p-accordionTab [header]="stage.title" [id]="stage.id">
            @for(email of stageEmailsMap[stage.id]; track email){
              @for(org of email.Organization; track org){
                <div
                  [ngClass]="{'hide-accordion': accordionSecondClicked && getActiveIndex2(org.OrganizationId) !== 0}">
                  <p-accordion [activeIndex]="getActiveIndex2(org.OrganizationId)">
                    <p-accordionTab [id]="org.OrganizationId">
                      <ng-template pTemplate="header">
                        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                          <div style="width: 30px; height: 30px; margin-inline: 5px;">
                            <img
                              src="https://api.cherrypick.com/api/Organization/GetOrgImag?orgId={{ org.OrganizationId }}"
                              width="30" height="30" style="border-radius: 50%;">
                          </div>
                          <div>
                            {{ org.OrganizationName }}
                          </div>
                          <div>
                            <span class="mx-2 " [routerLink]="['/emily', buyBoxId, org.OrganizationId , email.id]"><i
                                style="font-size: 16px;color:#001f3f" class="fa-solid fa-pen-to-square"></i></span>
                          </div>
                        </div>
                      </ng-template>
                      <ul class="contact-ul" *ngIf="org.Contact && org.Contact.length > 0">
                        @for(contact of org.Contact; track contact){
                          <li (click)="getEmailsForContact(contact)" class="d-flex justify-content-between">
                            <span class="namecontact">{{ contact.Firstname }} {{ contact.Lastname }} </span>
                            <div>
                              <span class="Inbox" *ngIf="getTotalEmails(contact) > 0">{{ getTotalEmails(contact)
                        }}</span>
                            </div>
                          </li>
                          }
                      </ul>
                      <p *ngIf="!org.Contact || org.Contact.length === 0" class="no-contact-msg">
                        No contacts available in this organization.
                      </p>
                    </p-accordionTab>
                  </p-accordion>
                </div>
                }
                }
          </p-accordionTab>
        </p-accordion>
      </div>
      }
  </div>
  <div class="col-12 col-sm-9 mt-2">
    @if(!ShowSection){
      <div *ngFor="let items of EmailDashboard; let i = index" [ngClass]="{'mt-3': i !== 0}">
        <div class="card p-0" *ngIf="items.Organizations">
          <p-table [columns]="cols" [value]="items.Organizations">
            <ng-template pTemplate="caption">
              <div class="flex items-center justify-between">
                <span class="text-xl font-bold">{{ items.Title }}</span>
              </div>
            </ng-template>

            <ng-template pTemplate="header">
              <tr>
                <th *ngFor="let col of cols" class="col-header">
                  {{ col.header }}
                </th>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-rowData>
              <tr>
                <td class="col-body">
                  <div class="d-flex justify-content-between row m-0  align-items-center">
                    <div class="col-2 image_style">
                      <img src="https://api.cherrypick.com/api/Organization/GetOrgImag?orgId={{ rowData.ID }}" width="30"
                        height="30" style="border-radius: 50%;">
                    </div>
                    <span (click)="Openaccordion(items.Id,rowData.ID)" class="col-7 title">{{ rowData.Name }}</span>
  
                    <span class="buttonSave2 col-3" [routerLink]="['/emily', buyBoxId,rowData.ID , rowData.MicroDealId]"><i
                        class="fa-solid fa-pen-to-square"></i> Compose</span>
                  </div>
                </td>
                <td class="col-body">
                  {{ (rowData.LastActivityDate | date : "medium") }}
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>
      }@else {
      <div class="row m-0 p-0">
        <div class="d-flex justify-content-between align-items-center selectedContactdiv col-12">
          <p *ngIf="selectedContact" class="selectedContact">
            {{ selectedContact.Firstname }} {{ selectedContact.Lastname }}
          </p>
          <div *ngIf="selectedContact" class="filterEmails">
            <span (click)="checkAndFilterEmails('sent')" [ngClass]="{'active': selectedFilter === 'sent'}">{{
            selectedContact.EmailStats[0].Sent }}
              Sent</span>
            <span (click)="checkAndFilterEmails('inbox')" [ngClass]="{'active': selectedFilter === 'inbox'}">{{
            selectedContact.EmailStats[0].Inbox }}
              Inbox</span>
            <span (click)="checkAndFilterEmails('outbox')" [ngClass]="{'active': selectedFilter === 'outbox'}">{{
            selectedContact.EmailStats[0].Outbox }}
              Outbox</span>
          </div>
        </div>
        <div class="col-12 col-sm-12 p-2 card-pTemplate" *ngFor="let email of filteredEmails">
          <p-card (click)="GetMail(email.id)">
            <!-- <ng-template pTemplate="header">
              <div class="custom-header">
                <span class="Direction-class">
                  <i  [ngClass]="'fa-solid '+getDirection(email.Direction)"></i>
                </span>

              </div>
            </ng-template> -->

            <p class="m-0 d-flex justify-content-between">
              <strong><i  [ngClass]="'fa-solid '+getDirection(email.Direction)" class="me-2"></i> {{ email.Subject }}</strong> 

              <span
              class="date-text">{{ email.Date | date: 'EEE' }} - {{ email.Date | date: 'yyyy-MM-dd HH:mm' }}
            </span>
            </p>
          </p-card>
          <div class="mail_show mt-2" *ngIf="selectedEmail && selectedEmail.id === email.id">
            <div class="modal-content">
              <div class="modal-body p-0 openreply">
                <div class="row m-0 p-0 d-flex justify-content-center">
                  <div class="col-12 p-0">
                    <div class="card shadow-sm border-0">
                      <div class="card-body bg-light">
                        <div>
                          <div class="d-flex justify-content-between align-items-center">
                            <label class="fw-bold text-secondary">Body</label>
                          </div>
                          <div class="p-3 border rounded bg-white text-dark">
                            <div class="col-5 p-0 m-0" [innerHTML]="selectedEmail.Body"></div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="modal-footer mt-2">
                <button class="btn buttonSave me-2"
                  (click)="openmodel(openreply, selectedEmail.Body, selectedContact?.ContactId)"
                  *ngIf="selectedEmail.Direction === 1">
                  Reply
                </button>
                <button class="btn btn-secondary" (click)="close()">
                  Close
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div *ngIf="filteredEmails.length === 0" class="d-flex justify-content-start Empty-data">
        {{ emptyMessage }}
      </div>
      }
  </div>
</div>

<ng-template #Viewemail let-modal>
  <div class="modal-content">
    <div class="modal-body p-0">
      <div class="row m-0 p-0 d-flex justify-content-center">
        <div class="col-12 p-0">
          <div class="card shadow-sm border-0">
            <div class="card-header text-white GeneratedEmail">
              <h5 class="mb-0 d-flex justify-content-between">
                <p>
                  <span class="firstemail">
                    {{ getDirection(Emails[0].Direction) }}
                  </span>
                </p>
                <p>
                  <span class="creationdate">
                    {{ Emails[0].Date | date: 'yyyy-MM-dd HH:mm' }}</span>
                </p>
              </h5>
            </div>
            <div class="card-body bg-light">
              <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center">
                  <label class="fw-bold text-secondary">Subject</label>
                </div>
                <div class="p-3 border rounded bg-white text-dark">
                  <div class="col-5 p-0 m-0">{{ Emails[0].Subject }}</div>
                </div>
              </div>
              <div>
                <div class="d-flex justify-content-between align-items-center">
                  <label class="fw-bold text-secondary">Body</label>
                </div>
                <div class="p-3 border rounded bg-white text-dark">
                  <div class="col-5 p-0 m-0" [innerHTML]="Emails[0].Body"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="modal.dismiss('Close click')">
        Close
      </button>
    </div>
  </div>
</ng-template>

<ng-template #openreply let-modal>
  <div class="modal-content">
    <div class="modal-body p-0">
      <div class="row m-0 p-2 d-flex justify-content-center">
        <div class="d-flex gap-3 selectedOptionDiv">
          <app-emily [buyBoxIdReply]="buyBoxId" [orgIdReply]="openedOrgId" [emailBodyReply]="bodyemail"
            [selectedContactContactId]="contactIdemail" [modal]="modal"> </app-emily>
        </div>
        <div class="col-12 p-0">
          <!-- <form [formGroup]="formGroup">
              <div class="p-3">
                <div class="d-flex pb-3 align-items-center">
                  <label for="subject"class="IsCC_checkbox me-2">Subject: </label>
                  <input type="text" class="input_checkbox form-control w-25" formControlName="subject" name="subject" id="subject" placeholder="Enter your subject email">
                </div>
                <div class="checkbox-section">
                  <input type="checkbox"  formControlName="IsCC" name="IsCC" id="IsCC" class="form-check-input m-0"/>
                  <label for="IsCC" class="ms-2 IsCC_checkbox" >IsCC</label>
                </div>
              </div>
              {{ email }}
              <p-editor [(ngModel)]="email" [style]="{ height: '250px' }"></p-editor>
              <div class="d-flex justify-content-end">
                <button type="button" (click)="Send()" class="mt-2 mb-4 me-2 buttonSave">Send</button>
                <button class="btn btn-secondary mt-2 mb-4 me-2" (click)="modal.dismiss('Close click')">
                  Close
                </button>
              </div>
            </form> -->

        </div>
      </div>
    </div>
  </div>
</ng-template>
